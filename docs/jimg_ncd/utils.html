<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 16.0.0"/>
    <title>jimg_ncd.utils API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>
    /* --- Custom Style --- */
    pre {
    line-height: 130%;
    background: #1e1e1e; /* ciemne tło jak w VS Code */
    color: #e0e0e0;
    padding: 1em;
    border-radius: 10px;
    overflow-x: auto;
    }

    span.linenos {
    color: #888;
    background-color: transparent;
    padding-left: 5px;
    padding-right: 20px;
    }

    .pdoc-code .hll {
    background-color: rgba(255, 153, 51, 0.2);
    }

    .pdoc-code {
    background: #1e1e1e;
    color: #e0e0e0;
    }

    /* --- Comments (szaro-zielone) --- */
    .pdoc-code .c,
    .pdoc-code .cm,
    .pdoc-code .ch,
    .pdoc-code .cpf,
    .pdoc-code .c1,
    .pdoc-code .cs {
    color: #6a9955;
    font-style: italic;
    }

    /* --- Keywords (zielone / limonkowe) --- */
    .pdoc-code .k,
    .pdoc-code .kd,
    .pdoc-code .kn,
    .pdoc-code .kr,
    .pdoc-code .kc,
    .pdoc-code .nt {
    color: #4ec9b0;
    font-weight: bold;
    }

    /* --- Strings (czerwono-pomarańczowe) --- */
    .pdoc-code .s,
    .pdoc-code .s1,
    .pdoc-code .s2,
    .pdoc-code .sa,
    .pdoc-code .sb,
    .pdoc-code .sd,
    .pdoc-code .sh,
    .pdoc-code .sr {
    color: #f78c6c;
    }

    /* --- Numbers (szare) --- */
    .pdoc-code .m,
    .pdoc-code .mi,
    .pdoc-code .mf,
    .pdoc-code .mh,
    .pdoc-code .il {
    color: #c0c0c0;
    }

    /* --- Functions (fioletowe) --- */
    .pdoc-code .nf,
    .pdoc-code .fm {
    color: #c586c0;
    font-weight: bold;
    }

    /* --- Classes / Types (niebiesko-fioletowe) --- */
    .pdoc-code .nc,
    .pdoc-code .nn,
    .pdoc-code .kt {
    color: #9cdcfe;
    font-weight: bold;
    }

    /* --- Constants / Variables (zielono-niebieskie) --- */
    .pdoc-code .nv,
    .pdoc-code .vc,
    .pdoc-code .vg,
    .pdoc-code .vi {
    color: #4ec9b0;
    }

    /* --- Operators (jasnoszare) --- */
    .pdoc-code .o,
    .pdoc-code .ow {
    color: #d4d4d4;
    }

    /* --- Decorators / Special (pomarańczowo-fioletowe) --- */
    .pdoc-code .nd,
    .pdoc-code .ne,
    .pdoc-code .gu,
    .pdoc-code .gt {
    color: #d16969;
    font-weight: bold;
    }

    /* --- Errors / Diff --- */
    .pdoc-code .err {
    border: 1px solid #ff5555;
    background: rgba(255, 85, 85, 0.1);
    }

    /* --- Misc --- */
    .pdoc-code .w { color: #777; }
    .pdoc-code .go { color: #999; }
    .pdoc-code .gp { color: #ffcc00; font-weight: bold; }
    </style>
    <style>/* custom style *//*! theme.css */:root{--pdoc-background:#585656;}.pdoc{
        --text:#ffffff;
        --muted:#ffffff;
        --link:#c51616;
        --link-hover:#c51616;
        --code:#302d2d;
        --active:#302d2d;
        --accent:#302d2d;
        --accent2:#c1c1c1;
        --nav-hover:rgba(255, 255, 255, 0.5);
        --name:#cf7b0c;
        --def:#ff0000;
        --annotation:#9f00be;}
    </style>
    
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:27px;vertical-align:bottom;width:50px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../jimg_ncd.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;jimg_ncd</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#umap_html">umap_html</a>
            </li>
            <li>
                    <a class="function" href="#umap_static">umap_static</a>
            </li>
            <li>
                    <a class="function" href="#test_data">test_data</a>
            </li>
            <li>
                    <a class="function" href="#prop_plot">prop_plot</a>
            </li>
            <li>
                    <a class="function" href="#get_significance_label">get_significance_label</a>
            </li>
            <li>
                    <a class="function" href="#chi_pairs">chi_pairs</a>
            </li>
            <li>
                    <a class="function" href="#statistic">statistic</a>
            </li>
            <li>
                    <a class="function" href="#save_image">save_image</a>
            </li>
            <li>
                    <a class="function" href="#load_tiff">load_tiff</a>
            </li>
            <li>
                    <a class="function" href="#z_projection">z_projection</a>
            </li>
            <li>
                    <a class="function" href="#clahe_16bit">clahe_16bit</a>
            </li>
            <li>
                    <a class="function" href="#equalizeHist_16bit">equalizeHist_16bit</a>
            </li>
            <li>
                    <a class="function" href="#load_image">load_image</a>
            </li>
            <li>
                    <a class="function" href="#rotate_image">rotate_image</a>
            </li>
            <li>
                    <a class="function" href="#mirror_image">mirror_image</a>
            </li>
            <li>
                    <a class="function" href="#merge_images">merge_images</a>
            </li>
            <li>
                    <a class="function" href="#adjust_img_16bit">adjust_img_16bit</a>
            </li>
            <li>
                    <a class="function" href="#get_screan">get_screan</a>
            </li>
            <li>
                    <a class="function" href="#resize_to_screen_img">resize_to_screen_img</a>
            </li>
            <li>
                    <a class="function" href="#display_preview">display_preview</a>
            </li>
            <li>
                    <a class="class" href="#ImageTools">ImageTools</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ImageTools.get_screan">get_screan</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.resize_to_screen_img">resize_to_screen_img</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.load_JIMG_project">load_JIMG_project</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.ajd_mask_size">ajd_mask_size</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.load_image">load_image</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.load_3D_tiff">load_3D_tiff</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.load_mask">load_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.save">save</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.drop_dict">drop_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.create_mask">create_mask</a>
                        </li>
                        <li>
                                <a class="function" href="#ImageTools.min_max_histograme">min_max_histograme</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22160%22%20viewBox%3D%220%200%20150%2080%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M132.316%2048.886c.276-4.679%202.342-6.698%204.409-7.982s4.27-1.165%206.751-1.055c1.586.07%203.044.156%204.222-.482%201.142-.619%202.026-1.932%202.162-3.739.268-3.576-1.929-5.368-5.006-5.551s-7.599.524-10.517%201.606c-4.455%201.652-8.588%206.606-9.552%208.992s-2.342%206.193-1.745%2010.873%202.664%209.221%205.878%2011.79%205.878%203.808%2010.103%204.312%203.444.229%206.062.229%205.006-2.202%204.914-4.909-2.296-5.001-4.501-4.863-3.077.505-5.281.229-7.715-2.064-7.899-9.451z%22%20fill%3D%22%23198754%22/%3E%3Ccircle%20cx%3D%22101.504%22%20cy%3D%2248.943%22%20r%3D%2214.208%22%20fill%3D%22none%22%20stroke%3D%22%23198754%22%20stroke-width%3D%229.354%22/%3E%3Cpath%20d%3D%22M87.81.002c-3.637.065-5.001.454-7.014%201.232s-3.443%201.363-6.3%204.282c-1.723%201.76-3.148%205.019-3.776%207.329-.413%201.521-.316%202.63-.316%202.63l-.195%2034.612c.065%205.774-6.755%208.305-9.612%208.37s-9.678-1.038-9.743-9.408%207.128-9.521%208.362-9.521c1.413-.13%202.526-.021%203.718-.016%202.071.009%204.157-.778%204.092-4.671s-4.157-4.736-4.157-4.736c-6.3-.843-11.43%202.206-11.43%202.206S40.917%2038.15%2041.372%2049.634%2051.568%2068.19%2061.311%2068.125s18.316-7.007%2018.445-17.193l.13-22.772c.046-2.291%202.683-3.644%204.476-4.203.745-.232%201.694-.274%201.694-.274l10.457-.13s4.871-.324%207.729-3.114%204.352-6.294%204.352-6.294.974-3.049.13-4.606-.195-1.233-2.792-3.309-8.573-4.477-8.573-4.477S91.447-.063%2087.81.002zM0%2047.169l.065%2028.417S0%2080.127%204.481%2079.997s5.072-3.866%205.049-4.152l-.113-28.482s1.624-7.656%209.937-7.721%2010.002%206.942%2010.002%208.499-.909%2010.51-9.093%2010.51c-.948%200-2.99-.567-4.145-.272-3.919%201-3.194%204.554-3.194%204.554s.065%205.061%207.404%204.996%2018.575-6.034%2018.575-19.074S26.953%2030.04%2019.549%2029.91%201.234%2035.296%200%2047.169z%22%20fill%3D%22%23198754%22/%3E%3Cg%20transform%3D%22matrix%28.325601%200%200%20.325256%20-10.32669%20-45.802786%29%22%3E%3Ccircle%20cx%3D%22297.554%22%20cy%3D%22172.286%22%20r%3D%2216.5%22%20fill%3D%22%23fff%22/%3E%3Cellipse%20cx%3D%22297.709%22%20cy%3D%22172.642%22%20rx%3D%2211.071%22%20ry%3D%2210.871%22%20fill%3D%22%23105a48%22/%3E%3Ccircle%20cx%3D%22304.104%22%20cy%3D%22167.667%22%20r%3D%224.5%22%20fill%3D%22%23fff%22/%3E%3C/g%3E%3Cpath%20d%3D%22M94.661%2017.032l.893-1.476s.99.714%201.916.925%201.575.114%202.955.114l14.565-.162c1.283-.032%203.085-.762%203.02-3.293s-.373-3.503-.373-3.503l1.283-.487s.52.503.877%201.573.309%201.995.292%202.66-.227%201.541-.227%201.541%201.564-.308%202.359-1.038.823-.779%201.489-1.508.812-.86.812-.86.552-.13.877.26.341.957.065%201.46-1.672%202.206-3.247%203.066-2.76%201.427-3.929%201.768-3.848.73-7.063.714l-10.944-.114s-2.143-.081-3.02-.373-2.241-.973-2.598-1.265z%22%20fill%3D%22%23d36d49%22/%3E%3Cg%20fill%3D%22%23105a48%22%3E%3Cellipse%20cx%3D%2293.052%22%20cy%3D%2243.567%22%20rx%3D%22.869%22%20ry%3D%221.014%22%20transform%3D%22rotate%28341.022%29%22/%3E%3Cellipse%20cx%3D%22104.3%22%20cy%3D%22-16.184%22%20rx%3D%22.865%22%20ry%3D%221.009%22%20transform%3D%22rotate%2814.786%29%22/%3E%3C/g%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../jimg_ncd.html">jimg_ncd</a><wbr>.utils    </h1>

                
                        <input id="mod-utils-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-utils-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">tkinter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tk</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">gdown</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">tifffile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tiff</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">joblib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">ConvexHull</span><span class="p">,</span> <span class="n">cKDTree</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">chi2_contingency</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="k">def</span><span class="w"> </span><span class="nf">umap_html</span><span class="p">(</span><span class="n">umap_result</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1200</span><span class="p">):</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">    Create an interactive HTML UMAP scatter plot.</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">    Parameters</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="sd">    ----------</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="sd">    umap_result : pandas.DataFrame or dict-like</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="sd">        UMAP embedding containing at least:</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="sd">        - `0` : array-like, UMAP dimension 1</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="sd">        - `1` : array-like, UMAP dimension 2</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        - `&#39;clusters&#39;` : array-like, assigned cluster labels</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    width : int, optional</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">        Width of the output figure in pixels. Default is 1000.</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    height : int, optional</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">        Height of the output figure in pixels. Default is 1200.</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">    Returns</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">    -------</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    plotly.graph_objs._figure.Figure</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        Interactive Plotly scatter plot object visualizing UMAP with colored clusters.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>        <span class="n">x</span><span class="o">=</span><span class="n">umap_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>        <span class="n">y</span><span class="o">=</span><span class="n">umap_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>        <span class="n">color</span><span class="o">=</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">],</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>        <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;Cells&quot;</span><span class="p">},</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;simple_white&quot;</span><span class="p">,</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>        <span class="n">render_mode</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="n">color_discrete_sequence</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>        <span class="o">+</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Light24</span><span class="p">,</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="p">)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>    <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="k">def</span><span class="w"> </span><span class="nf">umap_static</span><span class="p">(</span><span class="n">umap_result</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">n_per_col</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">    Create a static matplotlib UMAP scatter plot.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">    Parameters</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">    ----------</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">    umap_result : pandas.DataFrame or dict-like</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">        UMAP projection containing:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        - `0` : array-like, UMAP dimension 1</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">        - `1` : array-like, UMAP dimension 2</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">        - `&#39;clusters&#39;` : array-like, cluster assignments</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">    width : float, optional</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        Width of the figure in inches. Default is 10.</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">    height : float, optional</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">        Height of the figure in inches. Default is 13.</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">    n_per_col : int, optional</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">        Maximum number of legend entries per column. Default is 20.</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">    Returns</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">    -------</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">    matplotlib.figure.Figure</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        Static matplotlib figure representing the UMAP embedding with clusters.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>    <span class="n">plotly_colors</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span> <span class="o">+</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Light24</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="n">num_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotly_colors</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="n">sorted_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">])</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>        <span class="n">label</span><span class="p">:</span> <span class="n">plotly_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">num_colors</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_labels</span><span class="p">)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="p">}</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sorted_labels</span><span class="p">:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="n">subset</span> <span class="o">=</span> <span class="n">umap_result</span><span class="p">[</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>            <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>            <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>            <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">label</span><span class="p">]],</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>            <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="p">)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="n">n_col</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]))</span> <span class="o">//</span> <span class="n">n_per_col</span><span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">n_col</span><span class="p">)</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>    <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_data</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">    Download and extract test data from Google Drive.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">    This function downloads a compressed archive containing example test data</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">    and extracts it into the specified directory. The data is fetched using</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">    a direct Google Drive link. If the download or extraction fails, an</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">    error message is printed.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">    Parameters</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">    ----------</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">    path : str, optional</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">        Destination directory where the test dataset will be downloaded and</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">        extracted. Defaults to the current working directory.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">    Notes</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">    -----</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">    - The downloaded file is named ``test_data.tar.gz``.</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">    - The archive is extracted into ``&lt;path&gt;/test_data``.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">    - In case of any failure (download or extraction), the function prints</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">      an informative message instead of raising an exception.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;test_data.tar.gz&quot;</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://drive.google.com/uc?id=1MhzhleMP7iTzlBVW8eP5sFaonJdg1a3T&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>        <span class="c1"># Unzip</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test data downloaded succesfully -&gt; </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test_data&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>        <span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test data could not be downloaded. Please check your connection and try again!&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>        <span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="k">def</span><span class="w"> </span><span class="nf">prop_plot</span><span class="p">(</span><span class="n">df_pivot</span><span class="p">,</span> <span class="n">chi_df</span><span class="p">):</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">    Create a stacked bar plot of proportional data with post-hoc significance annotations.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">    Parameters</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">    ----------</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">    df_pivot : pandas.DataFrame</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">        Pivot table where rows represent categories (e.g., compartments) and columns</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">        represent groups. Values are counts or frequencies.</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">    chi_df : pandas.DataFrame</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        DataFrame containing pairwise Chi-square test results with an added</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        &#39;Significance_Label&#39; column (e.g., &#39;***&#39;, &#39;**&#39;, &#39;*&#39;, &#39;ns&#39;) for each pair</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        of groups. Typically output from `chi_pairs` and `get_significance_label`.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">    Returns</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">    -------</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">    matplotlib.figure.Figure</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">        The Matplotlib figure object containing the stacked bar plot.</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">    Notes</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">    -----</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">    - The function converts raw counts to percentages per group for visualization.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">    - Each pairwise comparison and its significance label is displayed as a text box</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">      next to the plot.</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">    - Colors are assigned using the &#39;viridis&#39; colormap by default.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">    - The plot is configured for clarity with labeled axes, legend, and appropriately</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">      sized text.</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>    <span class="n">df_pivot_perc</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>    <span class="n">chi_df</span> <span class="o">=</span> <span class="n">chi_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>    <span class="n">df_pivot_perc</span> <span class="o">=</span> <span class="n">df_pivot_perc</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">df_pivot_perc</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>    <span class="n">posthoc_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="p">[</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Group 1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Group 2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Significance_Label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">chi_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="p">]</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>    <span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>    <span class="n">df_pivot_perc</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Percentage (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Compartment&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="p">)</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>        <span class="mf">0.93</span><span class="p">,</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>        <span class="mf">0.6</span><span class="p">,</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>        <span class="n">posthoc_text</span><span class="p">,</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>        <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>        <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;facecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>    <span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>    <span class="k">return</span> <span class="n">fig</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_significance_label</span><span class="p">(</span><span class="n">p_value</span><span class="p">):</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a><span class="sd">    Return a standard significance label based on a p-value.</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="sd">    Parameters</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="sd">    ----------</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">    p_value : float</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="sd">        The p-value for which the significance label should be determined.</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="sd">    Returns</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">    -------</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">    str</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">        A significance marker commonly used in statistical reporting:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">        - &#39;***&#39; : p &lt; 0.001</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">        - &#39;**&#39;  : p &lt; 0.01</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">        - &#39;*&#39;   : p &lt; 0.05</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">        - &#39;ns&#39;  : not significant (p ≥ 0.05)</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">    Notes</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">    -----</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">    This helper function is typically used for annotating statistical test</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">    results in tables or visualizations. Thresholds follow conventional</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">    statistical notation for significance levels.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="k">return</span> <span class="s2">&quot;***&quot;</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>    <span class="k">elif</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="k">return</span> <span class="s2">&quot;**&quot;</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>    <span class="k">elif</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="k">return</span> <span class="s2">&quot;*&quot;</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="k">return</span> <span class="s2">&quot;ns&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="k">def</span><span class="w"> </span><span class="nf">chi_pairs</span><span class="p">(</span><span class="n">df_pivot</span><span class="p">):</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">    Compute pairwise Chi-square tests for all combinations of groups in a pivoted dataframe.</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">    Parameters</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a><span class="sd">    ----------</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="sd">    df_pivot : pandas.DataFrame</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">        A pivot table where rows represent categories and columns represent groups.</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">        Values should be counts (frequencies). The function will add +1 to each cell</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">        to avoid zero counts during chi-square computation.</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a><span class="sd">    Returns</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="sd">    -------</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a><span class="sd">    pandas.DataFrame</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a><span class="sd">        A DataFrame containing pairwise Chi-square test results with the following columns:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="sd">        - &#39;Group 1&#39; : str</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="sd">            Name of the first group in the pair.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">        - &#39;Group 2&#39; : str</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">            Name of the second group in the pair.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">        - &#39;Chi²&#39; : float</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">            The Chi-square statistic for the comparison.</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">        - &#39;p-value&#39; : float</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="sd">            The p-value of the Chi-square test.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="sd">    Notes</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">    -----</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">    The function compares every possible pair of columns using `scipy.stats.chi2_contingency`.</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">    Yates&#39; correction is applied by default unless disabled in the SciPy version used.</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">    A value of 1 is added to all cells to avoid issues with zero frequencies.</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>    <span class="n">group_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>    <span class="n">posthoc_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>    <span class="k">for</span> <span class="n">group1</span><span class="p">,</span> <span class="n">group2</span> <span class="ow">in</span> <span class="n">group_pairs</span><span class="p">:</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="n">sub_table</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>        <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">sub_table</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="n">posthoc_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="p">{</span><span class="s2">&quot;Group 1&quot;</span><span class="p">:</span> <span class="n">group1</span><span class="p">,</span> <span class="s2">&quot;Group 2&quot;</span><span class="p">:</span> <span class="n">group2</span><span class="p">,</span> <span class="s2">&quot;Chi²&quot;</span><span class="p">:</span> <span class="n">chi2</span><span class="p">,</span> <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">}</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>        <span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>    <span class="n">posthoc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posthoc_results</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>    <span class="k">return</span> <span class="n">posthoc_df</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="k">def</span><span class="w"> </span><span class="nf">statistic</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">    Compute statistical comparison between cell groups or clusters.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">    This function performs differential feature analysis between either:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">    (1) every group vs. all other groups (default mode), or</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">    (2) two user-defined groups specified in ``sets``.</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">    The analysis includes:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">    - Mann–Whitney U test</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">    - Percentage of non-zero values</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">    - Means and standard deviations</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">    - Effect size metric (ESM)</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="sd">    - Benjamini–Hochberg FDR correction</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">    - Fold-change and log2 fold-change</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a><span class="sd">    Parameters</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a><span class="sd">    ----------</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="sd">    input_df : pandas.DataFrame</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">        Input feature matrix where rows represent features and columns represent cells.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">        The function transposes this table internally, treating columns as features.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a><span class="sd">    sets : dict or None, optional</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a><span class="sd">        Mode selection:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="sd">        - ``None`` (default): each unique label in ``metadata[&#39;sets&#39;]`` is compared</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">          against all remaining groups.</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a><span class="sd">        - ``dict``: must contain exactly two keys, each mapping to a list of labels</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">          belonging to each comparison group. Example:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">          ``{&#39;A&#39;: [&#39;T1&#39;, &#39;T2&#39;], &#39;B&#39;: [&#39;C1&#39;, &#39;C2&#39;]}``.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">    metadata : pandas.DataFrame, optional</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a><span class="sd">        Metadata containing at least a column ``&#39;sets&#39;`` with group labels</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a><span class="sd">        corresponding to columns of ``input_df``.</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a><span class="sd">    n_proc : int, optional</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a><span class="sd">        Number of parallel processes used for statistical computation.</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a><span class="sd">        Default is ``10``.</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a><span class="sd">    Returns</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a><span class="sd">    -------</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a><span class="sd">    pandas.DataFrame or None</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a><span class="sd">        A DataFrame containing statistical results for each feature, including:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">        - ``feature`` : str</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">        - ``p_val`` : float</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a><span class="sd">        - ``adj_pval`` : float</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a><span class="sd">        - ``pct_valid`` : float</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a><span class="sd">        - ``pct_ctrl`` : float</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a><span class="sd">        - ``avg_valid`` : float</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="sd">        - ``avg_ctrl`` : float</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        - ``sd_valid`` : float</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="sd">        - ``sd_ctrl`` : float</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">        - ``esm`` : float</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">        - ``FC`` : float</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">        - ``log(FC)`` : float</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">        - ``norm_diff`` : float</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">        - ``valid_group`` : str</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">        - ``-log(p_val)`` : float</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        If ``sets`` is ``None``, results for each group are concatenated.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">        Returns ``None`` in case of errors or invalid parameters.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">    Notes</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">    -----</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">    - Columns containing only zeros are automatically removed.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">    - p-values equal for both groups produce ``p_val = 1``.</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">    - Benjamini–Hochberg correction is applied separately within each group comparison.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">    - Fold-change is stabilized using a small, data-derived ``low_factor``.</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">    - Uses ``Mann–Whitney U`` test with ``alternative=&#39;two-sided&#39;``.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">    Raises</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">    ------</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">    None</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">        All exceptions are caught internally and printed as messages.</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">    Examples</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">    --------</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">    &gt;&gt;&gt; df = pd.DataFrame(...)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">    &gt;&gt;&gt; meta = pd.DataFrame({&#39;sets&#39;: [...]})</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">    &gt;&gt;&gt; stat = statistic(df, metadata=meta)</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">    &gt;&gt;&gt; stat.head()</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">    &gt;&gt;&gt; # Compare two groups explicitly</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">    &gt;&gt;&gt; sets = {&#39;A&#39;: [&#39;Type1&#39;], &#39;B&#39;: [&#39;Type2&#39;]}</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">    &gt;&gt;&gt; stat = statistic(df, sets=sets, metadata=meta, n_proc=4)</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="mf">1e-100</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">stat_calc</span><span class="p">(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>            <span class="n">target_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="n">rest_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="n">pct_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>            <span class="n">pct_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">rest_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="n">avg_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>            <span class="n">avg_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="n">sd_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">target_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">sd_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rest_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>            <span class="n">esm</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_valid</span> <span class="o">-</span> <span class="n">avg_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">sd_valid</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sd_ctrl</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rest_values</span><span class="p">):</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>                <span class="n">p_val</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>                    <span class="n">target_values</span><span class="p">,</span> <span class="n">rest_values</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two-sided&quot;</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>                <span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_name</span><span class="p">,</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>                <span class="s2">&quot;p_val&quot;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>                <span class="s2">&quot;pct_valid&quot;</span><span class="p">:</span> <span class="n">pct_valid</span><span class="p">,</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>                <span class="s2">&quot;pct_ctrl&quot;</span><span class="p">:</span> <span class="n">pct_rest</span><span class="p">,</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>                <span class="s2">&quot;avg_valid&quot;</span><span class="p">:</span> <span class="n">avg_valid</span><span class="p">,</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>                <span class="s2">&quot;avg_ctrl&quot;</span><span class="p">:</span> <span class="n">avg_ctrl</span><span class="p">,</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>                <span class="s2">&quot;sd_valid&quot;</span><span class="p">:</span> <span class="n">sd_valid</span><span class="p">,</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>                <span class="s2">&quot;sd_ctrl&quot;</span><span class="p">:</span> <span class="n">sd_ctrl</span><span class="p">,</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>                <span class="s2">&quot;esm&quot;</span><span class="p">:</span> <span class="n">esm</span><span class="p">,</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>            <span class="p">}</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">safe_min_half</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>            <span class="n">filtered</span> <span class="o">=</span> <span class="n">series</span><span class="p">[(</span><span class="n">series</span> <span class="o">&gt;</span> <span class="p">((</span><span class="mi">2</span><span class="o">**-</span><span class="mi">1074</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">notna</span><span class="p">())]</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>            <span class="k">return</span> <span class="n">filtered</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="c1"># Transpose the input DataFrame</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="n">choose</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="k">if</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...&quot;</span><span class="p">)</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparing each type of cell to others...&quot;</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>            <span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>            <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">indexes</span><span class="p">):</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating statistics for </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">indexes</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]))</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>                    <span class="p">:,</span> <span class="p">(</span><span class="n">choose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>                <span class="p">]</span>  <span class="c1"># Remove all-zero columns</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>                <span class="c1"># Parallel computation</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)(</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>                    <span class="n">delayed</span><span class="p">(</span><span class="n">stat_calc</span><span class="p">)(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>                    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;DEG&quot;</span><span class="p">])</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>                <span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>                <span class="c1"># Convert results to DataFrame</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>                    <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>                <span class="p">]</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>                <span class="n">combined_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p_val&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>                <span class="c1"># Adjusted p-values using Benjamini-Hochberg method</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>                <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                <span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">1074</span><span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;-log(p_val)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">])</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>                <span class="n">valid_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">])</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>                <span class="n">ctrl_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">])</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>                <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>                <span class="k">if</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>                    <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cv_factor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>                    <span class="n">cv_factor</span> <span class="o">+=</span> <span class="n">offset</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>                <span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>                <span class="n">ctrl</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>                <span class="p">)</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">/</span> <span class="n">ctrl</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">])</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;norm_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="p">)</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis has finished!&quot;</span><span class="p">)</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...&quot;</span><span class="p">)</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="n">inx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">sets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">])</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inx</span><span class="p">]</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_list</span><span class="p">):</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating statistics for </span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                <span class="n">rest_indices</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                    <span class="n">idx</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">n</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                <span class="p">]</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sets</span><span class="p">[</span><span class="n">g</span><span class="p">]),</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                    <span class="s2">&quot;target&quot;</span><span class="p">,</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rest_indices</span><span class="p">),</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;drop&quot;</span><span class="p">),</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                <span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="n">g</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                    <span class="p">:,</span> <span class="p">(</span><span class="n">choose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                <span class="p">]</span>  <span class="c1"># Remove all-zero columns</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>                <span class="c1"># Parallel computation</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)(</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                    <span class="n">delayed</span><span class="p">(</span><span class="n">stat_calc</span><span class="p">)(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;DEG&quot;</span><span class="p">])</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                <span class="p">)</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                <span class="c1"># Convert results to DataFrame</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                <span class="n">combined_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p_val&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>                <span class="c1"># Adjusted p-values using Benjamini-Hochberg method</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                <span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;-log(p_val)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">])</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                <span class="n">valid_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">])</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                <span class="n">ctrl_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">])</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>                <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>                <span class="k">if</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>                    <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cv_factor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>                    <span class="n">cv_factor</span> <span class="o">+=</span> <span class="n">offset</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>                <span class="p">)</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>                <span class="n">ctrl</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                <span class="p">)</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">/</span> <span class="n">ctrl</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">])</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;norm_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                <span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_df</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">])</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis has finished!&quot;</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>            <span class="k">return</span> <span class="n">full_df</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Invalid parameters. Please check the input.&quot;</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a><span class="c1"># UTILS JIMG</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a><span class="k">def</span><span class="w"> </span><span class="nf">save_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">path_to_save</span><span class="p">):</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="sd">    Save an image to disk.</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">    Parameters</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">    ----------</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">    image : np.ndarray</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a><span class="sd">        Input image array to be saved.</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">    path_to_save : str</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        Output file path including the filename.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">        Must include one of the following extensions:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        ``.png``, ``.tiff`` or ``.tif``.</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">    Returns</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">    -------</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">    str</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">        Path to the saved file.</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>            <span class="ow">or</span> <span class="s2">&quot;.png&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_to_save</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>            <span class="ow">or</span> <span class="s2">&quot;.tiff&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_to_save</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>            <span class="ow">or</span> <span class="s2">&quot;.tif&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_to_save</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="p">):</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The path is not provided or the file extension is not *.png, *.tiff or *.tif&quot;</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="k">def</span><span class="w"> </span><span class="nf">load_tiff</span><span class="p">(</span><span class="n">path_to_tiff</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">    Load a *.tiff image and ensure it is in 16-bit format.</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">    Parameters</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">    ----------</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">    path_to_tiff : str</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">        Path to the *.tiff file.</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">    Returns</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">    -------</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">        Loaded image stack, converted to 16-bit if necessary.</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="n">stack</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path_to_tiff</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                <span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">uint16</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                <span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>                <span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>        <span class="k">return</span> <span class="n">stack</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="k">def</span><span class="w"> </span><span class="nf">z_projection</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">projection_type</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">):</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">    Perform Z-projection on a stacked (3D) image.</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">    Parameters</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">    ----------</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">    tiff_object : np.ndarray</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">        Input stacked 3D image (e.g., loaded with `load_tiff()`).</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">    projection_type : str</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">        Type of Z-axis projection. Options: &#39;avg&#39;, &#39;median&#39;, &#39;min&#39;, &#39;max&#39;, &#39;std&#39;.</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">    Returns</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">    -------</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">        Resulting 2D projection image.</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>        <span class="k">if</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="k">def</span><span class="w"> </span><span class="nf">clahe_16bit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">kernal</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)):</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">    Apply CLAHE (Contrast Limited Adaptive Histogram Equalization) to an image.</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">    Parameters</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">    ----------</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        Input image.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">    Returns</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">    -------</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">        Image after CLAHE enhancement.</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="sd">    kernel : tuple</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="sd">        Size of the CLAHE tile grid used for processing, e.g., (100, 100).</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img8bit</span><span class="p">)</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img8bit</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">img8bit</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>        <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="n">kernal</span><span class="p">)</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">img8bit</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="n">img8bit</span> <span class="o">/</span> <span class="mi">255</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">*</span> <span class="n">img8bit</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="k">def</span><span class="w"> </span><span class="nf">equalizeHist_16bit</span><span class="p">(</span><span class="n">image_eq</span><span class="p">):</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="sd">    Apply global histogram equalization to an image.</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">    Parameters</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">    ----------</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a><span class="sd">    image_eq : np.ndarray</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">        Input image.</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">    Returns</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">    -------</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">        Image after global histogram equalization.</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image_eq</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>        <span class="n">scaled_image</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>        <span class="n">eq_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">scaled_image</span><span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="n">eq_image_bin</span> <span class="o">=</span> <span class="n">eq_image</span> <span class="o">/</span> <span class="mi">255</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="n">image_eq_16</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">eq_image_bin</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="n">image_eq_16</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_eq_16</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_eq_16</span><span class="p">))</span> <span class="o">*</span> <span class="mi">65535</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="n">image_eq_16</span><span class="p">[</span><span class="n">image_eq_16</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">65535</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_eq_16</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">image_eq_16</span> <span class="o">=</span> <span class="n">image_eq_16</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>        <span class="k">return</span> <span class="n">image_eq_16</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">    Load an image and convert it to 16-bit if necessary.</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="sd">    Parameters</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">    ----------</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">    path : str</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="sd">        Path to the image file.</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">    Returns</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">    -------</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">        Loaded 16-bit image.</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_ANYDEPTH</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>        <span class="c1"># convert to 16 bit (the function are working on 16 bit images!)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>            <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rotate_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rotate</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">    Rotate an image by a specified angle.</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">    Parameters</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">    ----------</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">        Image to rotate.</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">    rotate : int</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">        Degree of rotation. Available options: 90, 180, 270.</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">    Returns</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">    -------</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">        Rotated image.</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="k">if</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">90</span><span class="p">:</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">180</span><span class="p">:</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">180</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">270</span><span class="p">:</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrong argument - rotate!&quot;</span><span class="p">)</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="k">def</span><span class="w"> </span><span class="nf">mirror_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rotate</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">    Mirror an image along specified axes.</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">    Parameters</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">    ----------</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">        Image to mirror.</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">    rotate : str</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">        Type of mirroring to apply. Options:</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">            &#39;h&#39;  - horizontal mirroring</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">            &#39;v&#39;  - vertical mirroring</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">            &#39;hv&#39; - both horizontal and vertical mirroring</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">    Returns</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">    -------</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">        Mirrored image.</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="k">if</span> <span class="n">rotate</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="s2">&quot;hv&quot;</span><span class="p">:</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()))</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrong argument - rotate!&quot;</span><span class="p">)</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a><span class="c1"># validatet UTILS</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_images</span><span class="p">(</span><span class="n">image_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">intensity_factors</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]):</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="sd">    Merge multiple image projections from different channels.</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">    Parameters</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">    ----------</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a><span class="sd">    image_list : list of np.ndarray</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">        List of images to merge. All images must have the same shape and size.</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">    intensity_factors : list of float</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">        Intensity scaling factors for each image in `image_list`. Base value is 1.</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">            - Values &lt; 1 decrease intensity.</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">            - Values &gt; 1 increase intensity.</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">    Returns</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">    -------</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="sd">        Merged image after applying intensity scaling.</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity_factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>            <span class="n">intensity_factors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>            <span class="k">for</span> <span class="n">bt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">)):</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>                <span class="n">intensity_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_list</span><span class="p">):</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span> <span class="o">*</span> <span class="n">intensity_factors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>                    <span class="n">result</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span> <span class="o">*</span> <span class="n">intensity_factors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="p">)</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="k">def</span><span class="w"> </span><span class="nf">adjust_img_16bit</span><span class="p">(</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>    <span class="n">img</span><span class="p">,</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>    <span class="n">max_intensity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>    <span class="n">min_intenisty</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>    <span class="n">brightness</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>    <span class="n">contrast</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>    <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a><span class="p">):</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">    Manually adjust image parameters and return the adjusted image.</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">    Parameters</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">    ----------</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">        Input image.</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">    color : str</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">        Image color channel. Options: [&#39;green&#39;, &#39;blue&#39;, &#39;red&#39;, &#39;yellow&#39;, &#39;magenta&#39;, &#39;cyan&#39;].</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">    max_intensity : int</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">        Upper threshold for pixel values. Pixels exceeding this value are set to `max_intensity`.</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">    min_intensity : int</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">        Lower threshold for pixel values. Pixels below this value are set to 0.</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">    brightness : int, optional</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">        Image brightness adjustment. Typical range: [900-2000]. Default is 1000.</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">    contrast : float or int, optional</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">        Image contrast adjustment. Typical range: [0-5]. Default is 1.</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">    gamma : float or int, optional</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">        Gamma correction factor. Typical range: [0-5]. Default is 1.</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">    Returns</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">    -------</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">        Adjusted image after applying brightness, contrast, gamma, and intensity thresholds.</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="c1"># brightness</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>        <span class="k">if</span> <span class="n">brightness</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">:</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>            <span class="n">factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">brightness</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>            <span class="n">side</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">side</span><span class="p">)</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>        <span class="c1"># contrast</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>        <span class="k">if</span> <span class="n">contrast</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">))</span> <span class="o">*</span> <span class="n">contrast</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>        <span class="c1"># gamma</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="n">gamma</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>            <span class="n">image_array</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">/</span> <span class="n">max_val</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>            <span class="n">image_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>            <span class="n">corrected_array</span> <span class="o">=</span> <span class="n">image_array</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">corrected_array</span> <span class="o">*</span> <span class="n">max_val</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>            <span class="k">del</span> <span class="n">image_array</span><span class="p">,</span> <span class="n">corrected_array</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mi">65535</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="k">if</span> <span class="n">max_val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">/</span> <span class="n">max_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="c1"># max intenisty</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="k">if</span> <span class="n">max_intensity</span> <span class="o">!=</span> <span class="mi">65535</span><span class="p">:</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>            <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;=</span> <span class="n">max_intensity</span><span class="p">]</span> <span class="o">=</span> <span class="mi">65535</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="c1"># min intenisty</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>        <span class="k">if</span> <span class="n">min_intenisty</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>            <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="n">min_intenisty</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="n">img_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;red&quot;</span><span class="p">:</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;blue&quot;</span><span class="p">:</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;magenta&quot;</span><span class="p">:</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;yellow&quot;</span><span class="p">:</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;cyan&quot;</span><span class="p">:</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;gray&quot;</span><span class="p">:</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="k">return</span> <span class="n">img_gamma</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_screan</span><span class="p">():</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a><span class="sd">    Get the current screen width and height.</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a><span class="sd">    Returns</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="sd">    -------</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="sd">    tuple of int</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">        screen_width, screen_height</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>    <span class="n">screen_width</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenwidth</span><span class="p">()</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>    <span class="n">screen_height</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenheight</span><span class="p">()</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>    <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>    <span class="k">return</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="k">def</span><span class="w"> </span><span class="nf">resize_to_screen_img</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">    Resize an input image to fit the screen size, optionally scaled by a factor.</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">    Parameters</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">    ----------</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">    img_file : np.ndarray</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">        Input image to be resized.</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">    factor : float, optional</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">        Scaling factor applied to the screen dimensions before resizing the image. Default is 1.</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">    Returns</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">    -------</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">    np.ndarray</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">        Resized image that fits within the screen dimensions while maintaining aspect ratio.</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>    <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span> <span class="o">=</span> <span class="n">get_screan</span><span class="p">()</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>    <span class="n">screen_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>    <span class="n">screen_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_height</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>    <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>    <span class="k">if</span> <span class="n">screen_width</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">:</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>        <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>        <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>    <span class="k">if</span> <span class="n">screen_height</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>        <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>        <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>        <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>    <span class="k">return</span> <span class="n">img_file</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="k">def</span><span class="w"> </span><span class="nf">display_preview</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="sd">    Quickly preview an image using a display window.</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">    Parameters</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">    ----------</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">    image : np.ndarray</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">        Input image to be displayed.</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a><span class="sd">    Notes</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">    -----</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="sd">        The function displays the image in a window. Does not return a value.</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>        <span class="n">res_sc</span> <span class="o">=</span> <span class="n">resize_to_screen_img</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Display&quot;</span><span class="p">,</span> <span class="n">res_sc</span><span class="p">)</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a><span class="c1">## flow_JIMG_functions</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ImageTools</span><span class="p">:</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a><span class="sd">    Collection of utility functions for image preprocessing, adjustment,</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="sd">    merging, and stitching.</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a><span class="sd">    This class provides standalone static methods for operations such as</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a><span class="sd">    histogram equalization, CLAHE enhancement, intensity adjustments,</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a><span class="sd">    image merging based on weighted ratios, and horizontal stitching.</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a><span class="sd">    These tools are used internally by `ImagesManagement` but can also be</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="sd">    applied independently for generic image-processing workflows.</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">    Notes</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">    -----</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a><span class="sd">    All methods operate on NumPy arrays and expect images in standard</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">    OpenCV format. Some functions assume 16-bit images unless stated</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a><span class="sd">    otherwise.</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="sd">    Examples</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="sd">    --------</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">    &gt;&gt;&gt; from ImageTools import ImageTools</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">    &gt;&gt;&gt; img = ImageTools.equalize_hist_16bit(img)</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a><span class="sd">    &gt;&gt;&gt; merged = ImageTools.merge_images([img1, img2], [0.5, 0.5])</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_screan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">        Return the current screen size.</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">        Returns</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">        -------</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a><span class="sd">        screen_width : int</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">            Width of the screen in pixels.</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a><span class="sd">        screen_height : int</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="sd">            Height of the screen in pixels.</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>        <span class="n">screen_width</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenwidth</span><span class="p">()</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>        <span class="n">screen_height</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenheight</span><span class="p">()</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>        <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>        <span class="k">return</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resize_to_screen_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_file</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="sd">        Resize an input image to a scaled version of the current screen size.</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">        Parameters</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">        ----------</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">        img_file : np.ndarray</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">            Input image to be resized.</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">        factor : int</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a><span class="sd">            Scaling factor applied to the screen dimensions.</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a><span class="sd">        Returns</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a><span class="sd">        -------</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="sd">        resized_image : np.ndarray</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="sd">            Resized image adjusted to the scaled screen size.</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>        <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_screan</span><span class="p">()</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>        <span class="n">screen_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>        <span class="n">screen_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_height</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>        <span class="k">if</span> <span class="n">screen_width</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>            <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>            <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>        <span class="k">if</span> <span class="n">screen_height</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="ow">or</span> <span class="n">screen_height</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">:</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>            <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="k">return</span> <span class="n">img_file</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_JIMG_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="p">):</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a><span class="sd">        Load a JIMG project from a `.pjm` file.</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">        Parameters</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">        ----------</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">        file_path : str</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">            Path to the project file with `.pjm` extension.</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="sd">        Returns</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="sd">        -------</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a><span class="sd">        project : object</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="sd">            Loaded project object.</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">        Raises</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">        ------</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">        ValueError</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">            If the provided file does not have a `.pjm` extension.</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>        <span class="k">if</span> <span class="s2">&quot;.pjm&quot;</span> <span class="ow">in</span> <span class="n">project_path</span><span class="p">:</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">project_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>                <span class="n">app_metadata_tmp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>            <span class="k">return</span> <span class="n">app_metadata_tmp</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Provide path to the project metadata file with *.pjm extension!!!&quot;</span><span class="p">)</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ajd_mask_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a><span class="sd">        Adjusts the size of a mask to match the dimensions of a given image.</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a><span class="sd">        Parameters</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="sd">        ----------</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a><span class="sd">            Reference image whose size the mask should match. Can be 2D or 3D.</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="sd">            Mask image to be resized.</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="sd">        Returns</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">        -------</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a><span class="sd">        np.ndarray</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a><span class="sd">            Resized mask matching the input image dimensions.</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_image</span><span class="p">):</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">        Load an image from the specified file path.</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="sd">        Parameters</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a><span class="sd">        ----------</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a><span class="sd">        path_to_image : str</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a><span class="sd">            Path to the image file.</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="sd">        Returns</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">        -------</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="sd">            Loaded image as a NumPy array.</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="n">path_to_image</span><span class="p">)</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>        <span class="k">return</span> <span class="n">image</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_3D_tiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_image</span><span class="p">):</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a><span class="sd">        Load a 3D image from a TIFF file.</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a><span class="sd">        Parameters</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="sd">        ----------</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">        path_to_image : str</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">            Path to the 3D TIFF image file.</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">        Returns</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">        -------</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">            Loaded 3D image as a NumPy array.</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">load_tiff</span><span class="p">(</span><span class="n">path_to_image</span><span class="p">)</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>        <span class="k">return</span> <span class="n">image</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_mask</span><span class="p">):</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a><span class="sd">        Load a mask image.</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">        Parameters</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">        ----------</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="sd">        path_to_mask : str</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="sd">            Path to the mask image file.</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">        Returns</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">        -------</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="sd">            Loaded mask image as a NumPy array.</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path_to_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="sd">        Save an image to disk.</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a><span class="sd">        Parameters</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a><span class="sd">        ----------</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a><span class="sd">            Image data to be saved.</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">        file_name : str</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a><span class="sd">            Output file path including the desired image extension (e.g., &quot;.png&quot;, &quot;.jpg&quot;).</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>    <span class="c1"># calculation methods</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">drop_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">        Filters elements from a dictionary based on a condition applied to a specified key.</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">        Parameters</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">        ----------</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">        dictionary : dict</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">            Dictionary containing lists or arrays under each key.</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">        key : str</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">            The key in the dictionary on which the filtering condition will be applied.</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">        var : numeric</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">            Value to compare against each element in dictionary[key].</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">        action : str, optional</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a><span class="sd">            Comparison operator as string: &#39;&lt;=&#39;, &#39;&gt;=&#39;, &#39;==&#39;, &#39;&lt;&#39;, &#39;&gt;&#39;.</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a><span class="sd">            Default is None, which raises an error.</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a><span class="sd">        Returns</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a><span class="sd">        -------</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a><span class="sd">        dict</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a><span class="sd">            A new dictionary with elements removed where the condition matches.</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>        <span class="n">indices_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>                <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;=</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;=</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Wrong action!&quot;</span><span class="p">)</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>                <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices_to_drop</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>            <span class="p">]</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>        <span class="k">return</span> <span class="n">dictionary</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>    <span class="c1"># modified for gradation (separation near nucleus)</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a><span class="sd">        Creates a mask image with gradated intensity values for each coordinate set in a dictionary.</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a><span class="sd">        Parameters</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a><span class="sd">        ----------</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a><span class="sd">        dictionary : dict</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a><span class="sd">            Dictionary containing a &#39;coords&#39; key with a list of arrays of coordinates.</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a><span class="sd">            Base image to define the shape of the mask.</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a><span class="sd">        Returns</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a><span class="sd">        -------</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a><span class="sd">        np.ndarray</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a><span class="sd">            Mask image with uint16 gradated intensity.</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>        <span class="n">image_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>        <span class="n">arrays_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>            <span class="n">initial_val</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>            <span class="n">intensity_list</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                <span class="n">arrays_list</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>            <span class="p">)</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>            <span class="n">gradation</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays_list</span><span class="p">:</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                <span class="n">image_mask</span><span class="p">[</span><span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">initial_val</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                    <span class="n">gradation</span> <span class="o">*</span> <span class="n">intensity_list</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                <span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                <span class="n">gradation</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="k">return</span> <span class="n">image_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">)</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">min_max_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a><span class="sd">        Calculates histogram-based minimum and maximum intensity percentiles in an image.</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a><span class="sd">        Parameters</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a><span class="sd">        ----------</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a><span class="sd">            Input image for histogram analysis.</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a><span class="sd">        Returns</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a><span class="sd">        -------</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a><span class="sd">        min_val : float</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a><span class="sd">            Minimum intensity percentile above zero.</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a><span class="sd">        max_val : float</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a><span class="sd">            Maximum intensity percentile based on histogram gradient.</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a><span class="sd">        df : pd.DataFrame</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a><span class="sd">            DataFrame containing quantiles, corresponding intensity values, and cumulative percents.</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>        <span class="n">perc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>            <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>            <span class="n">sum_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>            <span class="n">pr</span> <span class="o">=</span> <span class="n">sum_val</span> <span class="o">/</span> <span class="n">max_val</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            <span class="n">perc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span> <span class="n">perc</span><span class="p">})</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">min_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>                <span class="n">min_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>                <span class="k">break</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>        <span class="k">return</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">df</span>
</span></pre></div>


            </section>
                <section id="umap_html">
                            <input id="umap_html-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">umap_html</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">umap_result</span>, </span><span class="param"><span class="n">width</span><span class="o">=</span><span class="mi">1000</span>, </span><span class="param"><span class="n">height</span><span class="o">=</span><span class="mi">1200</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="umap_html-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#umap_html"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="umap_html-29"><a href="#umap_html-29"><span class="linenos">29</span></a><span class="k">def</span><span class="w"> </span><span class="nf">umap_html</span><span class="p">(</span><span class="n">umap_result</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1200</span><span class="p">):</span>
</span><span id="umap_html-30"><a href="#umap_html-30"><span class="linenos">30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="umap_html-31"><a href="#umap_html-31"><span class="linenos">31</span></a><span class="sd">    Create an interactive HTML UMAP scatter plot.</span>
</span><span id="umap_html-32"><a href="#umap_html-32"><span class="linenos">32</span></a>
</span><span id="umap_html-33"><a href="#umap_html-33"><span class="linenos">33</span></a><span class="sd">    Parameters</span>
</span><span id="umap_html-34"><a href="#umap_html-34"><span class="linenos">34</span></a><span class="sd">    ----------</span>
</span><span id="umap_html-35"><a href="#umap_html-35"><span class="linenos">35</span></a><span class="sd">    umap_result : pandas.DataFrame or dict-like</span>
</span><span id="umap_html-36"><a href="#umap_html-36"><span class="linenos">36</span></a><span class="sd">        UMAP embedding containing at least:</span>
</span><span id="umap_html-37"><a href="#umap_html-37"><span class="linenos">37</span></a><span class="sd">        - `0` : array-like, UMAP dimension 1</span>
</span><span id="umap_html-38"><a href="#umap_html-38"><span class="linenos">38</span></a><span class="sd">        - `1` : array-like, UMAP dimension 2</span>
</span><span id="umap_html-39"><a href="#umap_html-39"><span class="linenos">39</span></a><span class="sd">        - `&#39;clusters&#39;` : array-like, assigned cluster labels</span>
</span><span id="umap_html-40"><a href="#umap_html-40"><span class="linenos">40</span></a>
</span><span id="umap_html-41"><a href="#umap_html-41"><span class="linenos">41</span></a><span class="sd">    width : int, optional</span>
</span><span id="umap_html-42"><a href="#umap_html-42"><span class="linenos">42</span></a><span class="sd">        Width of the output figure in pixels. Default is 1000.</span>
</span><span id="umap_html-43"><a href="#umap_html-43"><span class="linenos">43</span></a>
</span><span id="umap_html-44"><a href="#umap_html-44"><span class="linenos">44</span></a><span class="sd">    height : int, optional</span>
</span><span id="umap_html-45"><a href="#umap_html-45"><span class="linenos">45</span></a><span class="sd">        Height of the output figure in pixels. Default is 1200.</span>
</span><span id="umap_html-46"><a href="#umap_html-46"><span class="linenos">46</span></a>
</span><span id="umap_html-47"><a href="#umap_html-47"><span class="linenos">47</span></a><span class="sd">    Returns</span>
</span><span id="umap_html-48"><a href="#umap_html-48"><span class="linenos">48</span></a><span class="sd">    -------</span>
</span><span id="umap_html-49"><a href="#umap_html-49"><span class="linenos">49</span></a><span class="sd">    plotly.graph_objs._figure.Figure</span>
</span><span id="umap_html-50"><a href="#umap_html-50"><span class="linenos">50</span></a><span class="sd">        Interactive Plotly scatter plot object visualizing UMAP with colored clusters.</span>
</span><span id="umap_html-51"><a href="#umap_html-51"><span class="linenos">51</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="umap_html-52"><a href="#umap_html-52"><span class="linenos">52</span></a>
</span><span id="umap_html-53"><a href="#umap_html-53"><span class="linenos">53</span></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="umap_html-54"><a href="#umap_html-54"><span class="linenos">54</span></a>        <span class="n">x</span><span class="o">=</span><span class="n">umap_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="umap_html-55"><a href="#umap_html-55"><span class="linenos">55</span></a>        <span class="n">y</span><span class="o">=</span><span class="n">umap_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="umap_html-56"><a href="#umap_html-56"><span class="linenos">56</span></a>        <span class="n">color</span><span class="o">=</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">],</span>
</span><span id="umap_html-57"><a href="#umap_html-57"><span class="linenos">57</span></a>        <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;Cells&quot;</span><span class="p">},</span>
</span><span id="umap_html-58"><a href="#umap_html-58"><span class="linenos">58</span></a>        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;simple_white&quot;</span><span class="p">,</span>
</span><span id="umap_html-59"><a href="#umap_html-59"><span class="linenos">59</span></a>        <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
</span><span id="umap_html-60"><a href="#umap_html-60"><span class="linenos">60</span></a>        <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
</span><span id="umap_html-61"><a href="#umap_html-61"><span class="linenos">61</span></a>        <span class="n">render_mode</span><span class="o">=</span><span class="s2">&quot;svg&quot;</span><span class="p">,</span>
</span><span id="umap_html-62"><a href="#umap_html-62"><span class="linenos">62</span></a>        <span class="n">color_discrete_sequence</span><span class="o">=</span><span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span>
</span><span id="umap_html-63"><a href="#umap_html-63"><span class="linenos">63</span></a>        <span class="o">+</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Light24</span><span class="p">,</span>
</span><span id="umap_html-64"><a href="#umap_html-64"><span class="linenos">64</span></a>    <span class="p">)</span>
</span><span id="umap_html-65"><a href="#umap_html-65"><span class="linenos">65</span></a>
</span><span id="umap_html-66"><a href="#umap_html-66"><span class="linenos">66</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">)</span>
</span><span id="umap_html-67"><a href="#umap_html-67"><span class="linenos">67</span></a>    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">)</span>
</span><span id="umap_html-68"><a href="#umap_html-68"><span class="linenos">68</span></a>
</span><span id="umap_html-69"><a href="#umap_html-69"><span class="linenos">69</span></a>    <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Create an interactive HTML UMAP scatter plot.</p>

<h2 id="parameters">Parameters</h2>

<p>umap_result : pandas.DataFrame or dict-like
    UMAP embedding containing at least:
    - <code>0</code> : array-like, UMAP dimension 1
    - <code>1</code> : array-like, UMAP dimension 2
    - <code>'clusters'</code> : array-like, assigned cluster labels</p>

<p>width : int, optional
    Width of the output figure in pixels. Default is 1000.</p>

<p>height : int, optional
    Height of the output figure in pixels. Default is 1200.</p>

<h2 id="returns">Returns</h2>

<p>plotly.graph_objs._figure.Figure
    Interactive Plotly scatter plot object visualizing UMAP with colored clusters.</p>
</div>


                </section>
                <section id="umap_static">
                            <input id="umap_static-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">umap_static</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">umap_result</span>, </span><span class="param"><span class="n">width</span><span class="o">=</span><span class="mi">10</span>, </span><span class="param"><span class="n">height</span><span class="o">=</span><span class="mi">13</span>, </span><span class="param"><span class="n">n_per_col</span><span class="o">=</span><span class="mi">20</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="umap_static-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#umap_static"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="umap_static-72"><a href="#umap_static-72"><span class="linenos"> 72</span></a><span class="k">def</span><span class="w"> </span><span class="nf">umap_static</span><span class="p">(</span><span class="n">umap_result</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">n_per_col</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
</span><span id="umap_static-73"><a href="#umap_static-73"><span class="linenos"> 73</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="umap_static-74"><a href="#umap_static-74"><span class="linenos"> 74</span></a><span class="sd">    Create a static matplotlib UMAP scatter plot.</span>
</span><span id="umap_static-75"><a href="#umap_static-75"><span class="linenos"> 75</span></a>
</span><span id="umap_static-76"><a href="#umap_static-76"><span class="linenos"> 76</span></a><span class="sd">    Parameters</span>
</span><span id="umap_static-77"><a href="#umap_static-77"><span class="linenos"> 77</span></a><span class="sd">    ----------</span>
</span><span id="umap_static-78"><a href="#umap_static-78"><span class="linenos"> 78</span></a><span class="sd">    umap_result : pandas.DataFrame or dict-like</span>
</span><span id="umap_static-79"><a href="#umap_static-79"><span class="linenos"> 79</span></a><span class="sd">        UMAP projection containing:</span>
</span><span id="umap_static-80"><a href="#umap_static-80"><span class="linenos"> 80</span></a><span class="sd">        - `0` : array-like, UMAP dimension 1</span>
</span><span id="umap_static-81"><a href="#umap_static-81"><span class="linenos"> 81</span></a><span class="sd">        - `1` : array-like, UMAP dimension 2</span>
</span><span id="umap_static-82"><a href="#umap_static-82"><span class="linenos"> 82</span></a><span class="sd">        - `&#39;clusters&#39;` : array-like, cluster assignments</span>
</span><span id="umap_static-83"><a href="#umap_static-83"><span class="linenos"> 83</span></a>
</span><span id="umap_static-84"><a href="#umap_static-84"><span class="linenos"> 84</span></a><span class="sd">    width : float, optional</span>
</span><span id="umap_static-85"><a href="#umap_static-85"><span class="linenos"> 85</span></a><span class="sd">        Width of the figure in inches. Default is 10.</span>
</span><span id="umap_static-86"><a href="#umap_static-86"><span class="linenos"> 86</span></a>
</span><span id="umap_static-87"><a href="#umap_static-87"><span class="linenos"> 87</span></a><span class="sd">    height : float, optional</span>
</span><span id="umap_static-88"><a href="#umap_static-88"><span class="linenos"> 88</span></a><span class="sd">        Height of the figure in inches. Default is 13.</span>
</span><span id="umap_static-89"><a href="#umap_static-89"><span class="linenos"> 89</span></a>
</span><span id="umap_static-90"><a href="#umap_static-90"><span class="linenos"> 90</span></a><span class="sd">    n_per_col : int, optional</span>
</span><span id="umap_static-91"><a href="#umap_static-91"><span class="linenos"> 91</span></a><span class="sd">        Maximum number of legend entries per column. Default is 20.</span>
</span><span id="umap_static-92"><a href="#umap_static-92"><span class="linenos"> 92</span></a>
</span><span id="umap_static-93"><a href="#umap_static-93"><span class="linenos"> 93</span></a><span class="sd">    Returns</span>
</span><span id="umap_static-94"><a href="#umap_static-94"><span class="linenos"> 94</span></a><span class="sd">    -------</span>
</span><span id="umap_static-95"><a href="#umap_static-95"><span class="linenos"> 95</span></a><span class="sd">    matplotlib.figure.Figure</span>
</span><span id="umap_static-96"><a href="#umap_static-96"><span class="linenos"> 96</span></a><span class="sd">        Static matplotlib figure representing the UMAP embedding with clusters.</span>
</span><span id="umap_static-97"><a href="#umap_static-97"><span class="linenos"> 97</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="umap_static-98"><a href="#umap_static-98"><span class="linenos"> 98</span></a>
</span><span id="umap_static-99"><a href="#umap_static-99"><span class="linenos"> 99</span></a>    <span class="n">plotly_colors</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span> <span class="o">+</span> <span class="n">px</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Light24</span>
</span><span id="umap_static-100"><a href="#umap_static-100"><span class="linenos">100</span></a>    <span class="n">num_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotly_colors</span><span class="p">)</span>
</span><span id="umap_static-101"><a href="#umap_static-101"><span class="linenos">101</span></a>
</span><span id="umap_static-102"><a href="#umap_static-102"><span class="linenos">102</span></a>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
</span><span id="umap_static-103"><a href="#umap_static-103"><span class="linenos">103</span></a>
</span><span id="umap_static-104"><a href="#umap_static-104"><span class="linenos">104</span></a>    <span class="n">sorted_labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">])</span>
</span><span id="umap_static-105"><a href="#umap_static-105"><span class="linenos">105</span></a>
</span><span id="umap_static-106"><a href="#umap_static-106"><span class="linenos">106</span></a>    <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="umap_static-107"><a href="#umap_static-107"><span class="linenos">107</span></a>        <span class="n">label</span><span class="p">:</span> <span class="n">plotly_colors</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">num_colors</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_labels</span><span class="p">)</span>
</span><span id="umap_static-108"><a href="#umap_static-108"><span class="linenos">108</span></a>    <span class="p">}</span>
</span><span id="umap_static-109"><a href="#umap_static-109"><span class="linenos">109</span></a>
</span><span id="umap_static-110"><a href="#umap_static-110"><span class="linenos">110</span></a>    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">sorted_labels</span><span class="p">:</span>
</span><span id="umap_static-111"><a href="#umap_static-111"><span class="linenos">111</span></a>        <span class="n">subset</span> <span class="o">=</span> <span class="n">umap_result</span><span class="p">[</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span>
</span><span id="umap_static-112"><a href="#umap_static-112"><span class="linenos">112</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
</span><span id="umap_static-113"><a href="#umap_static-113"><span class="linenos">113</span></a>            <span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="umap_static-114"><a href="#umap_static-114"><span class="linenos">114</span></a>            <span class="n">subset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="umap_static-115"><a href="#umap_static-115"><span class="linenos">115</span></a>            <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">color_map</span><span class="p">[</span><span class="n">label</span><span class="p">]],</span>
</span><span id="umap_static-116"><a href="#umap_static-116"><span class="linenos">116</span></a>            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="umap_static-117"><a href="#umap_static-117"><span class="linenos">117</span></a>            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
</span><span id="umap_static-118"><a href="#umap_static-118"><span class="linenos">118</span></a>            <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
</span><span id="umap_static-119"><a href="#umap_static-119"><span class="linenos">119</span></a>            <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
</span><span id="umap_static-120"><a href="#umap_static-120"><span class="linenos">120</span></a>            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
</span><span id="umap_static-121"><a href="#umap_static-121"><span class="linenos">121</span></a>        <span class="p">)</span>
</span><span id="umap_static-122"><a href="#umap_static-122"><span class="linenos">122</span></a>
</span><span id="umap_static-123"><a href="#umap_static-123"><span class="linenos">123</span></a>    <span class="n">n_col</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">umap_result</span><span class="p">[</span><span class="s2">&quot;clusters&quot;</span><span class="p">]))</span> <span class="o">//</span> <span class="n">n_per_col</span><span class="p">)</span>
</span><span id="umap_static-124"><a href="#umap_static-124"><span class="linenos">124</span></a>
</span><span id="umap_static-125"><a href="#umap_static-125"><span class="linenos">125</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;UMAP 1&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="umap_static-126"><a href="#umap_static-126"><span class="linenos">126</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;UMAP 2&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
</span><span id="umap_static-127"><a href="#umap_static-127"><span class="linenos">127</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="umap_static-128"><a href="#umap_static-128"><span class="linenos">128</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">n_col</span><span class="p">)</span>
</span><span id="umap_static-129"><a href="#umap_static-129"><span class="linenos">129</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span><span id="umap_static-130"><a href="#umap_static-130"><span class="linenos">130</span></a>
</span><span id="umap_static-131"><a href="#umap_static-131"><span class="linenos">131</span></a>    <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Create a static matplotlib UMAP scatter plot.</p>

<h2 id="parameters">Parameters</h2>

<p>umap_result : pandas.DataFrame or dict-like
    UMAP projection containing:
    - <code>0</code> : array-like, UMAP dimension 1
    - <code>1</code> : array-like, UMAP dimension 2
    - <code>'clusters'</code> : array-like, cluster assignments</p>

<p>width : float, optional
    Width of the figure in inches. Default is 10.</p>

<p>height : float, optional
    Height of the figure in inches. Default is 13.</p>

<p>n_per_col : int, optional
    Maximum number of legend entries per column. Default is 20.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    Static matplotlib figure representing the UMAP embedding with clusters.</p>
</div>


                </section>
                <section id="test_data">
                            <input id="test_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_data</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="test_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#test_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="test_data-134"><a href="#test_data-134"><span class="linenos">134</span></a><span class="k">def</span><span class="w"> </span><span class="nf">test_data</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
</span><span id="test_data-135"><a href="#test_data-135"><span class="linenos">135</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="test_data-136"><a href="#test_data-136"><span class="linenos">136</span></a><span class="sd">    Download and extract test data from Google Drive.</span>
</span><span id="test_data-137"><a href="#test_data-137"><span class="linenos">137</span></a>
</span><span id="test_data-138"><a href="#test_data-138"><span class="linenos">138</span></a><span class="sd">    This function downloads a compressed archive containing example test data</span>
</span><span id="test_data-139"><a href="#test_data-139"><span class="linenos">139</span></a><span class="sd">    and extracts it into the specified directory. The data is fetched using</span>
</span><span id="test_data-140"><a href="#test_data-140"><span class="linenos">140</span></a><span class="sd">    a direct Google Drive link. If the download or extraction fails, an</span>
</span><span id="test_data-141"><a href="#test_data-141"><span class="linenos">141</span></a><span class="sd">    error message is printed.</span>
</span><span id="test_data-142"><a href="#test_data-142"><span class="linenos">142</span></a>
</span><span id="test_data-143"><a href="#test_data-143"><span class="linenos">143</span></a><span class="sd">    Parameters</span>
</span><span id="test_data-144"><a href="#test_data-144"><span class="linenos">144</span></a><span class="sd">    ----------</span>
</span><span id="test_data-145"><a href="#test_data-145"><span class="linenos">145</span></a><span class="sd">    path : str, optional</span>
</span><span id="test_data-146"><a href="#test_data-146"><span class="linenos">146</span></a><span class="sd">        Destination directory where the test dataset will be downloaded and</span>
</span><span id="test_data-147"><a href="#test_data-147"><span class="linenos">147</span></a><span class="sd">        extracted. Defaults to the current working directory.</span>
</span><span id="test_data-148"><a href="#test_data-148"><span class="linenos">148</span></a>
</span><span id="test_data-149"><a href="#test_data-149"><span class="linenos">149</span></a>
</span><span id="test_data-150"><a href="#test_data-150"><span class="linenos">150</span></a><span class="sd">    Notes</span>
</span><span id="test_data-151"><a href="#test_data-151"><span class="linenos">151</span></a><span class="sd">    -----</span>
</span><span id="test_data-152"><a href="#test_data-152"><span class="linenos">152</span></a><span class="sd">    - The downloaded file is named ``test_data.tar.gz``.</span>
</span><span id="test_data-153"><a href="#test_data-153"><span class="linenos">153</span></a><span class="sd">    - The archive is extracted into ``&lt;path&gt;/test_data``.</span>
</span><span id="test_data-154"><a href="#test_data-154"><span class="linenos">154</span></a><span class="sd">    - In case of any failure (download or extraction), the function prints</span>
</span><span id="test_data-155"><a href="#test_data-155"><span class="linenos">155</span></a><span class="sd">      an informative message instead of raising an exception.</span>
</span><span id="test_data-156"><a href="#test_data-156"><span class="linenos">156</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="test_data-157"><a href="#test_data-157"><span class="linenos">157</span></a>
</span><span id="test_data-158"><a href="#test_data-158"><span class="linenos">158</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="test_data-159"><a href="#test_data-159"><span class="linenos">159</span></a>
</span><span id="test_data-160"><a href="#test_data-160"><span class="linenos">160</span></a>        <span class="n">file_name</span> <span class="o">=</span> <span class="s2">&quot;test_data.tar.gz&quot;</span>
</span><span id="test_data-161"><a href="#test_data-161"><span class="linenos">161</span></a>
</span><span id="test_data-162"><a href="#test_data-162"><span class="linenos">162</span></a>        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="test_data-163"><a href="#test_data-163"><span class="linenos">163</span></a>
</span><span id="test_data-164"><a href="#test_data-164"><span class="linenos">164</span></a>        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://drive.google.com/uc?id=1MhzhleMP7iTzlBVW8eP5sFaonJdg1a3T&quot;</span>
</span><span id="test_data-165"><a href="#test_data-165"><span class="linenos">165</span></a>
</span><span id="test_data-166"><a href="#test_data-166"><span class="linenos">166</span></a>        <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="test_data-167"><a href="#test_data-167"><span class="linenos">167</span></a>
</span><span id="test_data-168"><a href="#test_data-168"><span class="linenos">168</span></a>        <span class="c1"># Unzip</span>
</span><span id="test_data-169"><a href="#test_data-169"><span class="linenos">169</span></a>
</span><span id="test_data-170"><a href="#test_data-170"><span class="linenos">170</span></a>        <span class="k">with</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s2">&quot;r:gz&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
</span><span id="test_data-171"><a href="#test_data-171"><span class="linenos">171</span></a>            <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
</span><span id="test_data-172"><a href="#test_data-172"><span class="linenos">172</span></a>
</span><span id="test_data-173"><a href="#test_data-173"><span class="linenos">173</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="test_data-174"><a href="#test_data-174"><span class="linenos">174</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test data downloaded succesfully -&gt; </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test_data&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="test_data-175"><a href="#test_data-175"><span class="linenos">175</span></a>        <span class="p">)</span>
</span><span id="test_data-176"><a href="#test_data-176"><span class="linenos">176</span></a>
</span><span id="test_data-177"><a href="#test_data-177"><span class="linenos">177</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="test_data-178"><a href="#test_data-178"><span class="linenos">178</span></a>
</span><span id="test_data-179"><a href="#test_data-179"><span class="linenos">179</span></a>        <span class="nb">print</span><span class="p">(</span>
</span><span id="test_data-180"><a href="#test_data-180"><span class="linenos">180</span></a>            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test data could not be downloaded. Please check your connection and try again!&quot;</span>
</span><span id="test_data-181"><a href="#test_data-181"><span class="linenos">181</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Download and extract test data from Google Drive.</p>

<p>This function downloads a compressed archive containing example test data
and extracts it into the specified directory. The data is fetched using
a direct Google Drive link. If the download or extraction fails, an
error message is printed.</p>

<h2 id="parameters">Parameters</h2>

<p>path : str, optional
    Destination directory where the test dataset will be downloaded and
    extracted. Defaults to the current working directory.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The downloaded file is named <code>test_data.tar.gz</code>.</li>
<li>The archive is extracted into <code>&lt;path&gt;/test_data</code>.</li>
<li>In case of any failure (download or extraction), the function prints
an informative message instead of raising an exception.</li>
</ul>
</div>


                </section>
                <section id="prop_plot">
                            <input id="prop_plot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">prop_plot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df_pivot</span>, </span><span class="param"><span class="n">chi_df</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="prop_plot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#prop_plot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="prop_plot-184"><a href="#prop_plot-184"><span class="linenos">184</span></a><span class="k">def</span><span class="w"> </span><span class="nf">prop_plot</span><span class="p">(</span><span class="n">df_pivot</span><span class="p">,</span> <span class="n">chi_df</span><span class="p">):</span>
</span><span id="prop_plot-185"><a href="#prop_plot-185"><span class="linenos">185</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="prop_plot-186"><a href="#prop_plot-186"><span class="linenos">186</span></a><span class="sd">    Create a stacked bar plot of proportional data with post-hoc significance annotations.</span>
</span><span id="prop_plot-187"><a href="#prop_plot-187"><span class="linenos">187</span></a>
</span><span id="prop_plot-188"><a href="#prop_plot-188"><span class="linenos">188</span></a><span class="sd">    Parameters</span>
</span><span id="prop_plot-189"><a href="#prop_plot-189"><span class="linenos">189</span></a><span class="sd">    ----------</span>
</span><span id="prop_plot-190"><a href="#prop_plot-190"><span class="linenos">190</span></a><span class="sd">    df_pivot : pandas.DataFrame</span>
</span><span id="prop_plot-191"><a href="#prop_plot-191"><span class="linenos">191</span></a><span class="sd">        Pivot table where rows represent categories (e.g., compartments) and columns</span>
</span><span id="prop_plot-192"><a href="#prop_plot-192"><span class="linenos">192</span></a><span class="sd">        represent groups. Values are counts or frequencies.</span>
</span><span id="prop_plot-193"><a href="#prop_plot-193"><span class="linenos">193</span></a>
</span><span id="prop_plot-194"><a href="#prop_plot-194"><span class="linenos">194</span></a><span class="sd">    chi_df : pandas.DataFrame</span>
</span><span id="prop_plot-195"><a href="#prop_plot-195"><span class="linenos">195</span></a><span class="sd">        DataFrame containing pairwise Chi-square test results with an added</span>
</span><span id="prop_plot-196"><a href="#prop_plot-196"><span class="linenos">196</span></a><span class="sd">        &#39;Significance_Label&#39; column (e.g., &#39;***&#39;, &#39;**&#39;, &#39;*&#39;, &#39;ns&#39;) for each pair</span>
</span><span id="prop_plot-197"><a href="#prop_plot-197"><span class="linenos">197</span></a><span class="sd">        of groups. Typically output from `chi_pairs` and `get_significance_label`.</span>
</span><span id="prop_plot-198"><a href="#prop_plot-198"><span class="linenos">198</span></a>
</span><span id="prop_plot-199"><a href="#prop_plot-199"><span class="linenos">199</span></a><span class="sd">    Returns</span>
</span><span id="prop_plot-200"><a href="#prop_plot-200"><span class="linenos">200</span></a><span class="sd">    -------</span>
</span><span id="prop_plot-201"><a href="#prop_plot-201"><span class="linenos">201</span></a><span class="sd">    matplotlib.figure.Figure</span>
</span><span id="prop_plot-202"><a href="#prop_plot-202"><span class="linenos">202</span></a><span class="sd">        The Matplotlib figure object containing the stacked bar plot.</span>
</span><span id="prop_plot-203"><a href="#prop_plot-203"><span class="linenos">203</span></a>
</span><span id="prop_plot-204"><a href="#prop_plot-204"><span class="linenos">204</span></a><span class="sd">    Notes</span>
</span><span id="prop_plot-205"><a href="#prop_plot-205"><span class="linenos">205</span></a><span class="sd">    -----</span>
</span><span id="prop_plot-206"><a href="#prop_plot-206"><span class="linenos">206</span></a><span class="sd">    - The function converts raw counts to percentages per group for visualization.</span>
</span><span id="prop_plot-207"><a href="#prop_plot-207"><span class="linenos">207</span></a><span class="sd">    - Each pairwise comparison and its significance label is displayed as a text box</span>
</span><span id="prop_plot-208"><a href="#prop_plot-208"><span class="linenos">208</span></a><span class="sd">      next to the plot.</span>
</span><span id="prop_plot-209"><a href="#prop_plot-209"><span class="linenos">209</span></a><span class="sd">    - Colors are assigned using the &#39;viridis&#39; colormap by default.</span>
</span><span id="prop_plot-210"><a href="#prop_plot-210"><span class="linenos">210</span></a><span class="sd">    - The plot is configured for clarity with labeled axes, legend, and appropriately</span>
</span><span id="prop_plot-211"><a href="#prop_plot-211"><span class="linenos">211</span></a><span class="sd">      sized text.</span>
</span><span id="prop_plot-212"><a href="#prop_plot-212"><span class="linenos">212</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="prop_plot-213"><a href="#prop_plot-213"><span class="linenos">213</span></a>
</span><span id="prop_plot-214"><a href="#prop_plot-214"><span class="linenos">214</span></a>    <span class="n">df_pivot_perc</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</span><span id="prop_plot-215"><a href="#prop_plot-215"><span class="linenos">215</span></a>
</span><span id="prop_plot-216"><a href="#prop_plot-216"><span class="linenos">216</span></a>    <span class="n">chi_df</span> <span class="o">=</span> <span class="n">chi_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p-value&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="prop_plot-217"><a href="#prop_plot-217"><span class="linenos">217</span></a>
</span><span id="prop_plot-218"><a href="#prop_plot-218"><span class="linenos">218</span></a>    <span class="n">df_pivot_perc</span> <span class="o">=</span> <span class="n">df_pivot_perc</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">df_pivot_perc</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span><span id="prop_plot-219"><a href="#prop_plot-219"><span class="linenos">219</span></a>
</span><span id="prop_plot-220"><a href="#prop_plot-220"><span class="linenos">220</span></a>    <span class="n">posthoc_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span><span id="prop_plot-221"><a href="#prop_plot-221"><span class="linenos">221</span></a>        <span class="p">[</span>
</span><span id="prop_plot-222"><a href="#prop_plot-222"><span class="linenos">222</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Group 1&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> → </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Group 2&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Significance_Label&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="prop_plot-223"><a href="#prop_plot-223"><span class="linenos">223</span></a>            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">chi_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
</span><span id="prop_plot-224"><a href="#prop_plot-224"><span class="linenos">224</span></a>        <span class="p">]</span>
</span><span id="prop_plot-225"><a href="#prop_plot-225"><span class="linenos">225</span></a>    <span class="p">)</span>
</span><span id="prop_plot-226"><a href="#prop_plot-226"><span class="linenos">226</span></a>
</span><span id="prop_plot-227"><a href="#prop_plot-227"><span class="linenos">227</span></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
</span><span id="prop_plot-228"><a href="#prop_plot-228"><span class="linenos">228</span></a>
</span><span id="prop_plot-229"><a href="#prop_plot-229"><span class="linenos">229</span></a>    <span class="n">df_pivot_perc</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>
</span><span id="prop_plot-230"><a href="#prop_plot-230"><span class="linenos">230</span></a>
</span><span id="prop_plot-231"><a href="#prop_plot-231"><span class="linenos">231</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Percentage (%)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="prop_plot-232"><a href="#prop_plot-232"><span class="linenos">232</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Groups&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</span><span id="prop_plot-233"><a href="#prop_plot-233"><span class="linenos">233</span></a>
</span><span id="prop_plot-234"><a href="#prop_plot-234"><span class="linenos">234</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</span><span id="prop_plot-235"><a href="#prop_plot-235"><span class="linenos">235</span></a>
</span><span id="prop_plot-236"><a href="#prop_plot-236"><span class="linenos">236</span></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
</span><span id="prop_plot-237"><a href="#prop_plot-237"><span class="linenos">237</span></a>        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Compartment&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span>
</span><span id="prop_plot-238"><a href="#prop_plot-238"><span class="linenos">238</span></a>    <span class="p">)</span>
</span><span id="prop_plot-239"><a href="#prop_plot-239"><span class="linenos">239</span></a>
</span><span id="prop_plot-240"><a href="#prop_plot-240"><span class="linenos">240</span></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figtext</span><span class="p">(</span>
</span><span id="prop_plot-241"><a href="#prop_plot-241"><span class="linenos">241</span></a>        <span class="mf">0.93</span><span class="p">,</span>
</span><span id="prop_plot-242"><a href="#prop_plot-242"><span class="linenos">242</span></a>        <span class="mf">0.6</span><span class="p">,</span>
</span><span id="prop_plot-243"><a href="#prop_plot-243"><span class="linenos">243</span></a>        <span class="n">posthoc_text</span><span class="p">,</span>
</span><span id="prop_plot-244"><a href="#prop_plot-244"><span class="linenos">244</span></a>        <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
</span><span id="prop_plot-245"><a href="#prop_plot-245"><span class="linenos">245</span></a>        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
</span><span id="prop_plot-246"><a href="#prop_plot-246"><span class="linenos">246</span></a>        <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
</span><span id="prop_plot-247"><a href="#prop_plot-247"><span class="linenos">247</span></a>        <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;facecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span><span id="prop_plot-248"><a href="#prop_plot-248"><span class="linenos">248</span></a>    <span class="p">)</span>
</span><span id="prop_plot-249"><a href="#prop_plot-249"><span class="linenos">249</span></a>
</span><span id="prop_plot-250"><a href="#prop_plot-250"><span class="linenos">250</span></a>    <span class="k">return</span> <span class="n">fig</span>
</span></pre></div>


            <div class="docstring"><p>Create a stacked bar plot of proportional data with post-hoc significance annotations.</p>

<h2 id="parameters">Parameters</h2>

<p>df_pivot : pandas.DataFrame
    Pivot table where rows represent categories (e.g., compartments) and columns
    represent groups. Values are counts or frequencies.</p>

<p>chi_df : pandas.DataFrame
    DataFrame containing pairwise Chi-square test results with an added
    'Significance_Label' column (e.g., '<strong><em>', '</strong>', '</em>', 'ns') for each pair
    of groups. Typically output from <code><a href="#chi_pairs">chi_pairs</a></code> and <code><a href="#get_significance_label">get_significance_label</a></code>.</p>

<h2 id="returns">Returns</h2>

<p>matplotlib.figure.Figure
    The Matplotlib figure object containing the stacked bar plot.</p>

<h2 id="notes">Notes</h2>

<ul>
<li>The function converts raw counts to percentages per group for visualization.</li>
<li>Each pairwise comparison and its significance label is displayed as a text box
next to the plot.</li>
<li>Colors are assigned using the 'viridis' colormap by default.</li>
<li>The plot is configured for clarity with labeled axes, legend, and appropriately
sized text.</li>
</ul>
</div>


                </section>
                <section id="get_significance_label">
                            <input id="get_significance_label-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_significance_label</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">p_value</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_significance_label-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_significance_label"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_significance_label-253"><a href="#get_significance_label-253"><span class="linenos">253</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_significance_label</span><span class="p">(</span><span class="n">p_value</span><span class="p">):</span>
</span><span id="get_significance_label-254"><a href="#get_significance_label-254"><span class="linenos">254</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_significance_label-255"><a href="#get_significance_label-255"><span class="linenos">255</span></a><span class="sd">    Return a standard significance label based on a p-value.</span>
</span><span id="get_significance_label-256"><a href="#get_significance_label-256"><span class="linenos">256</span></a>
</span><span id="get_significance_label-257"><a href="#get_significance_label-257"><span class="linenos">257</span></a><span class="sd">    Parameters</span>
</span><span id="get_significance_label-258"><a href="#get_significance_label-258"><span class="linenos">258</span></a><span class="sd">    ----------</span>
</span><span id="get_significance_label-259"><a href="#get_significance_label-259"><span class="linenos">259</span></a><span class="sd">    p_value : float</span>
</span><span id="get_significance_label-260"><a href="#get_significance_label-260"><span class="linenos">260</span></a><span class="sd">        The p-value for which the significance label should be determined.</span>
</span><span id="get_significance_label-261"><a href="#get_significance_label-261"><span class="linenos">261</span></a>
</span><span id="get_significance_label-262"><a href="#get_significance_label-262"><span class="linenos">262</span></a><span class="sd">    Returns</span>
</span><span id="get_significance_label-263"><a href="#get_significance_label-263"><span class="linenos">263</span></a><span class="sd">    -------</span>
</span><span id="get_significance_label-264"><a href="#get_significance_label-264"><span class="linenos">264</span></a><span class="sd">    str</span>
</span><span id="get_significance_label-265"><a href="#get_significance_label-265"><span class="linenos">265</span></a><span class="sd">        A significance marker commonly used in statistical reporting:</span>
</span><span id="get_significance_label-266"><a href="#get_significance_label-266"><span class="linenos">266</span></a>
</span><span id="get_significance_label-267"><a href="#get_significance_label-267"><span class="linenos">267</span></a><span class="sd">        - &#39;***&#39; : p &lt; 0.001</span>
</span><span id="get_significance_label-268"><a href="#get_significance_label-268"><span class="linenos">268</span></a><span class="sd">        - &#39;**&#39;  : p &lt; 0.01</span>
</span><span id="get_significance_label-269"><a href="#get_significance_label-269"><span class="linenos">269</span></a><span class="sd">        - &#39;*&#39;   : p &lt; 0.05</span>
</span><span id="get_significance_label-270"><a href="#get_significance_label-270"><span class="linenos">270</span></a><span class="sd">        - &#39;ns&#39;  : not significant (p ≥ 0.05)</span>
</span><span id="get_significance_label-271"><a href="#get_significance_label-271"><span class="linenos">271</span></a>
</span><span id="get_significance_label-272"><a href="#get_significance_label-272"><span class="linenos">272</span></a><span class="sd">    Notes</span>
</span><span id="get_significance_label-273"><a href="#get_significance_label-273"><span class="linenos">273</span></a><span class="sd">    -----</span>
</span><span id="get_significance_label-274"><a href="#get_significance_label-274"><span class="linenos">274</span></a><span class="sd">    This helper function is typically used for annotating statistical test</span>
</span><span id="get_significance_label-275"><a href="#get_significance_label-275"><span class="linenos">275</span></a><span class="sd">    results in tables or visualizations. Thresholds follow conventional</span>
</span><span id="get_significance_label-276"><a href="#get_significance_label-276"><span class="linenos">276</span></a><span class="sd">    statistical notation for significance levels.</span>
</span><span id="get_significance_label-277"><a href="#get_significance_label-277"><span class="linenos">277</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_significance_label-278"><a href="#get_significance_label-278"><span class="linenos">278</span></a>
</span><span id="get_significance_label-279"><a href="#get_significance_label-279"><span class="linenos">279</span></a>    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
</span><span id="get_significance_label-280"><a href="#get_significance_label-280"><span class="linenos">280</span></a>        <span class="k">return</span> <span class="s2">&quot;***&quot;</span>
</span><span id="get_significance_label-281"><a href="#get_significance_label-281"><span class="linenos">281</span></a>    <span class="k">elif</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
</span><span id="get_significance_label-282"><a href="#get_significance_label-282"><span class="linenos">282</span></a>        <span class="k">return</span> <span class="s2">&quot;**&quot;</span>
</span><span id="get_significance_label-283"><a href="#get_significance_label-283"><span class="linenos">283</span></a>    <span class="k">elif</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
</span><span id="get_significance_label-284"><a href="#get_significance_label-284"><span class="linenos">284</span></a>        <span class="k">return</span> <span class="s2">&quot;*&quot;</span>
</span><span id="get_significance_label-285"><a href="#get_significance_label-285"><span class="linenos">285</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="get_significance_label-286"><a href="#get_significance_label-286"><span class="linenos">286</span></a>        <span class="k">return</span> <span class="s2">&quot;ns&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Return a standard significance label based on a p-value.</p>

<h2 id="parameters">Parameters</h2>

<p>p_value : float
    The p-value for which the significance label should be determined.</p>

<h2 id="returns">Returns</h2>

<p>str
    A significance marker commonly used in statistical reporting:</p>

<pre><code>- '***' : p &lt; 0.001
- '**'  : p &lt; 0.01
- '*'   : p &lt; 0.05
- 'ns'  : not significant (p ≥ 0.05)
</code></pre>

<h2 id="notes">Notes</h2>

<p>This helper function is typically used for annotating statistical test
results in tables or visualizations. Thresholds follow conventional
statistical notation for significance levels.</p>
</div>


                </section>
                <section id="chi_pairs">
                            <input id="chi_pairs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">chi_pairs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">df_pivot</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="chi_pairs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#chi_pairs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="chi_pairs-289"><a href="#chi_pairs-289"><span class="linenos">289</span></a><span class="k">def</span><span class="w"> </span><span class="nf">chi_pairs</span><span class="p">(</span><span class="n">df_pivot</span><span class="p">):</span>
</span><span id="chi_pairs-290"><a href="#chi_pairs-290"><span class="linenos">290</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="chi_pairs-291"><a href="#chi_pairs-291"><span class="linenos">291</span></a><span class="sd">    Compute pairwise Chi-square tests for all combinations of groups in a pivoted dataframe.</span>
</span><span id="chi_pairs-292"><a href="#chi_pairs-292"><span class="linenos">292</span></a>
</span><span id="chi_pairs-293"><a href="#chi_pairs-293"><span class="linenos">293</span></a><span class="sd">    Parameters</span>
</span><span id="chi_pairs-294"><a href="#chi_pairs-294"><span class="linenos">294</span></a><span class="sd">    ----------</span>
</span><span id="chi_pairs-295"><a href="#chi_pairs-295"><span class="linenos">295</span></a><span class="sd">    df_pivot : pandas.DataFrame</span>
</span><span id="chi_pairs-296"><a href="#chi_pairs-296"><span class="linenos">296</span></a><span class="sd">        A pivot table where rows represent categories and columns represent groups.</span>
</span><span id="chi_pairs-297"><a href="#chi_pairs-297"><span class="linenos">297</span></a><span class="sd">        Values should be counts (frequencies). The function will add +1 to each cell</span>
</span><span id="chi_pairs-298"><a href="#chi_pairs-298"><span class="linenos">298</span></a><span class="sd">        to avoid zero counts during chi-square computation.</span>
</span><span id="chi_pairs-299"><a href="#chi_pairs-299"><span class="linenos">299</span></a>
</span><span id="chi_pairs-300"><a href="#chi_pairs-300"><span class="linenos">300</span></a><span class="sd">    Returns</span>
</span><span id="chi_pairs-301"><a href="#chi_pairs-301"><span class="linenos">301</span></a><span class="sd">    -------</span>
</span><span id="chi_pairs-302"><a href="#chi_pairs-302"><span class="linenos">302</span></a><span class="sd">    pandas.DataFrame</span>
</span><span id="chi_pairs-303"><a href="#chi_pairs-303"><span class="linenos">303</span></a><span class="sd">        A DataFrame containing pairwise Chi-square test results with the following columns:</span>
</span><span id="chi_pairs-304"><a href="#chi_pairs-304"><span class="linenos">304</span></a><span class="sd">        - &#39;Group 1&#39; : str</span>
</span><span id="chi_pairs-305"><a href="#chi_pairs-305"><span class="linenos">305</span></a><span class="sd">            Name of the first group in the pair.</span>
</span><span id="chi_pairs-306"><a href="#chi_pairs-306"><span class="linenos">306</span></a><span class="sd">        - &#39;Group 2&#39; : str</span>
</span><span id="chi_pairs-307"><a href="#chi_pairs-307"><span class="linenos">307</span></a><span class="sd">            Name of the second group in the pair.</span>
</span><span id="chi_pairs-308"><a href="#chi_pairs-308"><span class="linenos">308</span></a><span class="sd">        - &#39;Chi²&#39; : float</span>
</span><span id="chi_pairs-309"><a href="#chi_pairs-309"><span class="linenos">309</span></a><span class="sd">            The Chi-square statistic for the comparison.</span>
</span><span id="chi_pairs-310"><a href="#chi_pairs-310"><span class="linenos">310</span></a><span class="sd">        - &#39;p-value&#39; : float</span>
</span><span id="chi_pairs-311"><a href="#chi_pairs-311"><span class="linenos">311</span></a><span class="sd">            The p-value of the Chi-square test.</span>
</span><span id="chi_pairs-312"><a href="#chi_pairs-312"><span class="linenos">312</span></a>
</span><span id="chi_pairs-313"><a href="#chi_pairs-313"><span class="linenos">313</span></a><span class="sd">    Notes</span>
</span><span id="chi_pairs-314"><a href="#chi_pairs-314"><span class="linenos">314</span></a><span class="sd">    -----</span>
</span><span id="chi_pairs-315"><a href="#chi_pairs-315"><span class="linenos">315</span></a><span class="sd">    The function compares every possible pair of columns using `scipy.stats.chi2_contingency`.</span>
</span><span id="chi_pairs-316"><a href="#chi_pairs-316"><span class="linenos">316</span></a><span class="sd">    Yates&#39; correction is applied by default unless disabled in the SciPy version used.</span>
</span><span id="chi_pairs-317"><a href="#chi_pairs-317"><span class="linenos">317</span></a><span class="sd">    A value of 1 is added to all cells to avoid issues with zero frequencies.</span>
</span><span id="chi_pairs-318"><a href="#chi_pairs-318"><span class="linenos">318</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="chi_pairs-319"><a href="#chi_pairs-319"><span class="linenos">319</span></a>
</span><span id="chi_pairs-320"><a href="#chi_pairs-320"><span class="linenos">320</span></a>    <span class="n">group_pairs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">df_pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="chi_pairs-321"><a href="#chi_pairs-321"><span class="linenos">321</span></a>
</span><span id="chi_pairs-322"><a href="#chi_pairs-322"><span class="linenos">322</span></a>    <span class="n">posthoc_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="chi_pairs-323"><a href="#chi_pairs-323"><span class="linenos">323</span></a>
</span><span id="chi_pairs-324"><a href="#chi_pairs-324"><span class="linenos">324</span></a>    <span class="k">for</span> <span class="n">group1</span><span class="p">,</span> <span class="n">group2</span> <span class="ow">in</span> <span class="n">group_pairs</span><span class="p">:</span>
</span><span id="chi_pairs-325"><a href="#chi_pairs-325"><span class="linenos">325</span></a>        <span class="n">sub_table</span> <span class="o">=</span> <span class="n">df_pivot</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">group1</span><span class="p">,</span> <span class="n">group2</span><span class="p">]]</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="chi_pairs-326"><a href="#chi_pairs-326"><span class="linenos">326</span></a>        <span class="n">chi2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">chi2_contingency</span><span class="p">(</span><span class="n">sub_table</span><span class="p">)</span>
</span><span id="chi_pairs-327"><a href="#chi_pairs-327"><span class="linenos">327</span></a>
</span><span id="chi_pairs-328"><a href="#chi_pairs-328"><span class="linenos">328</span></a>        <span class="n">posthoc_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="chi_pairs-329"><a href="#chi_pairs-329"><span class="linenos">329</span></a>            <span class="p">{</span><span class="s2">&quot;Group 1&quot;</span><span class="p">:</span> <span class="n">group1</span><span class="p">,</span> <span class="s2">&quot;Group 2&quot;</span><span class="p">:</span> <span class="n">group2</span><span class="p">,</span> <span class="s2">&quot;Chi²&quot;</span><span class="p">:</span> <span class="n">chi2</span><span class="p">,</span> <span class="s2">&quot;p-value&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">}</span>
</span><span id="chi_pairs-330"><a href="#chi_pairs-330"><span class="linenos">330</span></a>        <span class="p">)</span>
</span><span id="chi_pairs-331"><a href="#chi_pairs-331"><span class="linenos">331</span></a>
</span><span id="chi_pairs-332"><a href="#chi_pairs-332"><span class="linenos">332</span></a>    <span class="n">posthoc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posthoc_results</span><span class="p">)</span>
</span><span id="chi_pairs-333"><a href="#chi_pairs-333"><span class="linenos">333</span></a>
</span><span id="chi_pairs-334"><a href="#chi_pairs-334"><span class="linenos">334</span></a>    <span class="k">return</span> <span class="n">posthoc_df</span>
</span></pre></div>


            <div class="docstring"><p>Compute pairwise Chi-square tests for all combinations of groups in a pivoted dataframe.</p>

<h2 id="parameters">Parameters</h2>

<p>df_pivot : pandas.DataFrame
    A pivot table where rows represent categories and columns represent groups.
    Values should be counts (frequencies). The function will add +1 to each cell
    to avoid zero counts during chi-square computation.</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame
    A DataFrame containing pairwise Chi-square test results with the following columns:
    - 'Group 1' : str
        Name of the first group in the pair.
    - 'Group 2' : str
        Name of the second group in the pair.
    - 'Chi²' : float
        The Chi-square statistic for the comparison.
    - 'p-value' : float
        The p-value of the Chi-square test.</p>

<h2 id="notes">Notes</h2>

<p>The function compares every possible pair of columns using <code>scipy.stats.chi2_contingency</code>.
Yates' correction is applied by default unless disabled in the SciPy version used.
A value of 1 is added to all cells to avoid issues with zero frequencies.</p>
</div>


                </section>
                <section id="statistic">
                            <input id="statistic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">statistic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">input_df</span>, </span><span class="param"><span class="n">sets</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">metadata</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="statistic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#statistic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="statistic-337"><a href="#statistic-337"><span class="linenos">337</span></a><span class="k">def</span><span class="w"> </span><span class="nf">statistic</span><span class="p">(</span><span class="n">input_df</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="statistic-338"><a href="#statistic-338"><span class="linenos">338</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="statistic-339"><a href="#statistic-339"><span class="linenos">339</span></a><span class="sd">    Compute statistical comparison between cell groups or clusters.</span>
</span><span id="statistic-340"><a href="#statistic-340"><span class="linenos">340</span></a>
</span><span id="statistic-341"><a href="#statistic-341"><span class="linenos">341</span></a><span class="sd">    This function performs differential feature analysis between either:</span>
</span><span id="statistic-342"><a href="#statistic-342"><span class="linenos">342</span></a><span class="sd">    (1) every group vs. all other groups (default mode), or</span>
</span><span id="statistic-343"><a href="#statistic-343"><span class="linenos">343</span></a><span class="sd">    (2) two user-defined groups specified in ``sets``.</span>
</span><span id="statistic-344"><a href="#statistic-344"><span class="linenos">344</span></a>
</span><span id="statistic-345"><a href="#statistic-345"><span class="linenos">345</span></a><span class="sd">    The analysis includes:</span>
</span><span id="statistic-346"><a href="#statistic-346"><span class="linenos">346</span></a><span class="sd">    - Mann–Whitney U test</span>
</span><span id="statistic-347"><a href="#statistic-347"><span class="linenos">347</span></a><span class="sd">    - Percentage of non-zero values</span>
</span><span id="statistic-348"><a href="#statistic-348"><span class="linenos">348</span></a><span class="sd">    - Means and standard deviations</span>
</span><span id="statistic-349"><a href="#statistic-349"><span class="linenos">349</span></a><span class="sd">    - Effect size metric (ESM)</span>
</span><span id="statistic-350"><a href="#statistic-350"><span class="linenos">350</span></a><span class="sd">    - Benjamini–Hochberg FDR correction</span>
</span><span id="statistic-351"><a href="#statistic-351"><span class="linenos">351</span></a><span class="sd">    - Fold-change and log2 fold-change</span>
</span><span id="statistic-352"><a href="#statistic-352"><span class="linenos">352</span></a>
</span><span id="statistic-353"><a href="#statistic-353"><span class="linenos">353</span></a>
</span><span id="statistic-354"><a href="#statistic-354"><span class="linenos">354</span></a><span class="sd">    Parameters</span>
</span><span id="statistic-355"><a href="#statistic-355"><span class="linenos">355</span></a><span class="sd">    ----------</span>
</span><span id="statistic-356"><a href="#statistic-356"><span class="linenos">356</span></a><span class="sd">    input_df : pandas.DataFrame</span>
</span><span id="statistic-357"><a href="#statistic-357"><span class="linenos">357</span></a><span class="sd">        Input feature matrix where rows represent features and columns represent cells.</span>
</span><span id="statistic-358"><a href="#statistic-358"><span class="linenos">358</span></a><span class="sd">        The function transposes this table internally, treating columns as features.</span>
</span><span id="statistic-359"><a href="#statistic-359"><span class="linenos">359</span></a>
</span><span id="statistic-360"><a href="#statistic-360"><span class="linenos">360</span></a><span class="sd">    sets : dict or None, optional</span>
</span><span id="statistic-361"><a href="#statistic-361"><span class="linenos">361</span></a><span class="sd">        Mode selection:</span>
</span><span id="statistic-362"><a href="#statistic-362"><span class="linenos">362</span></a><span class="sd">        - ``None`` (default): each unique label in ``metadata[&#39;sets&#39;]`` is compared</span>
</span><span id="statistic-363"><a href="#statistic-363"><span class="linenos">363</span></a><span class="sd">          against all remaining groups.</span>
</span><span id="statistic-364"><a href="#statistic-364"><span class="linenos">364</span></a><span class="sd">        - ``dict``: must contain exactly two keys, each mapping to a list of labels</span>
</span><span id="statistic-365"><a href="#statistic-365"><span class="linenos">365</span></a><span class="sd">          belonging to each comparison group. Example:</span>
</span><span id="statistic-366"><a href="#statistic-366"><span class="linenos">366</span></a><span class="sd">          ``{&#39;A&#39;: [&#39;T1&#39;, &#39;T2&#39;], &#39;B&#39;: [&#39;C1&#39;, &#39;C2&#39;]}``.</span>
</span><span id="statistic-367"><a href="#statistic-367"><span class="linenos">367</span></a>
</span><span id="statistic-368"><a href="#statistic-368"><span class="linenos">368</span></a><span class="sd">    metadata : pandas.DataFrame, optional</span>
</span><span id="statistic-369"><a href="#statistic-369"><span class="linenos">369</span></a><span class="sd">        Metadata containing at least a column ``&#39;sets&#39;`` with group labels</span>
</span><span id="statistic-370"><a href="#statistic-370"><span class="linenos">370</span></a><span class="sd">        corresponding to columns of ``input_df``.</span>
</span><span id="statistic-371"><a href="#statistic-371"><span class="linenos">371</span></a>
</span><span id="statistic-372"><a href="#statistic-372"><span class="linenos">372</span></a><span class="sd">    n_proc : int, optional</span>
</span><span id="statistic-373"><a href="#statistic-373"><span class="linenos">373</span></a><span class="sd">        Number of parallel processes used for statistical computation.</span>
</span><span id="statistic-374"><a href="#statistic-374"><span class="linenos">374</span></a><span class="sd">        Default is ``10``.</span>
</span><span id="statistic-375"><a href="#statistic-375"><span class="linenos">375</span></a>
</span><span id="statistic-376"><a href="#statistic-376"><span class="linenos">376</span></a><span class="sd">    Returns</span>
</span><span id="statistic-377"><a href="#statistic-377"><span class="linenos">377</span></a><span class="sd">    -------</span>
</span><span id="statistic-378"><a href="#statistic-378"><span class="linenos">378</span></a><span class="sd">    pandas.DataFrame or None</span>
</span><span id="statistic-379"><a href="#statistic-379"><span class="linenos">379</span></a><span class="sd">        A DataFrame containing statistical results for each feature, including:</span>
</span><span id="statistic-380"><a href="#statistic-380"><span class="linenos">380</span></a>
</span><span id="statistic-381"><a href="#statistic-381"><span class="linenos">381</span></a><span class="sd">        - ``feature`` : str</span>
</span><span id="statistic-382"><a href="#statistic-382"><span class="linenos">382</span></a><span class="sd">        - ``p_val`` : float</span>
</span><span id="statistic-383"><a href="#statistic-383"><span class="linenos">383</span></a><span class="sd">        - ``adj_pval`` : float</span>
</span><span id="statistic-384"><a href="#statistic-384"><span class="linenos">384</span></a><span class="sd">        - ``pct_valid`` : float</span>
</span><span id="statistic-385"><a href="#statistic-385"><span class="linenos">385</span></a><span class="sd">        - ``pct_ctrl`` : float</span>
</span><span id="statistic-386"><a href="#statistic-386"><span class="linenos">386</span></a><span class="sd">        - ``avg_valid`` : float</span>
</span><span id="statistic-387"><a href="#statistic-387"><span class="linenos">387</span></a><span class="sd">        - ``avg_ctrl`` : float</span>
</span><span id="statistic-388"><a href="#statistic-388"><span class="linenos">388</span></a><span class="sd">        - ``sd_valid`` : float</span>
</span><span id="statistic-389"><a href="#statistic-389"><span class="linenos">389</span></a><span class="sd">        - ``sd_ctrl`` : float</span>
</span><span id="statistic-390"><a href="#statistic-390"><span class="linenos">390</span></a><span class="sd">        - ``esm`` : float</span>
</span><span id="statistic-391"><a href="#statistic-391"><span class="linenos">391</span></a><span class="sd">        - ``FC`` : float</span>
</span><span id="statistic-392"><a href="#statistic-392"><span class="linenos">392</span></a><span class="sd">        - ``log(FC)`` : float</span>
</span><span id="statistic-393"><a href="#statistic-393"><span class="linenos">393</span></a><span class="sd">        - ``norm_diff`` : float</span>
</span><span id="statistic-394"><a href="#statistic-394"><span class="linenos">394</span></a><span class="sd">        - ``valid_group`` : str</span>
</span><span id="statistic-395"><a href="#statistic-395"><span class="linenos">395</span></a><span class="sd">        - ``-log(p_val)`` : float</span>
</span><span id="statistic-396"><a href="#statistic-396"><span class="linenos">396</span></a>
</span><span id="statistic-397"><a href="#statistic-397"><span class="linenos">397</span></a><span class="sd">        If ``sets`` is ``None``, results for each group are concatenated.</span>
</span><span id="statistic-398"><a href="#statistic-398"><span class="linenos">398</span></a>
</span><span id="statistic-399"><a href="#statistic-399"><span class="linenos">399</span></a><span class="sd">        Returns ``None`` in case of errors or invalid parameters.</span>
</span><span id="statistic-400"><a href="#statistic-400"><span class="linenos">400</span></a>
</span><span id="statistic-401"><a href="#statistic-401"><span class="linenos">401</span></a><span class="sd">    Notes</span>
</span><span id="statistic-402"><a href="#statistic-402"><span class="linenos">402</span></a><span class="sd">    -----</span>
</span><span id="statistic-403"><a href="#statistic-403"><span class="linenos">403</span></a><span class="sd">    - Columns containing only zeros are automatically removed.</span>
</span><span id="statistic-404"><a href="#statistic-404"><span class="linenos">404</span></a><span class="sd">    - p-values equal for both groups produce ``p_val = 1``.</span>
</span><span id="statistic-405"><a href="#statistic-405"><span class="linenos">405</span></a><span class="sd">    - Benjamini–Hochberg correction is applied separately within each group comparison.</span>
</span><span id="statistic-406"><a href="#statistic-406"><span class="linenos">406</span></a><span class="sd">    - Fold-change is stabilized using a small, data-derived ``low_factor``.</span>
</span><span id="statistic-407"><a href="#statistic-407"><span class="linenos">407</span></a><span class="sd">    - Uses ``Mann–Whitney U`` test with ``alternative=&#39;two-sided&#39;``.</span>
</span><span id="statistic-408"><a href="#statistic-408"><span class="linenos">408</span></a>
</span><span id="statistic-409"><a href="#statistic-409"><span class="linenos">409</span></a><span class="sd">    Raises</span>
</span><span id="statistic-410"><a href="#statistic-410"><span class="linenos">410</span></a><span class="sd">    ------</span>
</span><span id="statistic-411"><a href="#statistic-411"><span class="linenos">411</span></a><span class="sd">    None</span>
</span><span id="statistic-412"><a href="#statistic-412"><span class="linenos">412</span></a><span class="sd">        All exceptions are caught internally and printed as messages.</span>
</span><span id="statistic-413"><a href="#statistic-413"><span class="linenos">413</span></a>
</span><span id="statistic-414"><a href="#statistic-414"><span class="linenos">414</span></a><span class="sd">    Examples</span>
</span><span id="statistic-415"><a href="#statistic-415"><span class="linenos">415</span></a><span class="sd">    --------</span>
</span><span id="statistic-416"><a href="#statistic-416"><span class="linenos">416</span></a><span class="sd">    &gt;&gt;&gt; df = pd.DataFrame(...)</span>
</span><span id="statistic-417"><a href="#statistic-417"><span class="linenos">417</span></a><span class="sd">    &gt;&gt;&gt; meta = pd.DataFrame({&#39;sets&#39;: [...]})</span>
</span><span id="statistic-418"><a href="#statistic-418"><span class="linenos">418</span></a><span class="sd">    &gt;&gt;&gt; stat = statistic(df, metadata=meta)</span>
</span><span id="statistic-419"><a href="#statistic-419"><span class="linenos">419</span></a><span class="sd">    &gt;&gt;&gt; stat.head()</span>
</span><span id="statistic-420"><a href="#statistic-420"><span class="linenos">420</span></a>
</span><span id="statistic-421"><a href="#statistic-421"><span class="linenos">421</span></a><span class="sd">    &gt;&gt;&gt; # Compare two groups explicitly</span>
</span><span id="statistic-422"><a href="#statistic-422"><span class="linenos">422</span></a><span class="sd">    &gt;&gt;&gt; sets = {&#39;A&#39;: [&#39;Type1&#39;], &#39;B&#39;: [&#39;Type2&#39;]}</span>
</span><span id="statistic-423"><a href="#statistic-423"><span class="linenos">423</span></a><span class="sd">    &gt;&gt;&gt; stat = statistic(df, sets=sets, metadata=meta, n_proc=4)</span>
</span><span id="statistic-424"><a href="#statistic-424"><span class="linenos">424</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="statistic-425"><a href="#statistic-425"><span class="linenos">425</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="statistic-426"><a href="#statistic-426"><span class="linenos">426</span></a>        <span class="n">offset</span> <span class="o">=</span> <span class="mf">1e-100</span>
</span><span id="statistic-427"><a href="#statistic-427"><span class="linenos">427</span></a>
</span><span id="statistic-428"><a href="#statistic-428"><span class="linenos">428</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">stat_calc</span><span class="p">(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
</span><span id="statistic-429"><a href="#statistic-429"><span class="linenos">429</span></a>            <span class="n">target_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="statistic-430"><a href="#statistic-430"><span class="linenos">430</span></a>            <span class="n">rest_values</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">]</span>
</span><span id="statistic-431"><a href="#statistic-431"><span class="linenos">431</span></a>
</span><span id="statistic-432"><a href="#statistic-432"><span class="linenos">432</span></a>            <span class="n">pct_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="statistic-433"><a href="#statistic-433"><span class="linenos">433</span></a>            <span class="n">pct_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">rest_values</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="statistic-434"><a href="#statistic-434"><span class="linenos">434</span></a>
</span><span id="statistic-435"><a href="#statistic-435"><span class="linenos">435</span></a>            <span class="n">avg_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span>
</span><span id="statistic-436"><a href="#statistic-436"><span class="linenos">436</span></a>            <span class="n">avg_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rest_values</span><span class="p">)</span>
</span><span id="statistic-437"><a href="#statistic-437"><span class="linenos">437</span></a>            <span class="n">sd_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">target_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="statistic-438"><a href="#statistic-438"><span class="linenos">438</span></a>            <span class="n">sd_ctrl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">rest_values</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="statistic-439"><a href="#statistic-439"><span class="linenos">439</span></a>            <span class="n">esm</span> <span class="o">=</span> <span class="p">(</span><span class="n">avg_valid</span> <span class="o">-</span> <span class="n">avg_ctrl</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">sd_valid</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sd_ctrl</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
</span><span id="statistic-440"><a href="#statistic-440"><span class="linenos">440</span></a>
</span><span id="statistic-441"><a href="#statistic-441"><span class="linenos">441</span></a>            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">target_values</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rest_values</span><span class="p">):</span>
</span><span id="statistic-442"><a href="#statistic-442"><span class="linenos">442</span></a>                <span class="n">p_val</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span id="statistic-443"><a href="#statistic-443"><span class="linenos">443</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="statistic-444"><a href="#statistic-444"><span class="linenos">444</span></a>                <span class="n">_</span><span class="p">,</span> <span class="n">p_val</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span>
</span><span id="statistic-445"><a href="#statistic-445"><span class="linenos">445</span></a>                    <span class="n">target_values</span><span class="p">,</span> <span class="n">rest_values</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;two-sided&quot;</span>
</span><span id="statistic-446"><a href="#statistic-446"><span class="linenos">446</span></a>                <span class="p">)</span>
</span><span id="statistic-447"><a href="#statistic-447"><span class="linenos">447</span></a>
</span><span id="statistic-448"><a href="#statistic-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="statistic-449"><a href="#statistic-449"><span class="linenos">449</span></a>                <span class="s2">&quot;feature&quot;</span><span class="p">:</span> <span class="n">feature_name</span><span class="p">,</span>
</span><span id="statistic-450"><a href="#statistic-450"><span class="linenos">450</span></a>                <span class="s2">&quot;p_val&quot;</span><span class="p">:</span> <span class="n">p_val</span><span class="p">,</span>
</span><span id="statistic-451"><a href="#statistic-451"><span class="linenos">451</span></a>                <span class="s2">&quot;pct_valid&quot;</span><span class="p">:</span> <span class="n">pct_valid</span><span class="p">,</span>
</span><span id="statistic-452"><a href="#statistic-452"><span class="linenos">452</span></a>                <span class="s2">&quot;pct_ctrl&quot;</span><span class="p">:</span> <span class="n">pct_rest</span><span class="p">,</span>
</span><span id="statistic-453"><a href="#statistic-453"><span class="linenos">453</span></a>                <span class="s2">&quot;avg_valid&quot;</span><span class="p">:</span> <span class="n">avg_valid</span><span class="p">,</span>
</span><span id="statistic-454"><a href="#statistic-454"><span class="linenos">454</span></a>                <span class="s2">&quot;avg_ctrl&quot;</span><span class="p">:</span> <span class="n">avg_ctrl</span><span class="p">,</span>
</span><span id="statistic-455"><a href="#statistic-455"><span class="linenos">455</span></a>                <span class="s2">&quot;sd_valid&quot;</span><span class="p">:</span> <span class="n">sd_valid</span><span class="p">,</span>
</span><span id="statistic-456"><a href="#statistic-456"><span class="linenos">456</span></a>                <span class="s2">&quot;sd_ctrl&quot;</span><span class="p">:</span> <span class="n">sd_ctrl</span><span class="p">,</span>
</span><span id="statistic-457"><a href="#statistic-457"><span class="linenos">457</span></a>                <span class="s2">&quot;esm&quot;</span><span class="p">:</span> <span class="n">esm</span><span class="p">,</span>
</span><span id="statistic-458"><a href="#statistic-458"><span class="linenos">458</span></a>            <span class="p">}</span>
</span><span id="statistic-459"><a href="#statistic-459"><span class="linenos">459</span></a>
</span><span id="statistic-460"><a href="#statistic-460"><span class="linenos">460</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">safe_min_half</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
</span><span id="statistic-461"><a href="#statistic-461"><span class="linenos">461</span></a>            <span class="n">filtered</span> <span class="o">=</span> <span class="n">series</span><span class="p">[(</span><span class="n">series</span> <span class="o">&gt;</span> <span class="p">((</span><span class="mi">2</span><span class="o">**-</span><span class="mi">1074</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">notna</span><span class="p">())]</span>
</span><span id="statistic-462"><a href="#statistic-462"><span class="linenos">462</span></a>            <span class="k">return</span> <span class="n">filtered</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="statistic-463"><a href="#statistic-463"><span class="linenos">463</span></a>
</span><span id="statistic-464"><a href="#statistic-464"><span class="linenos">464</span></a>        <span class="c1"># Transpose the input DataFrame</span>
</span><span id="statistic-465"><a href="#statistic-465"><span class="linenos">465</span></a>        <span class="n">choose</span> <span class="o">=</span> <span class="n">input_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</span><span id="statistic-466"><a href="#statistic-466"><span class="linenos">466</span></a>
</span><span id="statistic-467"><a href="#statistic-467"><span class="linenos">467</span></a>        <span class="k">if</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="statistic-468"><a href="#statistic-468"><span class="linenos">468</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...&quot;</span><span class="p">)</span>
</span><span id="statistic-469"><a href="#statistic-469"><span class="linenos">469</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparing each type of cell to others...&quot;</span><span class="p">)</span>
</span><span id="statistic-470"><a href="#statistic-470"><span class="linenos">470</span></a>            <span class="n">final_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="statistic-471"><a href="#statistic-471"><span class="linenos">471</span></a>
</span><span id="statistic-472"><a href="#statistic-472"><span class="linenos">472</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="statistic-473"><a href="#statistic-473"><span class="linenos">473</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="statistic-474"><a href="#statistic-474"><span class="linenos">474</span></a>
</span><span id="statistic-475"><a href="#statistic-475"><span class="linenos">475</span></a>            <span class="n">indexes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span><span id="statistic-476"><a href="#statistic-476"><span class="linenos">476</span></a>
</span><span id="statistic-477"><a href="#statistic-477"><span class="linenos">477</span></a>            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">indexes</span><span class="p">):</span>
</span><span id="statistic-478"><a href="#statistic-478"><span class="linenos">478</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating statistics for </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="statistic-479"><a href="#statistic-479"><span class="linenos">479</span></a>
</span><span id="statistic-480"><a href="#statistic-480"><span class="linenos">480</span></a>                <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">indexes</span>
</span><span id="statistic-481"><a href="#statistic-481"><span class="linenos">481</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">c</span><span class="p">,</span> <span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">)</span>
</span><span id="statistic-482"><a href="#statistic-482"><span class="linenos">482</span></a>
</span><span id="statistic-483"><a href="#statistic-483"><span class="linenos">483</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;target&quot;</span><span class="p">]))</span>
</span><span id="statistic-484"><a href="#statistic-484"><span class="linenos">484</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="statistic-485"><a href="#statistic-485"><span class="linenos">485</span></a>                    <span class="p">:,</span> <span class="p">(</span><span class="n">choose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="statistic-486"><a href="#statistic-486"><span class="linenos">486</span></a>                <span class="p">]</span>  <span class="c1"># Remove all-zero columns</span>
</span><span id="statistic-487"><a href="#statistic-487"><span class="linenos">487</span></a>
</span><span id="statistic-488"><a href="#statistic-488"><span class="linenos">488</span></a>                <span class="c1"># Parallel computation</span>
</span><span id="statistic-489"><a href="#statistic-489"><span class="linenos">489</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)(</span>
</span><span id="statistic-490"><a href="#statistic-490"><span class="linenos">490</span></a>                    <span class="n">delayed</span><span class="p">(</span><span class="n">stat_calc</span><span class="p">)(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</span><span id="statistic-491"><a href="#statistic-491"><span class="linenos">491</span></a>                    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;DEG&quot;</span><span class="p">])</span>
</span><span id="statistic-492"><a href="#statistic-492"><span class="linenos">492</span></a>                <span class="p">)</span>
</span><span id="statistic-493"><a href="#statistic-493"><span class="linenos">493</span></a>
</span><span id="statistic-494"><a href="#statistic-494"><span class="linenos">494</span></a>                <span class="c1"># Convert results to DataFrame</span>
</span><span id="statistic-495"><a href="#statistic-495"><span class="linenos">495</span></a>                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="statistic-496"><a href="#statistic-496"><span class="linenos">496</span></a>                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span>
</span><span id="statistic-497"><a href="#statistic-497"><span class="linenos">497</span></a>                    <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="statistic-498"><a href="#statistic-498"><span class="linenos">498</span></a>                <span class="p">]</span>
</span><span id="statistic-499"><a href="#statistic-499"><span class="linenos">499</span></a>
</span><span id="statistic-500"><a href="#statistic-500"><span class="linenos">500</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span>
</span><span id="statistic-501"><a href="#statistic-501"><span class="linenos">501</span></a>                <span class="n">combined_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p_val&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="statistic-502"><a href="#statistic-502"><span class="linenos">502</span></a>
</span><span id="statistic-503"><a href="#statistic-503"><span class="linenos">503</span></a>                <span class="c1"># Adjusted p-values using Benjamini-Hochberg method</span>
</span><span id="statistic-504"><a href="#statistic-504"><span class="linenos">504</span></a>                <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
</span><span id="statistic-505"><a href="#statistic-505"><span class="linenos">505</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
</span><span id="statistic-506"><a href="#statistic-506"><span class="linenos">506</span></a>                    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="statistic-507"><a href="#statistic-507"><span class="linenos">507</span></a>                <span class="p">)</span>
</span><span id="statistic-508"><a href="#statistic-508"><span class="linenos">508</span></a>
</span><span id="statistic-509"><a href="#statistic-509"><span class="linenos">509</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">1074</span><span class="p">)</span>
</span><span id="statistic-510"><a href="#statistic-510"><span class="linenos">510</span></a>
</span><span id="statistic-511"><a href="#statistic-511"><span class="linenos">511</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;-log(p_val)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">])</span>
</span><span id="statistic-512"><a href="#statistic-512"><span class="linenos">512</span></a>
</span><span id="statistic-513"><a href="#statistic-513"><span class="linenos">513</span></a>                <span class="n">valid_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">])</span>
</span><span id="statistic-514"><a href="#statistic-514"><span class="linenos">514</span></a>
</span><span id="statistic-515"><a href="#statistic-515"><span class="linenos">515</span></a>                <span class="n">ctrl_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">])</span>
</span><span id="statistic-516"><a href="#statistic-516"><span class="linenos">516</span></a>
</span><span id="statistic-517"><a href="#statistic-517"><span class="linenos">517</span></a>                <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="statistic-518"><a href="#statistic-518"><span class="linenos">518</span></a>
</span><span id="statistic-519"><a href="#statistic-519"><span class="linenos">519</span></a>                <span class="k">if</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="statistic-520"><a href="#statistic-520"><span class="linenos">520</span></a>                    <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="statistic-521"><a href="#statistic-521"><span class="linenos">521</span></a>
</span><span id="statistic-522"><a href="#statistic-522"><span class="linenos">522</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cv_factor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="statistic-523"><a href="#statistic-523"><span class="linenos">523</span></a>                    <span class="n">cv_factor</span> <span class="o">+=</span> <span class="n">offset</span>
</span><span id="statistic-524"><a href="#statistic-524"><span class="linenos">524</span></a>
</span><span id="statistic-525"><a href="#statistic-525"><span class="linenos">525</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="statistic-526"><a href="#statistic-526"><span class="linenos">526</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="statistic-527"><a href="#statistic-527"><span class="linenos">527</span></a>                <span class="p">)</span>
</span><span id="statistic-528"><a href="#statistic-528"><span class="linenos">528</span></a>
</span><span id="statistic-529"><a href="#statistic-529"><span class="linenos">529</span></a>                <span class="n">ctrl</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="statistic-530"><a href="#statistic-530"><span class="linenos">530</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="statistic-531"><a href="#statistic-531"><span class="linenos">531</span></a>                <span class="p">)</span>
</span><span id="statistic-532"><a href="#statistic-532"><span class="linenos">532</span></a>
</span><span id="statistic-533"><a href="#statistic-533"><span class="linenos">533</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">/</span> <span class="n">ctrl</span>
</span><span id="statistic-534"><a href="#statistic-534"><span class="linenos">534</span></a>
</span><span id="statistic-535"><a href="#statistic-535"><span class="linenos">535</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">])</span>
</span><span id="statistic-536"><a href="#statistic-536"><span class="linenos">536</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;norm_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="statistic-537"><a href="#statistic-537"><span class="linenos">537</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span>
</span><span id="statistic-538"><a href="#statistic-538"><span class="linenos">538</span></a>                <span class="p">)</span>
</span><span id="statistic-539"><a href="#statistic-539"><span class="linenos">539</span></a>
</span><span id="statistic-540"><a href="#statistic-540"><span class="linenos">540</span></a>                <span class="n">final_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
</span><span id="statistic-541"><a href="#statistic-541"><span class="linenos">541</span></a>
</span><span id="statistic-542"><a href="#statistic-542"><span class="linenos">542</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis has finished!&quot;</span><span class="p">)</span>
</span><span id="statistic-543"><a href="#statistic-543"><span class="linenos">543</span></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">final_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="statistic-544"><a href="#statistic-544"><span class="linenos">544</span></a>
</span><span id="statistic-545"><a href="#statistic-545"><span class="linenos">545</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="statistic-546"><a href="#statistic-546"><span class="linenos">546</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis started...&quot;</span><span class="p">)</span>
</span><span id="statistic-547"><a href="#statistic-547"><span class="linenos">547</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Comparing groups...&quot;</span><span class="p">)</span>
</span><span id="statistic-548"><a href="#statistic-548"><span class="linenos">548</span></a>
</span><span id="statistic-549"><a href="#statistic-549"><span class="linenos">549</span></a>            <span class="n">group_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="statistic-550"><a href="#statistic-550"><span class="linenos">550</span></a>            <span class="n">choose</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;sets&quot;</span><span class="p">]</span>
</span><span id="statistic-551"><a href="#statistic-551"><span class="linenos">551</span></a>
</span><span id="statistic-552"><a href="#statistic-552"><span class="linenos">552</span></a>            <span class="n">inx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">sets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">])</span>
</span><span id="statistic-553"><a href="#statistic-553"><span class="linenos">553</span></a>            <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">inx</span><span class="p">]</span>
</span><span id="statistic-554"><a href="#statistic-554"><span class="linenos">554</span></a>
</span><span id="statistic-555"><a href="#statistic-555"><span class="linenos">555</span></a>            <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span><span id="statistic-556"><a href="#statistic-556"><span class="linenos">556</span></a>            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_list</span><span class="p">):</span>
</span><span id="statistic-557"><a href="#statistic-557"><span class="linenos">557</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating statistics for </span><span class="si">{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="statistic-558"><a href="#statistic-558"><span class="linenos">558</span></a>
</span><span id="statistic-559"><a href="#statistic-559"><span class="linenos">559</span></a>                <span class="n">rest_indices</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="statistic-560"><a href="#statistic-560"><span class="linenos">560</span></a>                    <span class="n">idx</span>
</span><span id="statistic-561"><a href="#statistic-561"><span class="linenos">561</span></a>                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_list</span><span class="p">)</span>
</span><span id="statistic-562"><a href="#statistic-562"><span class="linenos">562</span></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">n</span>
</span><span id="statistic-563"><a href="#statistic-563"><span class="linenos">563</span></a>                    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
</span><span id="statistic-564"><a href="#statistic-564"><span class="linenos">564</span></a>                <span class="p">]</span>
</span><span id="statistic-565"><a href="#statistic-565"><span class="linenos">565</span></a>
</span><span id="statistic-566"><a href="#statistic-566"><span class="linenos">566</span></a>                <span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="statistic-567"><a href="#statistic-567"><span class="linenos">567</span></a>                    <span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sets</span><span class="p">[</span><span class="n">g</span><span class="p">]),</span>
</span><span id="statistic-568"><a href="#statistic-568"><span class="linenos">568</span></a>                    <span class="s2">&quot;target&quot;</span><span class="p">,</span>
</span><span id="statistic-569"><a href="#statistic-569"><span class="linenos">569</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">rest_indices</span><span class="p">),</span> <span class="s2">&quot;rest&quot;</span><span class="p">,</span> <span class="s2">&quot;drop&quot;</span><span class="p">),</span>
</span><span id="statistic-570"><a href="#statistic-570"><span class="linenos">570</span></a>                <span class="p">)</span>
</span><span id="statistic-571"><a href="#statistic-571"><span class="linenos">571</span></a>
</span><span id="statistic-572"><a href="#statistic-572"><span class="linenos">572</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="p">[</span><span class="n">choose</span><span class="p">[</span><span class="s2">&quot;DEG&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">]</span>
</span><span id="statistic-573"><a href="#statistic-573"><span class="linenos">573</span></a>
</span><span id="statistic-574"><a href="#statistic-574"><span class="linenos">574</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="n">g</span>
</span><span id="statistic-575"><a href="#statistic-575"><span class="linenos">575</span></a>                <span class="n">choose</span> <span class="o">=</span> <span class="n">choose</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
</span><span id="statistic-576"><a href="#statistic-576"><span class="linenos">576</span></a>                    <span class="p">:,</span> <span class="p">(</span><span class="n">choose</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="statistic-577"><a href="#statistic-577"><span class="linenos">577</span></a>                <span class="p">]</span>  <span class="c1"># Remove all-zero columns</span>
</span><span id="statistic-578"><a href="#statistic-578"><span class="linenos">578</span></a>
</span><span id="statistic-579"><a href="#statistic-579"><span class="linenos">579</span></a>                <span class="c1"># Parallel computation</span>
</span><span id="statistic-580"><a href="#statistic-580"><span class="linenos">580</span></a>                <span class="n">results</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">n_proc</span><span class="p">)(</span>
</span><span id="statistic-581"><a href="#statistic-581"><span class="linenos">581</span></a>                    <span class="n">delayed</span><span class="p">(</span><span class="n">stat_calc</span><span class="p">)(</span><span class="n">choose</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>
</span><span id="statistic-582"><a href="#statistic-582"><span class="linenos">582</span></a>                    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">choose</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="s2">&quot;DEG&quot;</span><span class="p">])</span>
</span><span id="statistic-583"><a href="#statistic-583"><span class="linenos">583</span></a>                <span class="p">)</span>
</span><span id="statistic-584"><a href="#statistic-584"><span class="linenos">584</span></a>
</span><span id="statistic-585"><a href="#statistic-585"><span class="linenos">585</span></a>                <span class="c1"># Convert results to DataFrame</span>
</span><span id="statistic-586"><a href="#statistic-586"><span class="linenos">586</span></a>                <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span><span id="statistic-587"><a href="#statistic-587"><span class="linenos">587</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;valid_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span>
</span><span id="statistic-588"><a href="#statistic-588"><span class="linenos">588</span></a>                <span class="n">combined_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;p_val&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="statistic-589"><a href="#statistic-589"><span class="linenos">589</span></a>
</span><span id="statistic-590"><a href="#statistic-590"><span class="linenos">590</span></a>                <span class="c1"># Adjusted p-values using Benjamini-Hochberg method</span>
</span><span id="statistic-591"><a href="#statistic-591"><span class="linenos">591</span></a>                <span class="n">num_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">)</span>
</span><span id="statistic-592"><a href="#statistic-592"><span class="linenos">592</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;adj_pval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
</span><span id="statistic-593"><a href="#statistic-593"><span class="linenos">593</span></a>                    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_tests</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_tests</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="statistic-594"><a href="#statistic-594"><span class="linenos">594</span></a>                <span class="p">)</span>
</span><span id="statistic-595"><a href="#statistic-595"><span class="linenos">595</span></a>
</span><span id="statistic-596"><a href="#statistic-596"><span class="linenos">596</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;-log(p_val)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;p_val&quot;</span><span class="p">])</span>
</span><span id="statistic-597"><a href="#statistic-597"><span class="linenos">597</span></a>
</span><span id="statistic-598"><a href="#statistic-598"><span class="linenos">598</span></a>                <span class="n">valid_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">])</span>
</span><span id="statistic-599"><a href="#statistic-599"><span class="linenos">599</span></a>
</span><span id="statistic-600"><a href="#statistic-600"><span class="linenos">600</span></a>                <span class="n">ctrl_factor</span> <span class="o">=</span> <span class="n">safe_min_half</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">])</span>
</span><span id="statistic-601"><a href="#statistic-601"><span class="linenos">601</span></a>
</span><span id="statistic-602"><a href="#statistic-602"><span class="linenos">602</span></a>                <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="statistic-603"><a href="#statistic-603"><span class="linenos">603</span></a>
</span><span id="statistic-604"><a href="#statistic-604"><span class="linenos">604</span></a>                <span class="k">if</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="statistic-605"><a href="#statistic-605"><span class="linenos">605</span></a>                    <span class="n">cv_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valid_factor</span><span class="p">,</span> <span class="n">ctrl_factor</span><span class="p">)</span>
</span><span id="statistic-606"><a href="#statistic-606"><span class="linenos">606</span></a>
</span><span id="statistic-607"><a href="#statistic-607"><span class="linenos">607</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cv_factor</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cv_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="statistic-608"><a href="#statistic-608"><span class="linenos">608</span></a>                    <span class="n">cv_factor</span> <span class="o">+=</span> <span class="n">offset</span>
</span><span id="statistic-609"><a href="#statistic-609"><span class="linenos">609</span></a>
</span><span id="statistic-610"><a href="#statistic-610"><span class="linenos">610</span></a>                <span class="n">valid</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="statistic-611"><a href="#statistic-611"><span class="linenos">611</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="statistic-612"><a href="#statistic-612"><span class="linenos">612</span></a>                <span class="p">)</span>
</span><span id="statistic-613"><a href="#statistic-613"><span class="linenos">613</span></a>
</span><span id="statistic-614"><a href="#statistic-614"><span class="linenos">614</span></a>                <span class="n">ctrl</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
</span><span id="statistic-615"><a href="#statistic-615"><span class="linenos">615</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cv_factor</span>
</span><span id="statistic-616"><a href="#statistic-616"><span class="linenos">616</span></a>                <span class="p">)</span>
</span><span id="statistic-617"><a href="#statistic-617"><span class="linenos">617</span></a>
</span><span id="statistic-618"><a href="#statistic-618"><span class="linenos">618</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span> <span class="o">/</span> <span class="n">ctrl</span>
</span><span id="statistic-619"><a href="#statistic-619"><span class="linenos">619</span></a>
</span><span id="statistic-620"><a href="#statistic-620"><span class="linenos">620</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;log(FC)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;FC&quot;</span><span class="p">])</span>
</span><span id="statistic-621"><a href="#statistic-621"><span class="linenos">621</span></a>                <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;norm_diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="statistic-622"><a href="#statistic-622"><span class="linenos">622</span></a>                    <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_valid&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;avg_ctrl&quot;</span><span class="p">]</span>
</span><span id="statistic-623"><a href="#statistic-623"><span class="linenos">623</span></a>                <span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
</span><span id="statistic-624"><a href="#statistic-624"><span class="linenos">624</span></a>
</span><span id="statistic-625"><a href="#statistic-625"><span class="linenos">625</span></a>                <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_df</span><span class="p">,</span> <span class="n">combined_df</span><span class="p">])</span>
</span><span id="statistic-626"><a href="#statistic-626"><span class="linenos">626</span></a>
</span><span id="statistic-627"><a href="#statistic-627"><span class="linenos">627</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Analysis has finished!&quot;</span><span class="p">)</span>
</span><span id="statistic-628"><a href="#statistic-628"><span class="linenos">628</span></a>            <span class="k">return</span> <span class="n">full_df</span>
</span><span id="statistic-629"><a href="#statistic-629"><span class="linenos">629</span></a>
</span><span id="statistic-630"><a href="#statistic-630"><span class="linenos">630</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="statistic-631"><a href="#statistic-631"><span class="linenos">631</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Invalid parameters. Please check the input.&quot;</span><span class="p">)</span>
</span><span id="statistic-632"><a href="#statistic-632"><span class="linenos">632</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="statistic-633"><a href="#statistic-633"><span class="linenos">633</span></a>
</span><span id="statistic-634"><a href="#statistic-634"><span class="linenos">634</span></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="statistic-635"><a href="#statistic-635"><span class="linenos">635</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="statistic-636"><a href="#statistic-636"><span class="linenos">636</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Compute statistical comparison between cell groups or clusters.</p>

<p>This function performs differential feature analysis between either:
(1) every group vs. all other groups (default mode), or
(2) two user-defined groups specified in <code>sets</code>.</p>

<p>The analysis includes:</p>

<ul>
<li>Mann–Whitney U test</li>
<li>Percentage of non-zero values</li>
<li>Means and standard deviations</li>
<li>Effect size metric (ESM)</li>
<li>Benjamini–Hochberg FDR correction</li>
<li>Fold-change and log2 fold-change</li>
</ul>

<h2 id="parameters">Parameters</h2>

<p>input_df : pandas.DataFrame
    Input feature matrix where rows represent features and columns represent cells.
    The function transposes this table internally, treating columns as features.</p>

<p>sets : dict or None, optional
    Mode selection:
    - <code>None</code> (default): each unique label in <code>metadata['sets']</code> is compared
      against all remaining groups.
    - <code>dict</code>: must contain exactly two keys, each mapping to a list of labels
      belonging to each comparison group. Example:
      <code>{'A': ['T1', 'T2'], 'B': ['C1', 'C2']}</code>.</p>

<p>metadata : pandas.DataFrame, optional
    Metadata containing at least a column <code>'sets'</code> with group labels
    corresponding to columns of <code>input_df</code>.</p>

<p>n_proc : int, optional
    Number of parallel processes used for statistical computation.
    Default is <code>10</code>.</p>

<h2 id="returns">Returns</h2>

<p>pandas.DataFrame or None
    A DataFrame containing statistical results for each feature, including:</p>

<pre><code>- ``feature`` : str
- ``p_val`` : float
- ``adj_pval`` : float
- ``pct_valid`` : float
- ``pct_ctrl`` : float
- ``avg_valid`` : float
- ``avg_ctrl`` : float
- ``sd_valid`` : float
- ``sd_ctrl`` : float
- ``esm`` : float
- ``FC`` : float
- ``log(FC)`` : float
- ``norm_diff`` : float
- ``valid_group`` : str
- ``-log(p_val)`` : float

If ``sets`` is ``None``, results for each group are concatenated.

Returns ``None`` in case of errors or invalid parameters.
</code></pre>

<h2 id="notes">Notes</h2>

<ul>
<li>Columns containing only zeros are automatically removed.</li>
<li>p-values equal for both groups produce <code>p_val = 1</code>.</li>
<li>Benjamini–Hochberg correction is applied separately within each group comparison.</li>
<li>Fold-change is stabilized using a small, data-derived <code>low_factor</code>.</li>
<li>Uses <code>Mann–Whitney U</code> test with <code>alternative='two-sided'</code>.</li>
</ul>

<h2 id="raises">Raises</h2>

<p>None
    All exceptions are caught internally and printed as messages.</p>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;sets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">...</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stat</span> <span class="o">=</span> <span class="n">statistic</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Compare two groups explicitly</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Type1&#39;</span><span class="p">],</span> <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Type2&#39;</span><span class="p">]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stat</span> <span class="o">=</span> <span class="n">statistic</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">sets</span><span class="o">=</span><span class="n">sets</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span> <span class="n">n_proc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</code></pre>
</div>
</div>


                </section>
                <section id="save_image">
                            <input id="save_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">path_to_save</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="save_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#save_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="save_image-642"><a href="#save_image-642"><span class="linenos">642</span></a><span class="k">def</span><span class="w"> </span><span class="nf">save_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">path_to_save</span><span class="p">):</span>
</span><span id="save_image-643"><a href="#save_image-643"><span class="linenos">643</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="save_image-644"><a href="#save_image-644"><span class="linenos">644</span></a><span class="sd">    Save an image to disk.</span>
</span><span id="save_image-645"><a href="#save_image-645"><span class="linenos">645</span></a>
</span><span id="save_image-646"><a href="#save_image-646"><span class="linenos">646</span></a><span class="sd">    Parameters</span>
</span><span id="save_image-647"><a href="#save_image-647"><span class="linenos">647</span></a><span class="sd">    ----------</span>
</span><span id="save_image-648"><a href="#save_image-648"><span class="linenos">648</span></a><span class="sd">    image : np.ndarray</span>
</span><span id="save_image-649"><a href="#save_image-649"><span class="linenos">649</span></a><span class="sd">        Input image array to be saved.</span>
</span><span id="save_image-650"><a href="#save_image-650"><span class="linenos">650</span></a>
</span><span id="save_image-651"><a href="#save_image-651"><span class="linenos">651</span></a><span class="sd">    path_to_save : str</span>
</span><span id="save_image-652"><a href="#save_image-652"><span class="linenos">652</span></a><span class="sd">        Output file path including the filename.</span>
</span><span id="save_image-653"><a href="#save_image-653"><span class="linenos">653</span></a><span class="sd">        Must include one of the following extensions:</span>
</span><span id="save_image-654"><a href="#save_image-654"><span class="linenos">654</span></a><span class="sd">        ``.png``, ``.tiff`` or ``.tif``.</span>
</span><span id="save_image-655"><a href="#save_image-655"><span class="linenos">655</span></a>
</span><span id="save_image-656"><a href="#save_image-656"><span class="linenos">656</span></a><span class="sd">    Returns</span>
</span><span id="save_image-657"><a href="#save_image-657"><span class="linenos">657</span></a><span class="sd">    -------</span>
</span><span id="save_image-658"><a href="#save_image-658"><span class="linenos">658</span></a><span class="sd">    str</span>
</span><span id="save_image-659"><a href="#save_image-659"><span class="linenos">659</span></a><span class="sd">        Path to the saved file.</span>
</span><span id="save_image-660"><a href="#save_image-660"><span class="linenos">660</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="save_image-661"><a href="#save_image-661"><span class="linenos">661</span></a>
</span><span id="save_image-662"><a href="#save_image-662"><span class="linenos">662</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="save_image-663"><a href="#save_image-663"><span class="linenos">663</span></a>        <span class="k">if</span> <span class="p">(</span>
</span><span id="save_image-664"><a href="#save_image-664"><span class="linenos">664</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span><span id="save_image-665"><a href="#save_image-665"><span class="linenos">665</span></a>            <span class="ow">or</span> <span class="s2">&quot;.png&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_to_save</span>
</span><span id="save_image-666"><a href="#save_image-666"><span class="linenos">666</span></a>            <span class="ow">or</span> <span class="s2">&quot;.tiff&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_to_save</span>
</span><span id="save_image-667"><a href="#save_image-667"><span class="linenos">667</span></a>            <span class="ow">or</span> <span class="s2">&quot;.tif&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_to_save</span>
</span><span id="save_image-668"><a href="#save_image-668"><span class="linenos">668</span></a>        <span class="p">):</span>
</span><span id="save_image-669"><a href="#save_image-669"><span class="linenos">669</span></a>            <span class="nb">print</span><span class="p">(</span>
</span><span id="save_image-670"><a href="#save_image-670"><span class="linenos">670</span></a>                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The path is not provided or the file extension is not *.png, *.tiff or *.tif&quot;</span>
</span><span id="save_image-671"><a href="#save_image-671"><span class="linenos">671</span></a>            <span class="p">)</span>
</span><span id="save_image-672"><a href="#save_image-672"><span class="linenos">672</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="save_image-673"><a href="#save_image-673"><span class="linenos">673</span></a>            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
</span><span id="save_image-674"><a href="#save_image-674"><span class="linenos">674</span></a>
</span><span id="save_image-675"><a href="#save_image-675"><span class="linenos">675</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="save_image-676"><a href="#save_image-676"><span class="linenos">676</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save an image to disk.</p>

<h2 id="parameters">Parameters</h2>

<p>image : np.ndarray
    Input image array to be saved.</p>

<p>path_to_save : str
    Output file path including the filename.
    Must include one of the following extensions:
    <code>.png</code>, <code>.tiff</code> or <code>.tif</code>.</p>

<h2 id="returns">Returns</h2>

<p>str
    Path to the saved file.</p>
</div>


                </section>
                <section id="load_tiff">
                            <input id="load_tiff-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_tiff</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">path_to_tiff</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="load_tiff-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_tiff"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_tiff-679"><a href="#load_tiff-679"><span class="linenos">679</span></a><span class="k">def</span><span class="w"> </span><span class="nf">load_tiff</span><span class="p">(</span><span class="n">path_to_tiff</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="load_tiff-680"><a href="#load_tiff-680"><span class="linenos">680</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="load_tiff-681"><a href="#load_tiff-681"><span class="linenos">681</span></a><span class="sd">    Load a *.tiff image and ensure it is in 16-bit format.</span>
</span><span id="load_tiff-682"><a href="#load_tiff-682"><span class="linenos">682</span></a>
</span><span id="load_tiff-683"><a href="#load_tiff-683"><span class="linenos">683</span></a><span class="sd">    Parameters</span>
</span><span id="load_tiff-684"><a href="#load_tiff-684"><span class="linenos">684</span></a><span class="sd">    ----------</span>
</span><span id="load_tiff-685"><a href="#load_tiff-685"><span class="linenos">685</span></a><span class="sd">    path_to_tiff : str</span>
</span><span id="load_tiff-686"><a href="#load_tiff-686"><span class="linenos">686</span></a><span class="sd">        Path to the *.tiff file.</span>
</span><span id="load_tiff-687"><a href="#load_tiff-687"><span class="linenos">687</span></a>
</span><span id="load_tiff-688"><a href="#load_tiff-688"><span class="linenos">688</span></a><span class="sd">    Returns</span>
</span><span id="load_tiff-689"><a href="#load_tiff-689"><span class="linenos">689</span></a><span class="sd">    -------</span>
</span><span id="load_tiff-690"><a href="#load_tiff-690"><span class="linenos">690</span></a><span class="sd">    np.ndarray</span>
</span><span id="load_tiff-691"><a href="#load_tiff-691"><span class="linenos">691</span></a><span class="sd">        Loaded image stack, converted to 16-bit if necessary.</span>
</span><span id="load_tiff-692"><a href="#load_tiff-692"><span class="linenos">692</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_tiff-693"><a href="#load_tiff-693"><span class="linenos">693</span></a>
</span><span id="load_tiff-694"><a href="#load_tiff-694"><span class="linenos">694</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="load_tiff-695"><a href="#load_tiff-695"><span class="linenos">695</span></a>        <span class="n">stack</span> <span class="o">=</span> <span class="n">tiff</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path_to_tiff</span><span class="p">)</span>
</span><span id="load_tiff-696"><a href="#load_tiff-696"><span class="linenos">696</span></a>
</span><span id="load_tiff-697"><a href="#load_tiff-697"><span class="linenos">697</span></a>        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
</span><span id="load_tiff-698"><a href="#load_tiff-698"><span class="linenos">698</span></a>
</span><span id="load_tiff-699"><a href="#load_tiff-699"><span class="linenos">699</span></a>            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="load_tiff-700"><a href="#load_tiff-700"><span class="linenos">700</span></a>
</span><span id="load_tiff-701"><a href="#load_tiff-701"><span class="linenos">701</span></a>            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
</span><span id="load_tiff-702"><a href="#load_tiff-702"><span class="linenos">702</span></a>
</span><span id="load_tiff-703"><a href="#load_tiff-703"><span class="linenos">703</span></a>                <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
</span><span id="load_tiff-704"><a href="#load_tiff-704"><span class="linenos">704</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
</span><span id="load_tiff-705"><a href="#load_tiff-705"><span class="linenos">705</span></a>
</span><span id="load_tiff-706"><a href="#load_tiff-706"><span class="linenos">706</span></a>                <span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
</span><span id="load_tiff-707"><a href="#load_tiff-707"><span class="linenos">707</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">uint16</span>
</span><span id="load_tiff-708"><a href="#load_tiff-708"><span class="linenos">708</span></a>                <span class="p">)</span>
</span><span id="load_tiff-709"><a href="#load_tiff-709"><span class="linenos">709</span></a>
</span><span id="load_tiff-710"><a href="#load_tiff-710"><span class="linenos">710</span></a>                <span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="load_tiff-711"><a href="#load_tiff-711"><span class="linenos">711</span></a>
</span><span id="load_tiff-712"><a href="#load_tiff-712"><span class="linenos">712</span></a>        <span class="k">return</span> <span class="n">stack</span>
</span><span id="load_tiff-713"><a href="#load_tiff-713"><span class="linenos">713</span></a>
</span><span id="load_tiff-714"><a href="#load_tiff-714"><span class="linenos">714</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="load_tiff-715"><a href="#load_tiff-715"><span class="linenos">715</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load a *.tiff image and ensure it is in 16-bit format.</p>

<h2 id="parameters">Parameters</h2>

<p>path_to_tiff : str
    Path to the *.tiff file.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Loaded image stack, converted to 16-bit if necessary.</p>
</div>


                </section>
                <section id="z_projection">
                            <input id="z_projection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">z_projection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">tiff_object</span>, </span><span class="param"><span class="n">projection_type</span><span class="o">=</span><span class="s1">&#39;avg&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="z_projection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#z_projection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="z_projection-718"><a href="#z_projection-718"><span class="linenos">718</span></a><span class="k">def</span><span class="w"> </span><span class="nf">z_projection</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">projection_type</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">):</span>
</span><span id="z_projection-719"><a href="#z_projection-719"><span class="linenos">719</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="z_projection-720"><a href="#z_projection-720"><span class="linenos">720</span></a><span class="sd">    Perform Z-projection on a stacked (3D) image.</span>
</span><span id="z_projection-721"><a href="#z_projection-721"><span class="linenos">721</span></a>
</span><span id="z_projection-722"><a href="#z_projection-722"><span class="linenos">722</span></a><span class="sd">    Parameters</span>
</span><span id="z_projection-723"><a href="#z_projection-723"><span class="linenos">723</span></a><span class="sd">    ----------</span>
</span><span id="z_projection-724"><a href="#z_projection-724"><span class="linenos">724</span></a><span class="sd">    tiff_object : np.ndarray</span>
</span><span id="z_projection-725"><a href="#z_projection-725"><span class="linenos">725</span></a><span class="sd">        Input stacked 3D image (e.g., loaded with `load_tiff()`).</span>
</span><span id="z_projection-726"><a href="#z_projection-726"><span class="linenos">726</span></a>
</span><span id="z_projection-727"><a href="#z_projection-727"><span class="linenos">727</span></a><span class="sd">    projection_type : str</span>
</span><span id="z_projection-728"><a href="#z_projection-728"><span class="linenos">728</span></a><span class="sd">        Type of Z-axis projection. Options: &#39;avg&#39;, &#39;median&#39;, &#39;min&#39;, &#39;max&#39;, &#39;std&#39;.</span>
</span><span id="z_projection-729"><a href="#z_projection-729"><span class="linenos">729</span></a>
</span><span id="z_projection-730"><a href="#z_projection-730"><span class="linenos">730</span></a><span class="sd">    Returns</span>
</span><span id="z_projection-731"><a href="#z_projection-731"><span class="linenos">731</span></a><span class="sd">    -------</span>
</span><span id="z_projection-732"><a href="#z_projection-732"><span class="linenos">732</span></a><span class="sd">    np.ndarray</span>
</span><span id="z_projection-733"><a href="#z_projection-733"><span class="linenos">733</span></a><span class="sd">        Resulting 2D projection image.</span>
</span><span id="z_projection-734"><a href="#z_projection-734"><span class="linenos">734</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="z_projection-735"><a href="#z_projection-735"><span class="linenos">735</span></a>
</span><span id="z_projection-736"><a href="#z_projection-736"><span class="linenos">736</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="z_projection-737"><a href="#z_projection-737"><span class="linenos">737</span></a>
</span><span id="z_projection-738"><a href="#z_projection-738"><span class="linenos">738</span></a>        <span class="k">if</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
</span><span id="z_projection-739"><a href="#z_projection-739"><span class="linenos">739</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="z_projection-740"><a href="#z_projection-740"><span class="linenos">740</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
</span><span id="z_projection-741"><a href="#z_projection-741"><span class="linenos">741</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="z_projection-742"><a href="#z_projection-742"><span class="linenos">742</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
</span><span id="z_projection-743"><a href="#z_projection-743"><span class="linenos">743</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="z_projection-744"><a href="#z_projection-744"><span class="linenos">744</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
</span><span id="z_projection-745"><a href="#z_projection-745"><span class="linenos">745</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="z_projection-746"><a href="#z_projection-746"><span class="linenos">746</span></a>        <span class="k">elif</span> <span class="n">projection_type</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
</span><span id="z_projection-747"><a href="#z_projection-747"><span class="linenos">747</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tiff_object</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="z_projection-748"><a href="#z_projection-748"><span class="linenos">748</span></a>
</span><span id="z_projection-749"><a href="#z_projection-749"><span class="linenos">749</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="z_projection-750"><a href="#z_projection-750"><span class="linenos">750</span></a>
</span><span id="z_projection-751"><a href="#z_projection-751"><span class="linenos">751</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="z_projection-752"><a href="#z_projection-752"><span class="linenos">752</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Perform Z-projection on a stacked (3D) image.</p>

<h2 id="parameters">Parameters</h2>

<p>tiff_object : np.ndarray
    Input stacked 3D image (e.g., loaded with <code><a href="#load_tiff">load_tiff()</a></code>).</p>

<p>projection_type : str
    Type of Z-axis projection. Options: 'avg', 'median', 'min', 'max', 'std'.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Resulting 2D projection image.</p>
</div>


                </section>
                <section id="clahe_16bit">
                            <input id="clahe_16bit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">clahe_16bit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">img</span>, </span><span class="param"><span class="n">kernal</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="clahe_16bit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#clahe_16bit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="clahe_16bit-755"><a href="#clahe_16bit-755"><span class="linenos">755</span></a><span class="k">def</span><span class="w"> </span><span class="nf">clahe_16bit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">kernal</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)):</span>
</span><span id="clahe_16bit-756"><a href="#clahe_16bit-756"><span class="linenos">756</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="clahe_16bit-757"><a href="#clahe_16bit-757"><span class="linenos">757</span></a><span class="sd">    Apply CLAHE (Contrast Limited Adaptive Histogram Equalization) to an image.</span>
</span><span id="clahe_16bit-758"><a href="#clahe_16bit-758"><span class="linenos">758</span></a>
</span><span id="clahe_16bit-759"><a href="#clahe_16bit-759"><span class="linenos">759</span></a><span class="sd">    Parameters</span>
</span><span id="clahe_16bit-760"><a href="#clahe_16bit-760"><span class="linenos">760</span></a><span class="sd">    ----------</span>
</span><span id="clahe_16bit-761"><a href="#clahe_16bit-761"><span class="linenos">761</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="clahe_16bit-762"><a href="#clahe_16bit-762"><span class="linenos">762</span></a><span class="sd">        Input image.</span>
</span><span id="clahe_16bit-763"><a href="#clahe_16bit-763"><span class="linenos">763</span></a>
</span><span id="clahe_16bit-764"><a href="#clahe_16bit-764"><span class="linenos">764</span></a><span class="sd">    Returns</span>
</span><span id="clahe_16bit-765"><a href="#clahe_16bit-765"><span class="linenos">765</span></a><span class="sd">    -------</span>
</span><span id="clahe_16bit-766"><a href="#clahe_16bit-766"><span class="linenos">766</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="clahe_16bit-767"><a href="#clahe_16bit-767"><span class="linenos">767</span></a><span class="sd">        Image after CLAHE enhancement.</span>
</span><span id="clahe_16bit-768"><a href="#clahe_16bit-768"><span class="linenos">768</span></a>
</span><span id="clahe_16bit-769"><a href="#clahe_16bit-769"><span class="linenos">769</span></a><span class="sd">    kernel : tuple</span>
</span><span id="clahe_16bit-770"><a href="#clahe_16bit-770"><span class="linenos">770</span></a><span class="sd">        Size of the CLAHE tile grid used for processing, e.g., (100, 100).</span>
</span><span id="clahe_16bit-771"><a href="#clahe_16bit-771"><span class="linenos">771</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="clahe_16bit-772"><a href="#clahe_16bit-772"><span class="linenos">772</span></a>
</span><span id="clahe_16bit-773"><a href="#clahe_16bit-773"><span class="linenos">773</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="clahe_16bit-774"><a href="#clahe_16bit-774"><span class="linenos">774</span></a>
</span><span id="clahe_16bit-775"><a href="#clahe_16bit-775"><span class="linenos">775</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="clahe_16bit-776"><a href="#clahe_16bit-776"><span class="linenos">776</span></a>
</span><span id="clahe_16bit-777"><a href="#clahe_16bit-777"><span class="linenos">777</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="clahe_16bit-778"><a href="#clahe_16bit-778"><span class="linenos">778</span></a>
</span><span id="clahe_16bit-779"><a href="#clahe_16bit-779"><span class="linenos">779</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img8bit</span><span class="p">)</span>
</span><span id="clahe_16bit-780"><a href="#clahe_16bit-780"><span class="linenos">780</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img8bit</span><span class="p">)</span>
</span><span id="clahe_16bit-781"><a href="#clahe_16bit-781"><span class="linenos">781</span></a>
</span><span id="clahe_16bit-782"><a href="#clahe_16bit-782"><span class="linenos">782</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">img8bit</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="clahe_16bit-783"><a href="#clahe_16bit-783"><span class="linenos">783</span></a>
</span><span id="clahe_16bit-784"><a href="#clahe_16bit-784"><span class="linenos">784</span></a>        <span class="n">clahe</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">createCLAHE</span><span class="p">(</span><span class="n">clipLimit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">tileGridSize</span><span class="o">=</span><span class="n">kernal</span><span class="p">)</span>
</span><span id="clahe_16bit-785"><a href="#clahe_16bit-785"><span class="linenos">785</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="n">clahe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">img8bit</span><span class="p">)</span>
</span><span id="clahe_16bit-786"><a href="#clahe_16bit-786"><span class="linenos">786</span></a>
</span><span id="clahe_16bit-787"><a href="#clahe_16bit-787"><span class="linenos">787</span></a>        <span class="n">img8bit</span> <span class="o">=</span> <span class="n">img8bit</span> <span class="o">/</span> <span class="mi">255</span>
</span><span id="clahe_16bit-788"><a href="#clahe_16bit-788"><span class="linenos">788</span></a>
</span><span id="clahe_16bit-789"><a href="#clahe_16bit-789"><span class="linenos">789</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">*</span> <span class="n">img8bit</span>
</span><span id="clahe_16bit-790"><a href="#clahe_16bit-790"><span class="linenos">790</span></a>
</span><span id="clahe_16bit-791"><a href="#clahe_16bit-791"><span class="linenos">791</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="clahe_16bit-792"><a href="#clahe_16bit-792"><span class="linenos">792</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="clahe_16bit-793"><a href="#clahe_16bit-793"><span class="linenos">793</span></a>
</span><span id="clahe_16bit-794"><a href="#clahe_16bit-794"><span class="linenos">794</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="clahe_16bit-795"><a href="#clahe_16bit-795"><span class="linenos">795</span></a>
</span><span id="clahe_16bit-796"><a href="#clahe_16bit-796"><span class="linenos">796</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="clahe_16bit-797"><a href="#clahe_16bit-797"><span class="linenos">797</span></a>
</span><span id="clahe_16bit-798"><a href="#clahe_16bit-798"><span class="linenos">798</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="clahe_16bit-799"><a href="#clahe_16bit-799"><span class="linenos">799</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Apply CLAHE (Contrast Limited Adaptive Histogram Equalization) to an image.</p>

<h2 id="parameters">Parameters</h2>

<p>img : np.ndarray
    Input image.</p>

<h2 id="returns">Returns</h2>

<p>img : np.ndarray
    Image after CLAHE enhancement.</p>

<p>kernel : tuple
    Size of the CLAHE tile grid used for processing, e.g., (100, 100).</p>
</div>


                </section>
                <section id="equalizeHist_16bit">
                            <input id="equalizeHist_16bit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">equalizeHist_16bit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image_eq</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="equalizeHist_16bit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#equalizeHist_16bit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="equalizeHist_16bit-802"><a href="#equalizeHist_16bit-802"><span class="linenos">802</span></a><span class="k">def</span><span class="w"> </span><span class="nf">equalizeHist_16bit</span><span class="p">(</span><span class="n">image_eq</span><span class="p">):</span>
</span><span id="equalizeHist_16bit-803"><a href="#equalizeHist_16bit-803"><span class="linenos">803</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="equalizeHist_16bit-804"><a href="#equalizeHist_16bit-804"><span class="linenos">804</span></a><span class="sd">    Apply global histogram equalization to an image.</span>
</span><span id="equalizeHist_16bit-805"><a href="#equalizeHist_16bit-805"><span class="linenos">805</span></a>
</span><span id="equalizeHist_16bit-806"><a href="#equalizeHist_16bit-806"><span class="linenos">806</span></a><span class="sd">    Parameters</span>
</span><span id="equalizeHist_16bit-807"><a href="#equalizeHist_16bit-807"><span class="linenos">807</span></a><span class="sd">    ----------</span>
</span><span id="equalizeHist_16bit-808"><a href="#equalizeHist_16bit-808"><span class="linenos">808</span></a><span class="sd">    image_eq : np.ndarray</span>
</span><span id="equalizeHist_16bit-809"><a href="#equalizeHist_16bit-809"><span class="linenos">809</span></a><span class="sd">        Input image.</span>
</span><span id="equalizeHist_16bit-810"><a href="#equalizeHist_16bit-810"><span class="linenos">810</span></a>
</span><span id="equalizeHist_16bit-811"><a href="#equalizeHist_16bit-811"><span class="linenos">811</span></a><span class="sd">    Returns</span>
</span><span id="equalizeHist_16bit-812"><a href="#equalizeHist_16bit-812"><span class="linenos">812</span></a><span class="sd">    -------</span>
</span><span id="equalizeHist_16bit-813"><a href="#equalizeHist_16bit-813"><span class="linenos">813</span></a><span class="sd">    np.ndarray</span>
</span><span id="equalizeHist_16bit-814"><a href="#equalizeHist_16bit-814"><span class="linenos">814</span></a><span class="sd">        Image after global histogram equalization.</span>
</span><span id="equalizeHist_16bit-815"><a href="#equalizeHist_16bit-815"><span class="linenos">815</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="equalizeHist_16bit-816"><a href="#equalizeHist_16bit-816"><span class="linenos">816</span></a>
</span><span id="equalizeHist_16bit-817"><a href="#equalizeHist_16bit-817"><span class="linenos">817</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="equalizeHist_16bit-818"><a href="#equalizeHist_16bit-818"><span class="linenos">818</span></a>
</span><span id="equalizeHist_16bit-819"><a href="#equalizeHist_16bit-819"><span class="linenos">819</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">image_eq</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="equalizeHist_16bit-820"><a href="#equalizeHist_16bit-820"><span class="linenos">820</span></a>
</span><span id="equalizeHist_16bit-821"><a href="#equalizeHist_16bit-821"><span class="linenos">821</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="equalizeHist_16bit-822"><a href="#equalizeHist_16bit-822"><span class="linenos">822</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="equalizeHist_16bit-823"><a href="#equalizeHist_16bit-823"><span class="linenos">823</span></a>
</span><span id="equalizeHist_16bit-824"><a href="#equalizeHist_16bit-824"><span class="linenos">824</span></a>        <span class="n">scaled_image</span> <span class="o">=</span> <span class="p">((</span><span class="n">image</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</span><span id="equalizeHist_16bit-825"><a href="#equalizeHist_16bit-825"><span class="linenos">825</span></a>
</span><span id="equalizeHist_16bit-826"><a href="#equalizeHist_16bit-826"><span class="linenos">826</span></a>        <span class="n">eq_image</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">equalizeHist</span><span class="p">(</span><span class="n">scaled_image</span><span class="p">)</span>
</span><span id="equalizeHist_16bit-827"><a href="#equalizeHist_16bit-827"><span class="linenos">827</span></a>
</span><span id="equalizeHist_16bit-828"><a href="#equalizeHist_16bit-828"><span class="linenos">828</span></a>        <span class="n">eq_image_bin</span> <span class="o">=</span> <span class="n">eq_image</span> <span class="o">/</span> <span class="mi">255</span>
</span><span id="equalizeHist_16bit-829"><a href="#equalizeHist_16bit-829"><span class="linenos">829</span></a>
</span><span id="equalizeHist_16bit-830"><a href="#equalizeHist_16bit-830"><span class="linenos">830</span></a>        <span class="n">image_eq_16</span> <span class="o">=</span> <span class="n">image</span> <span class="o">*</span> <span class="n">eq_image_bin</span>
</span><span id="equalizeHist_16bit-831"><a href="#equalizeHist_16bit-831"><span class="linenos">831</span></a>        <span class="n">image_eq_16</span> <span class="o">=</span> <span class="p">(</span><span class="n">image_eq_16</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_eq_16</span><span class="p">))</span> <span class="o">*</span> <span class="mi">65535</span>
</span><span id="equalizeHist_16bit-832"><a href="#equalizeHist_16bit-832"><span class="linenos">832</span></a>        <span class="n">image_eq_16</span><span class="p">[</span><span class="n">image_eq_16</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">65535</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_eq_16</span><span class="p">)</span>
</span><span id="equalizeHist_16bit-833"><a href="#equalizeHist_16bit-833"><span class="linenos">833</span></a>        <span class="n">image_eq_16</span> <span class="o">=</span> <span class="n">image_eq_16</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="equalizeHist_16bit-834"><a href="#equalizeHist_16bit-834"><span class="linenos">834</span></a>
</span><span id="equalizeHist_16bit-835"><a href="#equalizeHist_16bit-835"><span class="linenos">835</span></a>        <span class="k">return</span> <span class="n">image_eq_16</span>
</span><span id="equalizeHist_16bit-836"><a href="#equalizeHist_16bit-836"><span class="linenos">836</span></a>
</span><span id="equalizeHist_16bit-837"><a href="#equalizeHist_16bit-837"><span class="linenos">837</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="equalizeHist_16bit-838"><a href="#equalizeHist_16bit-838"><span class="linenos">838</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Apply global histogram equalization to an image.</p>

<h2 id="parameters">Parameters</h2>

<p>image_eq : np.ndarray
    Input image.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Image after global histogram equalization.</p>
</div>


                </section>
                <section id="load_image">
                            <input id="load_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="load_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_image-841"><a href="#load_image-841"><span class="linenos">841</span></a><span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="load_image-842"><a href="#load_image-842"><span class="linenos">842</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="load_image-843"><a href="#load_image-843"><span class="linenos">843</span></a><span class="sd">    Load an image and convert it to 16-bit if necessary.</span>
</span><span id="load_image-844"><a href="#load_image-844"><span class="linenos">844</span></a>
</span><span id="load_image-845"><a href="#load_image-845"><span class="linenos">845</span></a><span class="sd">    Parameters</span>
</span><span id="load_image-846"><a href="#load_image-846"><span class="linenos">846</span></a><span class="sd">    ----------</span>
</span><span id="load_image-847"><a href="#load_image-847"><span class="linenos">847</span></a><span class="sd">    path : str</span>
</span><span id="load_image-848"><a href="#load_image-848"><span class="linenos">848</span></a><span class="sd">        Path to the image file.</span>
</span><span id="load_image-849"><a href="#load_image-849"><span class="linenos">849</span></a>
</span><span id="load_image-850"><a href="#load_image-850"><span class="linenos">850</span></a><span class="sd">    Returns</span>
</span><span id="load_image-851"><a href="#load_image-851"><span class="linenos">851</span></a><span class="sd">    -------</span>
</span><span id="load_image-852"><a href="#load_image-852"><span class="linenos">852</span></a><span class="sd">    np.ndarray</span>
</span><span id="load_image-853"><a href="#load_image-853"><span class="linenos">853</span></a><span class="sd">        Loaded 16-bit image.</span>
</span><span id="load_image-854"><a href="#load_image-854"><span class="linenos">854</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_image-855"><a href="#load_image-855"><span class="linenos">855</span></a>
</span><span id="load_image-856"><a href="#load_image-856"><span class="linenos">856</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="load_image-857"><a href="#load_image-857"><span class="linenos">857</span></a>
</span><span id="load_image-858"><a href="#load_image-858"><span class="linenos">858</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_ANYDEPTH</span> <span class="o">|</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
</span><span id="load_image-859"><a href="#load_image-859"><span class="linenos">859</span></a>
</span><span id="load_image-860"><a href="#load_image-860"><span class="linenos">860</span></a>        <span class="c1"># convert to 16 bit (the function are working on 16 bit images!)</span>
</span><span id="load_image-861"><a href="#load_image-861"><span class="linenos">861</span></a>        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;uint16&quot;</span><span class="p">:</span>
</span><span id="load_image-862"><a href="#load_image-862"><span class="linenos">862</span></a>
</span><span id="load_image-863"><a href="#load_image-863"><span class="linenos">863</span></a>            <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="load_image-864"><a href="#load_image-864"><span class="linenos">864</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="load_image-865"><a href="#load_image-865"><span class="linenos">865</span></a>
</span><span id="load_image-866"><a href="#load_image-866"><span class="linenos">866</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">-</span> <span class="n">min_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="load_image-867"><a href="#load_image-867"><span class="linenos">867</span></a>
</span><span id="load_image-868"><a href="#load_image-868"><span class="linenos">868</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="load_image-869"><a href="#load_image-869"><span class="linenos">869</span></a>
</span><span id="load_image-870"><a href="#load_image-870"><span class="linenos">870</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="load_image-871"><a href="#load_image-871"><span class="linenos">871</span></a>
</span><span id="load_image-872"><a href="#load_image-872"><span class="linenos">872</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="load_image-873"><a href="#load_image-873"><span class="linenos">873</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load an image and convert it to 16-bit if necessary.</p>

<h2 id="parameters">Parameters</h2>

<p>path : str
    Path to the image file.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Loaded 16-bit image.</p>
</div>


                </section>
                <section id="rotate_image">
                            <input id="rotate_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rotate_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">img</span>, </span><span class="param"><span class="n">rotate</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rotate_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rotate_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rotate_image-876"><a href="#rotate_image-876"><span class="linenos">876</span></a><span class="k">def</span><span class="w"> </span><span class="nf">rotate_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rotate</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="rotate_image-877"><a href="#rotate_image-877"><span class="linenos">877</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="rotate_image-878"><a href="#rotate_image-878"><span class="linenos">878</span></a><span class="sd">    Rotate an image by a specified angle.</span>
</span><span id="rotate_image-879"><a href="#rotate_image-879"><span class="linenos">879</span></a>
</span><span id="rotate_image-880"><a href="#rotate_image-880"><span class="linenos">880</span></a><span class="sd">    Parameters</span>
</span><span id="rotate_image-881"><a href="#rotate_image-881"><span class="linenos">881</span></a><span class="sd">    ----------</span>
</span><span id="rotate_image-882"><a href="#rotate_image-882"><span class="linenos">882</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="rotate_image-883"><a href="#rotate_image-883"><span class="linenos">883</span></a><span class="sd">        Image to rotate.</span>
</span><span id="rotate_image-884"><a href="#rotate_image-884"><span class="linenos">884</span></a>
</span><span id="rotate_image-885"><a href="#rotate_image-885"><span class="linenos">885</span></a><span class="sd">    rotate : int</span>
</span><span id="rotate_image-886"><a href="#rotate_image-886"><span class="linenos">886</span></a><span class="sd">        Degree of rotation. Available options: 90, 180, 270.</span>
</span><span id="rotate_image-887"><a href="#rotate_image-887"><span class="linenos">887</span></a>
</span><span id="rotate_image-888"><a href="#rotate_image-888"><span class="linenos">888</span></a><span class="sd">    Returns</span>
</span><span id="rotate_image-889"><a href="#rotate_image-889"><span class="linenos">889</span></a><span class="sd">    -------</span>
</span><span id="rotate_image-890"><a href="#rotate_image-890"><span class="linenos">890</span></a><span class="sd">    np.ndarray</span>
</span><span id="rotate_image-891"><a href="#rotate_image-891"><span class="linenos">891</span></a><span class="sd">        Rotated image.</span>
</span><span id="rotate_image-892"><a href="#rotate_image-892"><span class="linenos">892</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="rotate_image-893"><a href="#rotate_image-893"><span class="linenos">893</span></a>
</span><span id="rotate_image-894"><a href="#rotate_image-894"><span class="linenos">894</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="rotate_image-895"><a href="#rotate_image-895"><span class="linenos">895</span></a>
</span><span id="rotate_image-896"><a href="#rotate_image-896"><span class="linenos">896</span></a>        <span class="k">if</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="rotate_image-897"><a href="#rotate_image-897"><span class="linenos">897</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="rotate_image-898"><a href="#rotate_image-898"><span class="linenos">898</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">90</span><span class="p">:</span>
</span><span id="rotate_image-899"><a href="#rotate_image-899"><span class="linenos">899</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="rotate_image-900"><a href="#rotate_image-900"><span class="linenos">900</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">180</span><span class="p">:</span>
</span><span id="rotate_image-901"><a href="#rotate_image-901"><span class="linenos">901</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="rotate_image-902"><a href="#rotate_image-902"><span class="linenos">902</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">180</span><span class="p">:</span>
</span><span id="rotate_image-903"><a href="#rotate_image-903"><span class="linenos">903</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="rotate_image-904"><a href="#rotate_image-904"><span class="linenos">904</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="mi">270</span><span class="p">:</span>
</span><span id="rotate_image-905"><a href="#rotate_image-905"><span class="linenos">905</span></a>            <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="rotate_image-906"><a href="#rotate_image-906"><span class="linenos">906</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="rotate_image-907"><a href="#rotate_image-907"><span class="linenos">907</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrong argument - rotate!&quot;</span><span class="p">)</span>
</span><span id="rotate_image-908"><a href="#rotate_image-908"><span class="linenos">908</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="rotate_image-909"><a href="#rotate_image-909"><span class="linenos">909</span></a>
</span><span id="rotate_image-910"><a href="#rotate_image-910"><span class="linenos">910</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="rotate_image-911"><a href="#rotate_image-911"><span class="linenos">911</span></a>
</span><span id="rotate_image-912"><a href="#rotate_image-912"><span class="linenos">912</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">k</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
</span><span id="rotate_image-913"><a href="#rotate_image-913"><span class="linenos">913</span></a>
</span><span id="rotate_image-914"><a href="#rotate_image-914"><span class="linenos">914</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="rotate_image-915"><a href="#rotate_image-915"><span class="linenos">915</span></a>
</span><span id="rotate_image-916"><a href="#rotate_image-916"><span class="linenos">916</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="rotate_image-917"><a href="#rotate_image-917"><span class="linenos">917</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Rotate an image by a specified angle.</p>

<h2 id="parameters">Parameters</h2>

<p>img : np.ndarray
    Image to rotate.</p>

<p>rotate : int
    Degree of rotation. Available options: 90, 180, 270.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Rotated image.</p>
</div>


                </section>
                <section id="mirror_image">
                            <input id="mirror_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">mirror_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">img</span>, </span><span class="param"><span class="n">rotate</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="mirror_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#mirror_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="mirror_image-920"><a href="#mirror_image-920"><span class="linenos">920</span></a><span class="k">def</span><span class="w"> </span><span class="nf">mirror_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">rotate</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="mirror_image-921"><a href="#mirror_image-921"><span class="linenos">921</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="mirror_image-922"><a href="#mirror_image-922"><span class="linenos">922</span></a><span class="sd">    Mirror an image along specified axes.</span>
</span><span id="mirror_image-923"><a href="#mirror_image-923"><span class="linenos">923</span></a>
</span><span id="mirror_image-924"><a href="#mirror_image-924"><span class="linenos">924</span></a><span class="sd">    Parameters</span>
</span><span id="mirror_image-925"><a href="#mirror_image-925"><span class="linenos">925</span></a><span class="sd">    ----------</span>
</span><span id="mirror_image-926"><a href="#mirror_image-926"><span class="linenos">926</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="mirror_image-927"><a href="#mirror_image-927"><span class="linenos">927</span></a><span class="sd">        Image to mirror.</span>
</span><span id="mirror_image-928"><a href="#mirror_image-928"><span class="linenos">928</span></a>
</span><span id="mirror_image-929"><a href="#mirror_image-929"><span class="linenos">929</span></a><span class="sd">    rotate : str</span>
</span><span id="mirror_image-930"><a href="#mirror_image-930"><span class="linenos">930</span></a><span class="sd">        Type of mirroring to apply. Options:</span>
</span><span id="mirror_image-931"><a href="#mirror_image-931"><span class="linenos">931</span></a><span class="sd">            &#39;h&#39;  - horizontal mirroring</span>
</span><span id="mirror_image-932"><a href="#mirror_image-932"><span class="linenos">932</span></a><span class="sd">            &#39;v&#39;  - vertical mirroring</span>
</span><span id="mirror_image-933"><a href="#mirror_image-933"><span class="linenos">933</span></a><span class="sd">            &#39;hv&#39; - both horizontal and vertical mirroring</span>
</span><span id="mirror_image-934"><a href="#mirror_image-934"><span class="linenos">934</span></a>
</span><span id="mirror_image-935"><a href="#mirror_image-935"><span class="linenos">935</span></a><span class="sd">    Returns</span>
</span><span id="mirror_image-936"><a href="#mirror_image-936"><span class="linenos">936</span></a><span class="sd">    -------</span>
</span><span id="mirror_image-937"><a href="#mirror_image-937"><span class="linenos">937</span></a><span class="sd">    np.ndarray</span>
</span><span id="mirror_image-938"><a href="#mirror_image-938"><span class="linenos">938</span></a><span class="sd">        Mirrored image.</span>
</span><span id="mirror_image-939"><a href="#mirror_image-939"><span class="linenos">939</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="mirror_image-940"><a href="#mirror_image-940"><span class="linenos">940</span></a>
</span><span id="mirror_image-941"><a href="#mirror_image-941"><span class="linenos">941</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="mirror_image-942"><a href="#mirror_image-942"><span class="linenos">942</span></a>
</span><span id="mirror_image-943"><a href="#mirror_image-943"><span class="linenos">943</span></a>        <span class="k">if</span> <span class="n">rotate</span> <span class="o">==</span> <span class="s2">&quot;h&quot;</span><span class="p">:</span>
</span><span id="mirror_image-944"><a href="#mirror_image-944"><span class="linenos">944</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="mirror_image-945"><a href="#mirror_image-945"><span class="linenos">945</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="s2">&quot;v&quot;</span><span class="p">:</span>
</span><span id="mirror_image-946"><a href="#mirror_image-946"><span class="linenos">946</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</span><span id="mirror_image-947"><a href="#mirror_image-947"><span class="linenos">947</span></a>        <span class="k">elif</span> <span class="n">rotate</span> <span class="o">==</span> <span class="s2">&quot;hv&quot;</span><span class="p">:</span>
</span><span id="mirror_image-948"><a href="#mirror_image-948"><span class="linenos">948</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()))</span>
</span><span id="mirror_image-949"><a href="#mirror_image-949"><span class="linenos">949</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="mirror_image-950"><a href="#mirror_image-950"><span class="linenos">950</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrong argument - rotate!&quot;</span><span class="p">)</span>
</span><span id="mirror_image-951"><a href="#mirror_image-951"><span class="linenos">951</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="mirror_image-952"><a href="#mirror_image-952"><span class="linenos">952</span></a>
</span><span id="mirror_image-953"><a href="#mirror_image-953"><span class="linenos">953</span></a>        <span class="k">return</span> <span class="n">img</span>
</span><span id="mirror_image-954"><a href="#mirror_image-954"><span class="linenos">954</span></a>
</span><span id="mirror_image-955"><a href="#mirror_image-955"><span class="linenos">955</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="mirror_image-956"><a href="#mirror_image-956"><span class="linenos">956</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Mirror an image along specified axes.</p>

<h2 id="parameters">Parameters</h2>

<p>img : np.ndarray
    Image to mirror.</p>

<p>rotate : str
    Type of mirroring to apply. Options:
        'h'  - horizontal mirroring
        'v'  - vertical mirroring
        'hv' - both horizontal and vertical mirroring</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Mirrored image.</p>
</div>


                </section>
                <section id="merge_images">
                            <input id="merge_images-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">merge_images</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image_list</span><span class="p">:</span> <span class="nb">list</span>, </span><span class="param"><span class="n">intensity_factors</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="merge_images-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#merge_images"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="merge_images-962"><a href="#merge_images-962"><span class="linenos"> 962</span></a><span class="k">def</span><span class="w"> </span><span class="nf">merge_images</span><span class="p">(</span><span class="n">image_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">intensity_factors</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]):</span>
</span><span id="merge_images-963"><a href="#merge_images-963"><span class="linenos"> 963</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="merge_images-964"><a href="#merge_images-964"><span class="linenos"> 964</span></a><span class="sd">    Merge multiple image projections from different channels.</span>
</span><span id="merge_images-965"><a href="#merge_images-965"><span class="linenos"> 965</span></a>
</span><span id="merge_images-966"><a href="#merge_images-966"><span class="linenos"> 966</span></a><span class="sd">    Parameters</span>
</span><span id="merge_images-967"><a href="#merge_images-967"><span class="linenos"> 967</span></a><span class="sd">    ----------</span>
</span><span id="merge_images-968"><a href="#merge_images-968"><span class="linenos"> 968</span></a><span class="sd">    image_list : list of np.ndarray</span>
</span><span id="merge_images-969"><a href="#merge_images-969"><span class="linenos"> 969</span></a><span class="sd">        List of images to merge. All images must have the same shape and size.</span>
</span><span id="merge_images-970"><a href="#merge_images-970"><span class="linenos"> 970</span></a>
</span><span id="merge_images-971"><a href="#merge_images-971"><span class="linenos"> 971</span></a><span class="sd">    intensity_factors : list of float</span>
</span><span id="merge_images-972"><a href="#merge_images-972"><span class="linenos"> 972</span></a><span class="sd">        Intensity scaling factors for each image in `image_list`. Base value is 1.</span>
</span><span id="merge_images-973"><a href="#merge_images-973"><span class="linenos"> 973</span></a><span class="sd">            - Values &lt; 1 decrease intensity.</span>
</span><span id="merge_images-974"><a href="#merge_images-974"><span class="linenos"> 974</span></a><span class="sd">            - Values &gt; 1 increase intensity.</span>
</span><span id="merge_images-975"><a href="#merge_images-975"><span class="linenos"> 975</span></a>
</span><span id="merge_images-976"><a href="#merge_images-976"><span class="linenos"> 976</span></a><span class="sd">    Returns</span>
</span><span id="merge_images-977"><a href="#merge_images-977"><span class="linenos"> 977</span></a><span class="sd">    -------</span>
</span><span id="merge_images-978"><a href="#merge_images-978"><span class="linenos"> 978</span></a><span class="sd">    np.ndarray</span>
</span><span id="merge_images-979"><a href="#merge_images-979"><span class="linenos"> 979</span></a><span class="sd">        Merged image after applying intensity scaling.</span>
</span><span id="merge_images-980"><a href="#merge_images-980"><span class="linenos"> 980</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="merge_images-981"><a href="#merge_images-981"><span class="linenos"> 981</span></a>
</span><span id="merge_images-982"><a href="#merge_images-982"><span class="linenos"> 982</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="merge_images-983"><a href="#merge_images-983"><span class="linenos"> 983</span></a>
</span><span id="merge_images-984"><a href="#merge_images-984"><span class="linenos"> 984</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="merge_images-985"><a href="#merge_images-985"><span class="linenos"> 985</span></a>
</span><span id="merge_images-986"><a href="#merge_images-986"><span class="linenos"> 986</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity_factors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="merge_images-987"><a href="#merge_images-987"><span class="linenos"> 987</span></a>
</span><span id="merge_images-988"><a href="#merge_images-988"><span class="linenos"> 988</span></a>            <span class="n">intensity_factors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="merge_images-989"><a href="#merge_images-989"><span class="linenos"> 989</span></a>            <span class="k">for</span> <span class="n">bt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">)):</span>
</span><span id="merge_images-990"><a href="#merge_images-990"><span class="linenos"> 990</span></a>                <span class="n">intensity_factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span id="merge_images-991"><a href="#merge_images-991"><span class="linenos"> 991</span></a>
</span><span id="merge_images-992"><a href="#merge_images-992"><span class="linenos"> 992</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_list</span><span class="p">):</span>
</span><span id="merge_images-993"><a href="#merge_images-993"><span class="linenos"> 993</span></a>            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="merge_images-994"><a href="#merge_images-994"><span class="linenos"> 994</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span> <span class="o">*</span> <span class="n">intensity_factors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="merge_images-995"><a href="#merge_images-995"><span class="linenos"> 995</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="merge_images-996"><a href="#merge_images-996"><span class="linenos"> 996</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span>
</span><span id="merge_images-997"><a href="#merge_images-997"><span class="linenos"> 997</span></a>                    <span class="n">result</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span> <span class="o">*</span> <span class="n">intensity_factors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
</span><span id="merge_images-998"><a href="#merge_images-998"><span class="linenos"> 998</span></a>                <span class="p">)</span>
</span><span id="merge_images-999"><a href="#merge_images-999"><span class="linenos"> 999</span></a>
</span><span id="merge_images-1000"><a href="#merge_images-1000"><span class="linenos">1000</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="merge_images-1001"><a href="#merge_images-1001"><span class="linenos">1001</span></a>
</span><span id="merge_images-1002"><a href="#merge_images-1002"><span class="linenos">1002</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="merge_images-1003"><a href="#merge_images-1003"><span class="linenos">1003</span></a>
</span><span id="merge_images-1004"><a href="#merge_images-1004"><span class="linenos">1004</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="merge_images-1005"><a href="#merge_images-1005"><span class="linenos">1005</span></a>
</span><span id="merge_images-1006"><a href="#merge_images-1006"><span class="linenos">1006</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="merge_images-1007"><a href="#merge_images-1007"><span class="linenos">1007</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Merge multiple image projections from different channels.</p>

<h2 id="parameters">Parameters</h2>

<p>image_list : list of np.ndarray
    List of images to merge. All images must have the same shape and size.</p>

<p>intensity_factors : list of float
    Intensity scaling factors for each image in <code>image_list</code>. Base value is 1.
        - Values &lt; 1 decrease intensity.
        - Values &gt; 1 increase intensity.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Merged image after applying intensity scaling.</p>
</div>


                </section>
                <section id="adjust_img_16bit">
                            <input id="adjust_img_16bit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">adjust_img_16bit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">img</span>,</span><span class="param">	<span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span>,</span><span class="param">	<span class="n">max_intensity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span>,</span><span class="param">	<span class="n">min_intenisty</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">brightness</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>,</span><span class="param">	<span class="n">contrast</span><span class="o">=</span><span class="mf">1.0</span>,</span><span class="param">	<span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="adjust_img_16bit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#adjust_img_16bit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="adjust_img_16bit-1010"><a href="#adjust_img_16bit-1010"><span class="linenos">1010</span></a><span class="k">def</span><span class="w"> </span><span class="nf">adjust_img_16bit</span><span class="p">(</span>
</span><span id="adjust_img_16bit-1011"><a href="#adjust_img_16bit-1011"><span class="linenos">1011</span></a>    <span class="n">img</span><span class="p">,</span>
</span><span id="adjust_img_16bit-1012"><a href="#adjust_img_16bit-1012"><span class="linenos">1012</span></a>    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
</span><span id="adjust_img_16bit-1013"><a href="#adjust_img_16bit-1013"><span class="linenos">1013</span></a>    <span class="n">max_intensity</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
</span><span id="adjust_img_16bit-1014"><a href="#adjust_img_16bit-1014"><span class="linenos">1014</span></a>    <span class="n">min_intenisty</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="adjust_img_16bit-1015"><a href="#adjust_img_16bit-1015"><span class="linenos">1015</span></a>    <span class="n">brightness</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
</span><span id="adjust_img_16bit-1016"><a href="#adjust_img_16bit-1016"><span class="linenos">1016</span></a>    <span class="n">contrast</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="adjust_img_16bit-1017"><a href="#adjust_img_16bit-1017"><span class="linenos">1017</span></a>    <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
</span><span id="adjust_img_16bit-1018"><a href="#adjust_img_16bit-1018"><span class="linenos">1018</span></a><span class="p">):</span>
</span><span id="adjust_img_16bit-1019"><a href="#adjust_img_16bit-1019"><span class="linenos">1019</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="adjust_img_16bit-1020"><a href="#adjust_img_16bit-1020"><span class="linenos">1020</span></a><span class="sd">    Manually adjust image parameters and return the adjusted image.</span>
</span><span id="adjust_img_16bit-1021"><a href="#adjust_img_16bit-1021"><span class="linenos">1021</span></a>
</span><span id="adjust_img_16bit-1022"><a href="#adjust_img_16bit-1022"><span class="linenos">1022</span></a><span class="sd">    Parameters</span>
</span><span id="adjust_img_16bit-1023"><a href="#adjust_img_16bit-1023"><span class="linenos">1023</span></a><span class="sd">    ----------</span>
</span><span id="adjust_img_16bit-1024"><a href="#adjust_img_16bit-1024"><span class="linenos">1024</span></a><span class="sd">    img : np.ndarray</span>
</span><span id="adjust_img_16bit-1025"><a href="#adjust_img_16bit-1025"><span class="linenos">1025</span></a><span class="sd">        Input image.</span>
</span><span id="adjust_img_16bit-1026"><a href="#adjust_img_16bit-1026"><span class="linenos">1026</span></a>
</span><span id="adjust_img_16bit-1027"><a href="#adjust_img_16bit-1027"><span class="linenos">1027</span></a><span class="sd">    color : str</span>
</span><span id="adjust_img_16bit-1028"><a href="#adjust_img_16bit-1028"><span class="linenos">1028</span></a><span class="sd">        Image color channel. Options: [&#39;green&#39;, &#39;blue&#39;, &#39;red&#39;, &#39;yellow&#39;, &#39;magenta&#39;, &#39;cyan&#39;].</span>
</span><span id="adjust_img_16bit-1029"><a href="#adjust_img_16bit-1029"><span class="linenos">1029</span></a>
</span><span id="adjust_img_16bit-1030"><a href="#adjust_img_16bit-1030"><span class="linenos">1030</span></a><span class="sd">    max_intensity : int</span>
</span><span id="adjust_img_16bit-1031"><a href="#adjust_img_16bit-1031"><span class="linenos">1031</span></a><span class="sd">        Upper threshold for pixel values. Pixels exceeding this value are set to `max_intensity`.</span>
</span><span id="adjust_img_16bit-1032"><a href="#adjust_img_16bit-1032"><span class="linenos">1032</span></a>
</span><span id="adjust_img_16bit-1033"><a href="#adjust_img_16bit-1033"><span class="linenos">1033</span></a><span class="sd">    min_intensity : int</span>
</span><span id="adjust_img_16bit-1034"><a href="#adjust_img_16bit-1034"><span class="linenos">1034</span></a><span class="sd">        Lower threshold for pixel values. Pixels below this value are set to 0.</span>
</span><span id="adjust_img_16bit-1035"><a href="#adjust_img_16bit-1035"><span class="linenos">1035</span></a>
</span><span id="adjust_img_16bit-1036"><a href="#adjust_img_16bit-1036"><span class="linenos">1036</span></a><span class="sd">    brightness : int, optional</span>
</span><span id="adjust_img_16bit-1037"><a href="#adjust_img_16bit-1037"><span class="linenos">1037</span></a><span class="sd">        Image brightness adjustment. Typical range: [900-2000]. Default is 1000.</span>
</span><span id="adjust_img_16bit-1038"><a href="#adjust_img_16bit-1038"><span class="linenos">1038</span></a>
</span><span id="adjust_img_16bit-1039"><a href="#adjust_img_16bit-1039"><span class="linenos">1039</span></a><span class="sd">    contrast : float or int, optional</span>
</span><span id="adjust_img_16bit-1040"><a href="#adjust_img_16bit-1040"><span class="linenos">1040</span></a><span class="sd">        Image contrast adjustment. Typical range: [0-5]. Default is 1.</span>
</span><span id="adjust_img_16bit-1041"><a href="#adjust_img_16bit-1041"><span class="linenos">1041</span></a>
</span><span id="adjust_img_16bit-1042"><a href="#adjust_img_16bit-1042"><span class="linenos">1042</span></a><span class="sd">    gamma : float or int, optional</span>
</span><span id="adjust_img_16bit-1043"><a href="#adjust_img_16bit-1043"><span class="linenos">1043</span></a><span class="sd">        Gamma correction factor. Typical range: [0-5]. Default is 1.</span>
</span><span id="adjust_img_16bit-1044"><a href="#adjust_img_16bit-1044"><span class="linenos">1044</span></a>
</span><span id="adjust_img_16bit-1045"><a href="#adjust_img_16bit-1045"><span class="linenos">1045</span></a><span class="sd">    Returns</span>
</span><span id="adjust_img_16bit-1046"><a href="#adjust_img_16bit-1046"><span class="linenos">1046</span></a><span class="sd">    -------</span>
</span><span id="adjust_img_16bit-1047"><a href="#adjust_img_16bit-1047"><span class="linenos">1047</span></a><span class="sd">    np.ndarray</span>
</span><span id="adjust_img_16bit-1048"><a href="#adjust_img_16bit-1048"><span class="linenos">1048</span></a><span class="sd">        Adjusted image after applying brightness, contrast, gamma, and intensity thresholds.</span>
</span><span id="adjust_img_16bit-1049"><a href="#adjust_img_16bit-1049"><span class="linenos">1049</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="adjust_img_16bit-1050"><a href="#adjust_img_16bit-1050"><span class="linenos">1050</span></a>
</span><span id="adjust_img_16bit-1051"><a href="#adjust_img_16bit-1051"><span class="linenos">1051</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1052"><a href="#adjust_img_16bit-1052"><span class="linenos">1052</span></a>
</span><span id="adjust_img_16bit-1053"><a href="#adjust_img_16bit-1053"><span class="linenos">1053</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="adjust_img_16bit-1054"><a href="#adjust_img_16bit-1054"><span class="linenos">1054</span></a>
</span><span id="adjust_img_16bit-1055"><a href="#adjust_img_16bit-1055"><span class="linenos">1055</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1056"><a href="#adjust_img_16bit-1056"><span class="linenos">1056</span></a>
</span><span id="adjust_img_16bit-1057"><a href="#adjust_img_16bit-1057"><span class="linenos">1057</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1058"><a href="#adjust_img_16bit-1058"><span class="linenos">1058</span></a>
</span><span id="adjust_img_16bit-1059"><a href="#adjust_img_16bit-1059"><span class="linenos">1059</span></a>        <span class="c1"># brightness</span>
</span><span id="adjust_img_16bit-1060"><a href="#adjust_img_16bit-1060"><span class="linenos">1060</span></a>        <span class="k">if</span> <span class="n">brightness</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1061"><a href="#adjust_img_16bit-1061"><span class="linenos">1061</span></a>            <span class="n">factor</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">brightness</span>
</span><span id="adjust_img_16bit-1062"><a href="#adjust_img_16bit-1062"><span class="linenos">1062</span></a>            <span class="n">side</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1063"><a href="#adjust_img_16bit-1063"><span class="linenos">1063</span></a>            <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="n">side</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1064"><a href="#adjust_img_16bit-1064"><span class="linenos">1064</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1065"><a href="#adjust_img_16bit-1065"><span class="linenos">1065</span></a>
</span><span id="adjust_img_16bit-1066"><a href="#adjust_img_16bit-1066"><span class="linenos">1066</span></a>        <span class="c1"># contrast</span>
</span><span id="adjust_img_16bit-1067"><a href="#adjust_img_16bit-1067"><span class="linenos">1067</span></a>        <span class="k">if</span> <span class="n">contrast</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1068"><a href="#adjust_img_16bit-1068"><span class="linenos">1068</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">))</span> <span class="o">*</span> <span class="n">contrast</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1069"><a href="#adjust_img_16bit-1069"><span class="linenos">1069</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1070"><a href="#adjust_img_16bit-1070"><span class="linenos">1070</span></a>
</span><span id="adjust_img_16bit-1071"><a href="#adjust_img_16bit-1071"><span class="linenos">1071</span></a>        <span class="c1"># gamma</span>
</span><span id="adjust_img_16bit-1072"><a href="#adjust_img_16bit-1072"><span class="linenos">1072</span></a>        <span class="k">if</span> <span class="n">gamma</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1073"><a href="#adjust_img_16bit-1073"><span class="linenos">1073</span></a>
</span><span id="adjust_img_16bit-1074"><a href="#adjust_img_16bit-1074"><span class="linenos">1074</span></a>            <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1075"><a href="#adjust_img_16bit-1075"><span class="linenos">1075</span></a>
</span><span id="adjust_img_16bit-1076"><a href="#adjust_img_16bit-1076"><span class="linenos">1076</span></a>            <span class="n">image_array</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">/</span> <span class="n">max_val</span>
</span><span id="adjust_img_16bit-1077"><a href="#adjust_img_16bit-1077"><span class="linenos">1077</span></a>
</span><span id="adjust_img_16bit-1078"><a href="#adjust_img_16bit-1078"><span class="linenos">1078</span></a>            <span class="n">image_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">image_array</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1079"><a href="#adjust_img_16bit-1079"><span class="linenos">1079</span></a>
</span><span id="adjust_img_16bit-1080"><a href="#adjust_img_16bit-1080"><span class="linenos">1080</span></a>            <span class="n">corrected_array</span> <span class="o">=</span> <span class="n">image_array</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1081"><a href="#adjust_img_16bit-1081"><span class="linenos">1081</span></a>
</span><span id="adjust_img_16bit-1082"><a href="#adjust_img_16bit-1082"><span class="linenos">1082</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">corrected_array</span> <span class="o">*</span> <span class="n">max_val</span>
</span><span id="adjust_img_16bit-1083"><a href="#adjust_img_16bit-1083"><span class="linenos">1083</span></a>
</span><span id="adjust_img_16bit-1084"><a href="#adjust_img_16bit-1084"><span class="linenos">1084</span></a>            <span class="k">del</span> <span class="n">image_array</span><span class="p">,</span> <span class="n">corrected_array</span>
</span><span id="adjust_img_16bit-1085"><a href="#adjust_img_16bit-1085"><span class="linenos">1085</span></a>
</span><span id="adjust_img_16bit-1086"><a href="#adjust_img_16bit-1086"><span class="linenos">1086</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1087"><a href="#adjust_img_16bit-1087"><span class="linenos">1087</span></a>
</span><span id="adjust_img_16bit-1088"><a href="#adjust_img_16bit-1088"><span class="linenos">1088</span></a>        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mi">65535</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1089"><a href="#adjust_img_16bit-1089"><span class="linenos">1089</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1090"><a href="#adjust_img_16bit-1090"><span class="linenos">1090</span></a>        <span class="k">if</span> <span class="n">max_val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1091"><a href="#adjust_img_16bit-1091"><span class="linenos">1091</span></a>            <span class="n">img</span> <span class="o">=</span> <span class="p">((</span><span class="n">img</span> <span class="o">/</span> <span class="n">max_val</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65535</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1092"><a href="#adjust_img_16bit-1092"><span class="linenos">1092</span></a>
</span><span id="adjust_img_16bit-1093"><a href="#adjust_img_16bit-1093"><span class="linenos">1093</span></a>        <span class="c1"># max intenisty</span>
</span><span id="adjust_img_16bit-1094"><a href="#adjust_img_16bit-1094"><span class="linenos">1094</span></a>        <span class="k">if</span> <span class="n">max_intensity</span> <span class="o">!=</span> <span class="mi">65535</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1095"><a href="#adjust_img_16bit-1095"><span class="linenos">1095</span></a>            <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&gt;=</span> <span class="n">max_intensity</span><span class="p">]</span> <span class="o">=</span> <span class="mi">65535</span>
</span><span id="adjust_img_16bit-1096"><a href="#adjust_img_16bit-1096"><span class="linenos">1096</span></a>
</span><span id="adjust_img_16bit-1097"><a href="#adjust_img_16bit-1097"><span class="linenos">1097</span></a>        <span class="c1"># min intenisty</span>
</span><span id="adjust_img_16bit-1098"><a href="#adjust_img_16bit-1098"><span class="linenos">1098</span></a>        <span class="k">if</span> <span class="n">min_intenisty</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1099"><a href="#adjust_img_16bit-1099"><span class="linenos">1099</span></a>            <span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">&lt;=</span> <span class="n">min_intenisty</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="adjust_img_16bit-1100"><a href="#adjust_img_16bit-1100"><span class="linenos">1100</span></a>
</span><span id="adjust_img_16bit-1101"><a href="#adjust_img_16bit-1101"><span class="linenos">1101</span></a>        <span class="n">img_gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
</span><span id="adjust_img_16bit-1102"><a href="#adjust_img_16bit-1102"><span class="linenos">1102</span></a>
</span><span id="adjust_img_16bit-1103"><a href="#adjust_img_16bit-1103"><span class="linenos">1103</span></a>        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;green&quot;</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1104"><a href="#adjust_img_16bit-1104"><span class="linenos">1104</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1105"><a href="#adjust_img_16bit-1105"><span class="linenos">1105</span></a>
</span><span id="adjust_img_16bit-1106"><a href="#adjust_img_16bit-1106"><span class="linenos">1106</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;red&quot;</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1107"><a href="#adjust_img_16bit-1107"><span class="linenos">1107</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1108"><a href="#adjust_img_16bit-1108"><span class="linenos">1108</span></a>
</span><span id="adjust_img_16bit-1109"><a href="#adjust_img_16bit-1109"><span class="linenos">1109</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;blue&quot;</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1110"><a href="#adjust_img_16bit-1110"><span class="linenos">1110</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1111"><a href="#adjust_img_16bit-1111"><span class="linenos">1111</span></a>
</span><span id="adjust_img_16bit-1112"><a href="#adjust_img_16bit-1112"><span class="linenos">1112</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;magenta&quot;</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1113"><a href="#adjust_img_16bit-1113"><span class="linenos">1113</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1114"><a href="#adjust_img_16bit-1114"><span class="linenos">1114</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1115"><a href="#adjust_img_16bit-1115"><span class="linenos">1115</span></a>
</span><span id="adjust_img_16bit-1116"><a href="#adjust_img_16bit-1116"><span class="linenos">1116</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;yellow&quot;</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1117"><a href="#adjust_img_16bit-1117"><span class="linenos">1117</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1118"><a href="#adjust_img_16bit-1118"><span class="linenos">1118</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1119"><a href="#adjust_img_16bit-1119"><span class="linenos">1119</span></a>
</span><span id="adjust_img_16bit-1120"><a href="#adjust_img_16bit-1120"><span class="linenos">1120</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;cyan&quot;</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1121"><a href="#adjust_img_16bit-1121"><span class="linenos">1121</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1122"><a href="#adjust_img_16bit-1122"><span class="linenos">1122</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1123"><a href="#adjust_img_16bit-1123"><span class="linenos">1123</span></a>
</span><span id="adjust_img_16bit-1124"><a href="#adjust_img_16bit-1124"><span class="linenos">1124</span></a>        <span class="k">elif</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;gray&quot;</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1125"><a href="#adjust_img_16bit-1125"><span class="linenos">1125</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1126"><a href="#adjust_img_16bit-1126"><span class="linenos">1126</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1127"><a href="#adjust_img_16bit-1127"><span class="linenos">1127</span></a>            <span class="n">img_gamma</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
</span><span id="adjust_img_16bit-1128"><a href="#adjust_img_16bit-1128"><span class="linenos">1128</span></a>
</span><span id="adjust_img_16bit-1129"><a href="#adjust_img_16bit-1129"><span class="linenos">1129</span></a>        <span class="k">return</span> <span class="n">img_gamma</span>
</span><span id="adjust_img_16bit-1130"><a href="#adjust_img_16bit-1130"><span class="linenos">1130</span></a>
</span><span id="adjust_img_16bit-1131"><a href="#adjust_img_16bit-1131"><span class="linenos">1131</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="adjust_img_16bit-1132"><a href="#adjust_img_16bit-1132"><span class="linenos">1132</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Manually adjust image parameters and return the adjusted image.</p>

<h2 id="parameters">Parameters</h2>

<p>img : np.ndarray
    Input image.</p>

<p>color : str
    Image color channel. Options: ['green', 'blue', 'red', 'yellow', 'magenta', 'cyan'].</p>

<p>max_intensity : int
    Upper threshold for pixel values. Pixels exceeding this value are set to <code>max_intensity</code>.</p>

<p>min_intensity : int
    Lower threshold for pixel values. Pixels below this value are set to 0.</p>

<p>brightness : int, optional
    Image brightness adjustment. Typical range: [900-2000]. Default is 1000.</p>

<p>contrast : float or int, optional
    Image contrast adjustment. Typical range: [0-5]. Default is 1.</p>

<p>gamma : float or int, optional
    Gamma correction factor. Typical range: [0-5]. Default is 1.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Adjusted image after applying brightness, contrast, gamma, and intensity thresholds.</p>
</div>


                </section>
                <section id="get_screan">
                            <input id="get_screan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_screan</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_screan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_screan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_screan-1135"><a href="#get_screan-1135"><span class="linenos">1135</span></a><span class="k">def</span><span class="w"> </span><span class="nf">get_screan</span><span class="p">():</span>
</span><span id="get_screan-1136"><a href="#get_screan-1136"><span class="linenos">1136</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_screan-1137"><a href="#get_screan-1137"><span class="linenos">1137</span></a><span class="sd">    Get the current screen width and height.</span>
</span><span id="get_screan-1138"><a href="#get_screan-1138"><span class="linenos">1138</span></a>
</span><span id="get_screan-1139"><a href="#get_screan-1139"><span class="linenos">1139</span></a><span class="sd">    Returns</span>
</span><span id="get_screan-1140"><a href="#get_screan-1140"><span class="linenos">1140</span></a><span class="sd">    -------</span>
</span><span id="get_screan-1141"><a href="#get_screan-1141"><span class="linenos">1141</span></a><span class="sd">    tuple of int</span>
</span><span id="get_screan-1142"><a href="#get_screan-1142"><span class="linenos">1142</span></a><span class="sd">        screen_width, screen_height</span>
</span><span id="get_screan-1143"><a href="#get_screan-1143"><span class="linenos">1143</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_screan-1144"><a href="#get_screan-1144"><span class="linenos">1144</span></a>
</span><span id="get_screan-1145"><a href="#get_screan-1145"><span class="linenos">1145</span></a>    <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
</span><span id="get_screan-1146"><a href="#get_screan-1146"><span class="linenos">1146</span></a>    <span class="n">screen_width</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenwidth</span><span class="p">()</span>
</span><span id="get_screan-1147"><a href="#get_screan-1147"><span class="linenos">1147</span></a>    <span class="n">screen_height</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenheight</span><span class="p">()</span>
</span><span id="get_screan-1148"><a href="#get_screan-1148"><span class="linenos">1148</span></a>
</span><span id="get_screan-1149"><a href="#get_screan-1149"><span class="linenos">1149</span></a>    <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="get_screan-1150"><a href="#get_screan-1150"><span class="linenos">1150</span></a>
</span><span id="get_screan-1151"><a href="#get_screan-1151"><span class="linenos">1151</span></a>    <span class="k">return</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span>
</span></pre></div>


            <div class="docstring"><p>Get the current screen width and height.</p>

<h2 id="returns">Returns</h2>

<p>tuple of int
    screen_width, screen_height</p>
</div>


                </section>
                <section id="resize_to_screen_img">
                            <input id="resize_to_screen_img-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">resize_to_screen_img</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">img_file</span>, </span><span class="param"><span class="n">factor</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="resize_to_screen_img-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#resize_to_screen_img"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="resize_to_screen_img-1154"><a href="#resize_to_screen_img-1154"><span class="linenos">1154</span></a><span class="k">def</span><span class="w"> </span><span class="nf">resize_to_screen_img</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="resize_to_screen_img-1155"><a href="#resize_to_screen_img-1155"><span class="linenos">1155</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="resize_to_screen_img-1156"><a href="#resize_to_screen_img-1156"><span class="linenos">1156</span></a><span class="sd">    Resize an input image to fit the screen size, optionally scaled by a factor.</span>
</span><span id="resize_to_screen_img-1157"><a href="#resize_to_screen_img-1157"><span class="linenos">1157</span></a>
</span><span id="resize_to_screen_img-1158"><a href="#resize_to_screen_img-1158"><span class="linenos">1158</span></a><span class="sd">    Parameters</span>
</span><span id="resize_to_screen_img-1159"><a href="#resize_to_screen_img-1159"><span class="linenos">1159</span></a><span class="sd">    ----------</span>
</span><span id="resize_to_screen_img-1160"><a href="#resize_to_screen_img-1160"><span class="linenos">1160</span></a><span class="sd">    img_file : np.ndarray</span>
</span><span id="resize_to_screen_img-1161"><a href="#resize_to_screen_img-1161"><span class="linenos">1161</span></a><span class="sd">        Input image to be resized.</span>
</span><span id="resize_to_screen_img-1162"><a href="#resize_to_screen_img-1162"><span class="linenos">1162</span></a>
</span><span id="resize_to_screen_img-1163"><a href="#resize_to_screen_img-1163"><span class="linenos">1163</span></a><span class="sd">    factor : float, optional</span>
</span><span id="resize_to_screen_img-1164"><a href="#resize_to_screen_img-1164"><span class="linenos">1164</span></a><span class="sd">        Scaling factor applied to the screen dimensions before resizing the image. Default is 1.</span>
</span><span id="resize_to_screen_img-1165"><a href="#resize_to_screen_img-1165"><span class="linenos">1165</span></a>
</span><span id="resize_to_screen_img-1166"><a href="#resize_to_screen_img-1166"><span class="linenos">1166</span></a><span class="sd">    Returns</span>
</span><span id="resize_to_screen_img-1167"><a href="#resize_to_screen_img-1167"><span class="linenos">1167</span></a><span class="sd">    -------</span>
</span><span id="resize_to_screen_img-1168"><a href="#resize_to_screen_img-1168"><span class="linenos">1168</span></a><span class="sd">    np.ndarray</span>
</span><span id="resize_to_screen_img-1169"><a href="#resize_to_screen_img-1169"><span class="linenos">1169</span></a><span class="sd">        Resized image that fits within the screen dimensions while maintaining aspect ratio.</span>
</span><span id="resize_to_screen_img-1170"><a href="#resize_to_screen_img-1170"><span class="linenos">1170</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="resize_to_screen_img-1171"><a href="#resize_to_screen_img-1171"><span class="linenos">1171</span></a>
</span><span id="resize_to_screen_img-1172"><a href="#resize_to_screen_img-1172"><span class="linenos">1172</span></a>    <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span> <span class="o">=</span> <span class="n">get_screan</span><span class="p">()</span>
</span><span id="resize_to_screen_img-1173"><a href="#resize_to_screen_img-1173"><span class="linenos">1173</span></a>
</span><span id="resize_to_screen_img-1174"><a href="#resize_to_screen_img-1174"><span class="linenos">1174</span></a>    <span class="n">screen_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="resize_to_screen_img-1175"><a href="#resize_to_screen_img-1175"><span class="linenos">1175</span></a>    <span class="n">screen_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_height</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="resize_to_screen_img-1176"><a href="#resize_to_screen_img-1176"><span class="linenos">1176</span></a>
</span><span id="resize_to_screen_img-1177"><a href="#resize_to_screen_img-1177"><span class="linenos">1177</span></a>    <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="resize_to_screen_img-1178"><a href="#resize_to_screen_img-1178"><span class="linenos">1178</span></a>    <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="resize_to_screen_img-1179"><a href="#resize_to_screen_img-1179"><span class="linenos">1179</span></a>
</span><span id="resize_to_screen_img-1180"><a href="#resize_to_screen_img-1180"><span class="linenos">1180</span></a>    <span class="k">if</span> <span class="n">screen_width</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">:</span>
</span><span id="resize_to_screen_img-1181"><a href="#resize_to_screen_img-1181"><span class="linenos">1181</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="resize_to_screen_img-1182"><a href="#resize_to_screen_img-1182"><span class="linenos">1182</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="resize_to_screen_img-1183"><a href="#resize_to_screen_img-1183"><span class="linenos">1183</span></a>
</span><span id="resize_to_screen_img-1184"><a href="#resize_to_screen_img-1184"><span class="linenos">1184</span></a>        <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="resize_to_screen_img-1185"><a href="#resize_to_screen_img-1185"><span class="linenos">1185</span></a>        <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="resize_to_screen_img-1186"><a href="#resize_to_screen_img-1186"><span class="linenos">1186</span></a>
</span><span id="resize_to_screen_img-1187"><a href="#resize_to_screen_img-1187"><span class="linenos">1187</span></a>        <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="resize_to_screen_img-1188"><a href="#resize_to_screen_img-1188"><span class="linenos">1188</span></a>
</span><span id="resize_to_screen_img-1189"><a href="#resize_to_screen_img-1189"><span class="linenos">1189</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="resize_to_screen_img-1190"><a href="#resize_to_screen_img-1190"><span class="linenos">1190</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="resize_to_screen_img-1191"><a href="#resize_to_screen_img-1191"><span class="linenos">1191</span></a>
</span><span id="resize_to_screen_img-1192"><a href="#resize_to_screen_img-1192"><span class="linenos">1192</span></a>    <span class="k">if</span> <span class="n">screen_height</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
</span><span id="resize_to_screen_img-1193"><a href="#resize_to_screen_img-1193"><span class="linenos">1193</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="resize_to_screen_img-1194"><a href="#resize_to_screen_img-1194"><span class="linenos">1194</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="resize_to_screen_img-1195"><a href="#resize_to_screen_img-1195"><span class="linenos">1195</span></a>
</span><span id="resize_to_screen_img-1196"><a href="#resize_to_screen_img-1196"><span class="linenos">1196</span></a>        <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="resize_to_screen_img-1197"><a href="#resize_to_screen_img-1197"><span class="linenos">1197</span></a>        <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="resize_to_screen_img-1198"><a href="#resize_to_screen_img-1198"><span class="linenos">1198</span></a>
</span><span id="resize_to_screen_img-1199"><a href="#resize_to_screen_img-1199"><span class="linenos">1199</span></a>        <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="resize_to_screen_img-1200"><a href="#resize_to_screen_img-1200"><span class="linenos">1200</span></a>
</span><span id="resize_to_screen_img-1201"><a href="#resize_to_screen_img-1201"><span class="linenos">1201</span></a>    <span class="k">return</span> <span class="n">img_file</span>
</span></pre></div>


            <div class="docstring"><p>Resize an input image to fit the screen size, optionally scaled by a factor.</p>

<h2 id="parameters">Parameters</h2>

<p>img_file : np.ndarray
    Input image to be resized.</p>

<p>factor : float, optional
    Scaling factor applied to the screen dimensions before resizing the image. Default is 1.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Resized image that fits within the screen dimensions while maintaining aspect ratio.</p>
</div>


                </section>
                <section id="display_preview">
                            <input id="display_preview-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">display_preview</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="display_preview-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#display_preview"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="display_preview-1204"><a href="#display_preview-1204"><span class="linenos">1204</span></a><span class="k">def</span><span class="w"> </span><span class="nf">display_preview</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
</span><span id="display_preview-1205"><a href="#display_preview-1205"><span class="linenos">1205</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="display_preview-1206"><a href="#display_preview-1206"><span class="linenos">1206</span></a><span class="sd">    Quickly preview an image using a display window.</span>
</span><span id="display_preview-1207"><a href="#display_preview-1207"><span class="linenos">1207</span></a>
</span><span id="display_preview-1208"><a href="#display_preview-1208"><span class="linenos">1208</span></a><span class="sd">    Parameters</span>
</span><span id="display_preview-1209"><a href="#display_preview-1209"><span class="linenos">1209</span></a><span class="sd">    ----------</span>
</span><span id="display_preview-1210"><a href="#display_preview-1210"><span class="linenos">1210</span></a><span class="sd">    image : np.ndarray</span>
</span><span id="display_preview-1211"><a href="#display_preview-1211"><span class="linenos">1211</span></a><span class="sd">        Input image to be displayed.</span>
</span><span id="display_preview-1212"><a href="#display_preview-1212"><span class="linenos">1212</span></a>
</span><span id="display_preview-1213"><a href="#display_preview-1213"><span class="linenos">1213</span></a><span class="sd">    Notes</span>
</span><span id="display_preview-1214"><a href="#display_preview-1214"><span class="linenos">1214</span></a><span class="sd">    -----</span>
</span><span id="display_preview-1215"><a href="#display_preview-1215"><span class="linenos">1215</span></a><span class="sd">        The function displays the image in a window. Does not return a value.</span>
</span><span id="display_preview-1216"><a href="#display_preview-1216"><span class="linenos">1216</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="display_preview-1217"><a href="#display_preview-1217"><span class="linenos">1217</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="display_preview-1218"><a href="#display_preview-1218"><span class="linenos">1218</span></a>
</span><span id="display_preview-1219"><a href="#display_preview-1219"><span class="linenos">1219</span></a>        <span class="n">res_sc</span> <span class="o">=</span> <span class="n">resize_to_screen_img</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
</span><span id="display_preview-1220"><a href="#display_preview-1220"><span class="linenos">1220</span></a>
</span><span id="display_preview-1221"><a href="#display_preview-1221"><span class="linenos">1221</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;Display&quot;</span><span class="p">,</span> <span class="n">res_sc</span><span class="p">)</span>
</span><span id="display_preview-1222"><a href="#display_preview-1222"><span class="linenos">1222</span></a>
</span><span id="display_preview-1223"><a href="#display_preview-1223"><span class="linenos">1223</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
</span><span id="display_preview-1224"><a href="#display_preview-1224"><span class="linenos">1224</span></a>
</span><span id="display_preview-1225"><a href="#display_preview-1225"><span class="linenos">1225</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
</span><span id="display_preview-1226"><a href="#display_preview-1226"><span class="linenos">1226</span></a>
</span><span id="display_preview-1227"><a href="#display_preview-1227"><span class="linenos">1227</span></a>    <span class="k">except</span><span class="p">:</span>
</span><span id="display_preview-1228"><a href="#display_preview-1228"><span class="linenos">1228</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Check the function input data and try again!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Quickly preview an image using a display window.</p>

<h2 id="parameters">Parameters</h2>

<p>image : np.ndarray
    Input image to be displayed.</p>

<h2 id="notes">Notes</h2>

<pre><code>The function displays the image in a window. Does not return a value.
</code></pre>
</div>


                </section>
                <section id="ImageTools">
                            <input id="ImageTools-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ImageTools</span>:

                <label class="view-source-button" for="ImageTools-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools-1234"><a href="#ImageTools-1234"><span class="linenos">1234</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ImageTools</span><span class="p">:</span>
</span><span id="ImageTools-1235"><a href="#ImageTools-1235"><span class="linenos">1235</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1236"><a href="#ImageTools-1236"><span class="linenos">1236</span></a><span class="sd">    Collection of utility functions for image preprocessing, adjustment,</span>
</span><span id="ImageTools-1237"><a href="#ImageTools-1237"><span class="linenos">1237</span></a><span class="sd">    merging, and stitching.</span>
</span><span id="ImageTools-1238"><a href="#ImageTools-1238"><span class="linenos">1238</span></a>
</span><span id="ImageTools-1239"><a href="#ImageTools-1239"><span class="linenos">1239</span></a><span class="sd">    This class provides standalone static methods for operations such as</span>
</span><span id="ImageTools-1240"><a href="#ImageTools-1240"><span class="linenos">1240</span></a><span class="sd">    histogram equalization, CLAHE enhancement, intensity adjustments,</span>
</span><span id="ImageTools-1241"><a href="#ImageTools-1241"><span class="linenos">1241</span></a><span class="sd">    image merging based on weighted ratios, and horizontal stitching.</span>
</span><span id="ImageTools-1242"><a href="#ImageTools-1242"><span class="linenos">1242</span></a><span class="sd">    These tools are used internally by `ImagesManagement` but can also be</span>
</span><span id="ImageTools-1243"><a href="#ImageTools-1243"><span class="linenos">1243</span></a><span class="sd">    applied independently for generic image-processing workflows.</span>
</span><span id="ImageTools-1244"><a href="#ImageTools-1244"><span class="linenos">1244</span></a>
</span><span id="ImageTools-1245"><a href="#ImageTools-1245"><span class="linenos">1245</span></a><span class="sd">    Notes</span>
</span><span id="ImageTools-1246"><a href="#ImageTools-1246"><span class="linenos">1246</span></a><span class="sd">    -----</span>
</span><span id="ImageTools-1247"><a href="#ImageTools-1247"><span class="linenos">1247</span></a><span class="sd">    All methods operate on NumPy arrays and expect images in standard</span>
</span><span id="ImageTools-1248"><a href="#ImageTools-1248"><span class="linenos">1248</span></a><span class="sd">    OpenCV format. Some functions assume 16-bit images unless stated</span>
</span><span id="ImageTools-1249"><a href="#ImageTools-1249"><span class="linenos">1249</span></a><span class="sd">    otherwise.</span>
</span><span id="ImageTools-1250"><a href="#ImageTools-1250"><span class="linenos">1250</span></a>
</span><span id="ImageTools-1251"><a href="#ImageTools-1251"><span class="linenos">1251</span></a><span class="sd">    Examples</span>
</span><span id="ImageTools-1252"><a href="#ImageTools-1252"><span class="linenos">1252</span></a><span class="sd">    --------</span>
</span><span id="ImageTools-1253"><a href="#ImageTools-1253"><span class="linenos">1253</span></a><span class="sd">    &gt;&gt;&gt; from ImageTools import ImageTools</span>
</span><span id="ImageTools-1254"><a href="#ImageTools-1254"><span class="linenos">1254</span></a><span class="sd">    &gt;&gt;&gt; img = ImageTools.equalize_hist_16bit(img)</span>
</span><span id="ImageTools-1255"><a href="#ImageTools-1255"><span class="linenos">1255</span></a><span class="sd">    &gt;&gt;&gt; merged = ImageTools.merge_images([img1, img2], [0.5, 0.5])</span>
</span><span id="ImageTools-1256"><a href="#ImageTools-1256"><span class="linenos">1256</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ImageTools-1257"><a href="#ImageTools-1257"><span class="linenos">1257</span></a>
</span><span id="ImageTools-1258"><a href="#ImageTools-1258"><span class="linenos">1258</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_screan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ImageTools-1259"><a href="#ImageTools-1259"><span class="linenos">1259</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1260"><a href="#ImageTools-1260"><span class="linenos">1260</span></a><span class="sd">        Return the current screen size.</span>
</span><span id="ImageTools-1261"><a href="#ImageTools-1261"><span class="linenos">1261</span></a>
</span><span id="ImageTools-1262"><a href="#ImageTools-1262"><span class="linenos">1262</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1263"><a href="#ImageTools-1263"><span class="linenos">1263</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1264"><a href="#ImageTools-1264"><span class="linenos">1264</span></a><span class="sd">        screen_width : int</span>
</span><span id="ImageTools-1265"><a href="#ImageTools-1265"><span class="linenos">1265</span></a><span class="sd">            Width of the screen in pixels.</span>
</span><span id="ImageTools-1266"><a href="#ImageTools-1266"><span class="linenos">1266</span></a>
</span><span id="ImageTools-1267"><a href="#ImageTools-1267"><span class="linenos">1267</span></a><span class="sd">        screen_height : int</span>
</span><span id="ImageTools-1268"><a href="#ImageTools-1268"><span class="linenos">1268</span></a><span class="sd">            Height of the screen in pixels.</span>
</span><span id="ImageTools-1269"><a href="#ImageTools-1269"><span class="linenos">1269</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1270"><a href="#ImageTools-1270"><span class="linenos">1270</span></a>
</span><span id="ImageTools-1271"><a href="#ImageTools-1271"><span class="linenos">1271</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
</span><span id="ImageTools-1272"><a href="#ImageTools-1272"><span class="linenos">1272</span></a>        <span class="n">screen_width</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenwidth</span><span class="p">()</span>
</span><span id="ImageTools-1273"><a href="#ImageTools-1273"><span class="linenos">1273</span></a>        <span class="n">screen_height</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenheight</span><span class="p">()</span>
</span><span id="ImageTools-1274"><a href="#ImageTools-1274"><span class="linenos">1274</span></a>
</span><span id="ImageTools-1275"><a href="#ImageTools-1275"><span class="linenos">1275</span></a>        <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="ImageTools-1276"><a href="#ImageTools-1276"><span class="linenos">1276</span></a>
</span><span id="ImageTools-1277"><a href="#ImageTools-1277"><span class="linenos">1277</span></a>        <span class="k">return</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span>
</span><span id="ImageTools-1278"><a href="#ImageTools-1278"><span class="linenos">1278</span></a>
</span><span id="ImageTools-1279"><a href="#ImageTools-1279"><span class="linenos">1279</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resize_to_screen_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_file</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span id="ImageTools-1280"><a href="#ImageTools-1280"><span class="linenos">1280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1281"><a href="#ImageTools-1281"><span class="linenos">1281</span></a><span class="sd">        Resize an input image to a scaled version of the current screen size.</span>
</span><span id="ImageTools-1282"><a href="#ImageTools-1282"><span class="linenos">1282</span></a>
</span><span id="ImageTools-1283"><a href="#ImageTools-1283"><span class="linenos">1283</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1284"><a href="#ImageTools-1284"><span class="linenos">1284</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1285"><a href="#ImageTools-1285"><span class="linenos">1285</span></a><span class="sd">        img_file : np.ndarray</span>
</span><span id="ImageTools-1286"><a href="#ImageTools-1286"><span class="linenos">1286</span></a><span class="sd">            Input image to be resized.</span>
</span><span id="ImageTools-1287"><a href="#ImageTools-1287"><span class="linenos">1287</span></a>
</span><span id="ImageTools-1288"><a href="#ImageTools-1288"><span class="linenos">1288</span></a><span class="sd">        factor : int</span>
</span><span id="ImageTools-1289"><a href="#ImageTools-1289"><span class="linenos">1289</span></a><span class="sd">            Scaling factor applied to the screen dimensions.</span>
</span><span id="ImageTools-1290"><a href="#ImageTools-1290"><span class="linenos">1290</span></a>
</span><span id="ImageTools-1291"><a href="#ImageTools-1291"><span class="linenos">1291</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1292"><a href="#ImageTools-1292"><span class="linenos">1292</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1293"><a href="#ImageTools-1293"><span class="linenos">1293</span></a><span class="sd">        resized_image : np.ndarray</span>
</span><span id="ImageTools-1294"><a href="#ImageTools-1294"><span class="linenos">1294</span></a><span class="sd">            Resized image adjusted to the scaled screen size.</span>
</span><span id="ImageTools-1295"><a href="#ImageTools-1295"><span class="linenos">1295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1296"><a href="#ImageTools-1296"><span class="linenos">1296</span></a>
</span><span id="ImageTools-1297"><a href="#ImageTools-1297"><span class="linenos">1297</span></a>        <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_screan</span><span class="p">()</span>
</span><span id="ImageTools-1298"><a href="#ImageTools-1298"><span class="linenos">1298</span></a>
</span><span id="ImageTools-1299"><a href="#ImageTools-1299"><span class="linenos">1299</span></a>        <span class="n">screen_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="ImageTools-1300"><a href="#ImageTools-1300"><span class="linenos">1300</span></a>        <span class="n">screen_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_height</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="ImageTools-1301"><a href="#ImageTools-1301"><span class="linenos">1301</span></a>
</span><span id="ImageTools-1302"><a href="#ImageTools-1302"><span class="linenos">1302</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ImageTools-1303"><a href="#ImageTools-1303"><span class="linenos">1303</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ImageTools-1304"><a href="#ImageTools-1304"><span class="linenos">1304</span></a>
</span><span id="ImageTools-1305"><a href="#ImageTools-1305"><span class="linenos">1305</span></a>        <span class="k">if</span> <span class="n">screen_width</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
</span><span id="ImageTools-1306"><a href="#ImageTools-1306"><span class="linenos">1306</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools-1307"><a href="#ImageTools-1307"><span class="linenos">1307</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools-1308"><a href="#ImageTools-1308"><span class="linenos">1308</span></a>
</span><span id="ImageTools-1309"><a href="#ImageTools-1309"><span class="linenos">1309</span></a>            <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="ImageTools-1310"><a href="#ImageTools-1310"><span class="linenos">1310</span></a>            <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="ImageTools-1311"><a href="#ImageTools-1311"><span class="linenos">1311</span></a>
</span><span id="ImageTools-1312"><a href="#ImageTools-1312"><span class="linenos">1312</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="ImageTools-1313"><a href="#ImageTools-1313"><span class="linenos">1313</span></a>
</span><span id="ImageTools-1314"><a href="#ImageTools-1314"><span class="linenos">1314</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools-1315"><a href="#ImageTools-1315"><span class="linenos">1315</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools-1316"><a href="#ImageTools-1316"><span class="linenos">1316</span></a>
</span><span id="ImageTools-1317"><a href="#ImageTools-1317"><span class="linenos">1317</span></a>        <span class="k">if</span> <span class="n">screen_height</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="ow">or</span> <span class="n">screen_height</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">:</span>
</span><span id="ImageTools-1318"><a href="#ImageTools-1318"><span class="linenos">1318</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools-1319"><a href="#ImageTools-1319"><span class="linenos">1319</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools-1320"><a href="#ImageTools-1320"><span class="linenos">1320</span></a>
</span><span id="ImageTools-1321"><a href="#ImageTools-1321"><span class="linenos">1321</span></a>            <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="ImageTools-1322"><a href="#ImageTools-1322"><span class="linenos">1322</span></a>            <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="ImageTools-1323"><a href="#ImageTools-1323"><span class="linenos">1323</span></a>
</span><span id="ImageTools-1324"><a href="#ImageTools-1324"><span class="linenos">1324</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="ImageTools-1325"><a href="#ImageTools-1325"><span class="linenos">1325</span></a>
</span><span id="ImageTools-1326"><a href="#ImageTools-1326"><span class="linenos">1326</span></a>        <span class="k">return</span> <span class="n">img_file</span>
</span><span id="ImageTools-1327"><a href="#ImageTools-1327"><span class="linenos">1327</span></a>
</span><span id="ImageTools-1328"><a href="#ImageTools-1328"><span class="linenos">1328</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_JIMG_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="p">):</span>
</span><span id="ImageTools-1329"><a href="#ImageTools-1329"><span class="linenos">1329</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1330"><a href="#ImageTools-1330"><span class="linenos">1330</span></a><span class="sd">        Load a JIMG project from a `.pjm` file.</span>
</span><span id="ImageTools-1331"><a href="#ImageTools-1331"><span class="linenos">1331</span></a>
</span><span id="ImageTools-1332"><a href="#ImageTools-1332"><span class="linenos">1332</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1333"><a href="#ImageTools-1333"><span class="linenos">1333</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1334"><a href="#ImageTools-1334"><span class="linenos">1334</span></a><span class="sd">        file_path : str</span>
</span><span id="ImageTools-1335"><a href="#ImageTools-1335"><span class="linenos">1335</span></a><span class="sd">            Path to the project file with `.pjm` extension.</span>
</span><span id="ImageTools-1336"><a href="#ImageTools-1336"><span class="linenos">1336</span></a>
</span><span id="ImageTools-1337"><a href="#ImageTools-1337"><span class="linenos">1337</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1338"><a href="#ImageTools-1338"><span class="linenos">1338</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1339"><a href="#ImageTools-1339"><span class="linenos">1339</span></a><span class="sd">        project : object</span>
</span><span id="ImageTools-1340"><a href="#ImageTools-1340"><span class="linenos">1340</span></a><span class="sd">            Loaded project object.</span>
</span><span id="ImageTools-1341"><a href="#ImageTools-1341"><span class="linenos">1341</span></a>
</span><span id="ImageTools-1342"><a href="#ImageTools-1342"><span class="linenos">1342</span></a><span class="sd">        Raises</span>
</span><span id="ImageTools-1343"><a href="#ImageTools-1343"><span class="linenos">1343</span></a><span class="sd">        ------</span>
</span><span id="ImageTools-1344"><a href="#ImageTools-1344"><span class="linenos">1344</span></a><span class="sd">        ValueError</span>
</span><span id="ImageTools-1345"><a href="#ImageTools-1345"><span class="linenos">1345</span></a><span class="sd">            If the provided file does not have a `.pjm` extension.</span>
</span><span id="ImageTools-1346"><a href="#ImageTools-1346"><span class="linenos">1346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1347"><a href="#ImageTools-1347"><span class="linenos">1347</span></a>
</span><span id="ImageTools-1348"><a href="#ImageTools-1348"><span class="linenos">1348</span></a>        <span class="k">if</span> <span class="s2">&quot;.pjm&quot;</span> <span class="ow">in</span> <span class="n">project_path</span><span class="p">:</span>
</span><span id="ImageTools-1349"><a href="#ImageTools-1349"><span class="linenos">1349</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">project_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="ImageTools-1350"><a href="#ImageTools-1350"><span class="linenos">1350</span></a>                <span class="n">app_metadata_tmp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="ImageTools-1351"><a href="#ImageTools-1351"><span class="linenos">1351</span></a>
</span><span id="ImageTools-1352"><a href="#ImageTools-1352"><span class="linenos">1352</span></a>            <span class="k">return</span> <span class="n">app_metadata_tmp</span>
</span><span id="ImageTools-1353"><a href="#ImageTools-1353"><span class="linenos">1353</span></a>
</span><span id="ImageTools-1354"><a href="#ImageTools-1354"><span class="linenos">1354</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ImageTools-1355"><a href="#ImageTools-1355"><span class="linenos">1355</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Provide path to the project metadata file with *.pjm extension!!!&quot;</span><span class="p">)</span>
</span><span id="ImageTools-1356"><a href="#ImageTools-1356"><span class="linenos">1356</span></a>
</span><span id="ImageTools-1357"><a href="#ImageTools-1357"><span class="linenos">1357</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ajd_mask_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="ImageTools-1358"><a href="#ImageTools-1358"><span class="linenos">1358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1359"><a href="#ImageTools-1359"><span class="linenos">1359</span></a><span class="sd">        Adjusts the size of a mask to match the dimensions of a given image.</span>
</span><span id="ImageTools-1360"><a href="#ImageTools-1360"><span class="linenos">1360</span></a>
</span><span id="ImageTools-1361"><a href="#ImageTools-1361"><span class="linenos">1361</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1362"><a href="#ImageTools-1362"><span class="linenos">1362</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1363"><a href="#ImageTools-1363"><span class="linenos">1363</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools-1364"><a href="#ImageTools-1364"><span class="linenos">1364</span></a><span class="sd">            Reference image whose size the mask should match. Can be 2D or 3D.</span>
</span><span id="ImageTools-1365"><a href="#ImageTools-1365"><span class="linenos">1365</span></a>
</span><span id="ImageTools-1366"><a href="#ImageTools-1366"><span class="linenos">1366</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="ImageTools-1367"><a href="#ImageTools-1367"><span class="linenos">1367</span></a><span class="sd">            Mask image to be resized.</span>
</span><span id="ImageTools-1368"><a href="#ImageTools-1368"><span class="linenos">1368</span></a>
</span><span id="ImageTools-1369"><a href="#ImageTools-1369"><span class="linenos">1369</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1370"><a href="#ImageTools-1370"><span class="linenos">1370</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1371"><a href="#ImageTools-1371"><span class="linenos">1371</span></a><span class="sd">        np.ndarray</span>
</span><span id="ImageTools-1372"><a href="#ImageTools-1372"><span class="linenos">1372</span></a><span class="sd">            Resized mask matching the input image dimensions.</span>
</span><span id="ImageTools-1373"><a href="#ImageTools-1373"><span class="linenos">1373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1374"><a href="#ImageTools-1374"><span class="linenos">1374</span></a>
</span><span id="ImageTools-1375"><a href="#ImageTools-1375"><span class="linenos">1375</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ImageTools-1376"><a href="#ImageTools-1376"><span class="linenos">1376</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="ImageTools-1377"><a href="#ImageTools-1377"><span class="linenos">1377</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="ImageTools-1378"><a href="#ImageTools-1378"><span class="linenos">1378</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="ImageTools-1379"><a href="#ImageTools-1379"><span class="linenos">1379</span></a>
</span><span id="ImageTools-1380"><a href="#ImageTools-1380"><span class="linenos">1380</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="ImageTools-1381"><a href="#ImageTools-1381"><span class="linenos">1381</span></a>
</span><span id="ImageTools-1382"><a href="#ImageTools-1382"><span class="linenos">1382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_image</span><span class="p">):</span>
</span><span id="ImageTools-1383"><a href="#ImageTools-1383"><span class="linenos">1383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1384"><a href="#ImageTools-1384"><span class="linenos">1384</span></a><span class="sd">        Load an image from the specified file path.</span>
</span><span id="ImageTools-1385"><a href="#ImageTools-1385"><span class="linenos">1385</span></a>
</span><span id="ImageTools-1386"><a href="#ImageTools-1386"><span class="linenos">1386</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1387"><a href="#ImageTools-1387"><span class="linenos">1387</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1388"><a href="#ImageTools-1388"><span class="linenos">1388</span></a><span class="sd">        path_to_image : str</span>
</span><span id="ImageTools-1389"><a href="#ImageTools-1389"><span class="linenos">1389</span></a><span class="sd">            Path to the image file.</span>
</span><span id="ImageTools-1390"><a href="#ImageTools-1390"><span class="linenos">1390</span></a>
</span><span id="ImageTools-1391"><a href="#ImageTools-1391"><span class="linenos">1391</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1392"><a href="#ImageTools-1392"><span class="linenos">1392</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1393"><a href="#ImageTools-1393"><span class="linenos">1393</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools-1394"><a href="#ImageTools-1394"><span class="linenos">1394</span></a><span class="sd">            Loaded image as a NumPy array.</span>
</span><span id="ImageTools-1395"><a href="#ImageTools-1395"><span class="linenos">1395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1396"><a href="#ImageTools-1396"><span class="linenos">1396</span></a>
</span><span id="ImageTools-1397"><a href="#ImageTools-1397"><span class="linenos">1397</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="n">path_to_image</span><span class="p">)</span>
</span><span id="ImageTools-1398"><a href="#ImageTools-1398"><span class="linenos">1398</span></a>        <span class="k">return</span> <span class="n">image</span>
</span><span id="ImageTools-1399"><a href="#ImageTools-1399"><span class="linenos">1399</span></a>
</span><span id="ImageTools-1400"><a href="#ImageTools-1400"><span class="linenos">1400</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_3D_tiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_image</span><span class="p">):</span>
</span><span id="ImageTools-1401"><a href="#ImageTools-1401"><span class="linenos">1401</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1402"><a href="#ImageTools-1402"><span class="linenos">1402</span></a><span class="sd">        Load a 3D image from a TIFF file.</span>
</span><span id="ImageTools-1403"><a href="#ImageTools-1403"><span class="linenos">1403</span></a>
</span><span id="ImageTools-1404"><a href="#ImageTools-1404"><span class="linenos">1404</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1405"><a href="#ImageTools-1405"><span class="linenos">1405</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1406"><a href="#ImageTools-1406"><span class="linenos">1406</span></a><span class="sd">        path_to_image : str</span>
</span><span id="ImageTools-1407"><a href="#ImageTools-1407"><span class="linenos">1407</span></a><span class="sd">            Path to the 3D TIFF image file.</span>
</span><span id="ImageTools-1408"><a href="#ImageTools-1408"><span class="linenos">1408</span></a>
</span><span id="ImageTools-1409"><a href="#ImageTools-1409"><span class="linenos">1409</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1410"><a href="#ImageTools-1410"><span class="linenos">1410</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1411"><a href="#ImageTools-1411"><span class="linenos">1411</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools-1412"><a href="#ImageTools-1412"><span class="linenos">1412</span></a><span class="sd">            Loaded 3D image as a NumPy array.</span>
</span><span id="ImageTools-1413"><a href="#ImageTools-1413"><span class="linenos">1413</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1414"><a href="#ImageTools-1414"><span class="linenos">1414</span></a>
</span><span id="ImageTools-1415"><a href="#ImageTools-1415"><span class="linenos">1415</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">load_tiff</span><span class="p">(</span><span class="n">path_to_image</span><span class="p">)</span>
</span><span id="ImageTools-1416"><a href="#ImageTools-1416"><span class="linenos">1416</span></a>
</span><span id="ImageTools-1417"><a href="#ImageTools-1417"><span class="linenos">1417</span></a>        <span class="k">return</span> <span class="n">image</span>
</span><span id="ImageTools-1418"><a href="#ImageTools-1418"><span class="linenos">1418</span></a>
</span><span id="ImageTools-1419"><a href="#ImageTools-1419"><span class="linenos">1419</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_mask</span><span class="p">):</span>
</span><span id="ImageTools-1420"><a href="#ImageTools-1420"><span class="linenos">1420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1421"><a href="#ImageTools-1421"><span class="linenos">1421</span></a><span class="sd">        Load a mask image.</span>
</span><span id="ImageTools-1422"><a href="#ImageTools-1422"><span class="linenos">1422</span></a>
</span><span id="ImageTools-1423"><a href="#ImageTools-1423"><span class="linenos">1423</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1424"><a href="#ImageTools-1424"><span class="linenos">1424</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1425"><a href="#ImageTools-1425"><span class="linenos">1425</span></a><span class="sd">        path_to_mask : str</span>
</span><span id="ImageTools-1426"><a href="#ImageTools-1426"><span class="linenos">1426</span></a><span class="sd">            Path to the mask image file.</span>
</span><span id="ImageTools-1427"><a href="#ImageTools-1427"><span class="linenos">1427</span></a>
</span><span id="ImageTools-1428"><a href="#ImageTools-1428"><span class="linenos">1428</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1429"><a href="#ImageTools-1429"><span class="linenos">1429</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1430"><a href="#ImageTools-1430"><span class="linenos">1430</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="ImageTools-1431"><a href="#ImageTools-1431"><span class="linenos">1431</span></a><span class="sd">            Loaded mask image as a NumPy array.</span>
</span><span id="ImageTools-1432"><a href="#ImageTools-1432"><span class="linenos">1432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1433"><a href="#ImageTools-1433"><span class="linenos">1433</span></a>
</span><span id="ImageTools-1434"><a href="#ImageTools-1434"><span class="linenos">1434</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path_to_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
</span><span id="ImageTools-1435"><a href="#ImageTools-1435"><span class="linenos">1435</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span><span id="ImageTools-1436"><a href="#ImageTools-1436"><span class="linenos">1436</span></a>
</span><span id="ImageTools-1437"><a href="#ImageTools-1437"><span class="linenos">1437</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
</span><span id="ImageTools-1438"><a href="#ImageTools-1438"><span class="linenos">1438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1439"><a href="#ImageTools-1439"><span class="linenos">1439</span></a><span class="sd">        Save an image to disk.</span>
</span><span id="ImageTools-1440"><a href="#ImageTools-1440"><span class="linenos">1440</span></a>
</span><span id="ImageTools-1441"><a href="#ImageTools-1441"><span class="linenos">1441</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1442"><a href="#ImageTools-1442"><span class="linenos">1442</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1443"><a href="#ImageTools-1443"><span class="linenos">1443</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools-1444"><a href="#ImageTools-1444"><span class="linenos">1444</span></a><span class="sd">            Image data to be saved.</span>
</span><span id="ImageTools-1445"><a href="#ImageTools-1445"><span class="linenos">1445</span></a>
</span><span id="ImageTools-1446"><a href="#ImageTools-1446"><span class="linenos">1446</span></a><span class="sd">        file_name : str</span>
</span><span id="ImageTools-1447"><a href="#ImageTools-1447"><span class="linenos">1447</span></a><span class="sd">            Output file path including the desired image extension (e.g., &quot;.png&quot;, &quot;.jpg&quot;).</span>
</span><span id="ImageTools-1448"><a href="#ImageTools-1448"><span class="linenos">1448</span></a>
</span><span id="ImageTools-1449"><a href="#ImageTools-1449"><span class="linenos">1449</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1450"><a href="#ImageTools-1450"><span class="linenos">1450</span></a>
</span><span id="ImageTools-1451"><a href="#ImageTools-1451"><span class="linenos">1451</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
</span><span id="ImageTools-1452"><a href="#ImageTools-1452"><span class="linenos">1452</span></a>
</span><span id="ImageTools-1453"><a href="#ImageTools-1453"><span class="linenos">1453</span></a>    <span class="c1"># calculation methods</span>
</span><span id="ImageTools-1454"><a href="#ImageTools-1454"><span class="linenos">1454</span></a>
</span><span id="ImageTools-1455"><a href="#ImageTools-1455"><span class="linenos">1455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">drop_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ImageTools-1456"><a href="#ImageTools-1456"><span class="linenos">1456</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1457"><a href="#ImageTools-1457"><span class="linenos">1457</span></a><span class="sd">        Filters elements from a dictionary based on a condition applied to a specified key.</span>
</span><span id="ImageTools-1458"><a href="#ImageTools-1458"><span class="linenos">1458</span></a>
</span><span id="ImageTools-1459"><a href="#ImageTools-1459"><span class="linenos">1459</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1460"><a href="#ImageTools-1460"><span class="linenos">1460</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1461"><a href="#ImageTools-1461"><span class="linenos">1461</span></a><span class="sd">        dictionary : dict</span>
</span><span id="ImageTools-1462"><a href="#ImageTools-1462"><span class="linenos">1462</span></a><span class="sd">            Dictionary containing lists or arrays under each key.</span>
</span><span id="ImageTools-1463"><a href="#ImageTools-1463"><span class="linenos">1463</span></a>
</span><span id="ImageTools-1464"><a href="#ImageTools-1464"><span class="linenos">1464</span></a><span class="sd">        key : str</span>
</span><span id="ImageTools-1465"><a href="#ImageTools-1465"><span class="linenos">1465</span></a><span class="sd">            The key in the dictionary on which the filtering condition will be applied.</span>
</span><span id="ImageTools-1466"><a href="#ImageTools-1466"><span class="linenos">1466</span></a>
</span><span id="ImageTools-1467"><a href="#ImageTools-1467"><span class="linenos">1467</span></a><span class="sd">        var : numeric</span>
</span><span id="ImageTools-1468"><a href="#ImageTools-1468"><span class="linenos">1468</span></a><span class="sd">            Value to compare against each element in dictionary[key].</span>
</span><span id="ImageTools-1469"><a href="#ImageTools-1469"><span class="linenos">1469</span></a>
</span><span id="ImageTools-1470"><a href="#ImageTools-1470"><span class="linenos">1470</span></a><span class="sd">        action : str, optional</span>
</span><span id="ImageTools-1471"><a href="#ImageTools-1471"><span class="linenos">1471</span></a><span class="sd">            Comparison operator as string: &#39;&lt;=&#39;, &#39;&gt;=&#39;, &#39;==&#39;, &#39;&lt;&#39;, &#39;&gt;&#39;.</span>
</span><span id="ImageTools-1472"><a href="#ImageTools-1472"><span class="linenos">1472</span></a><span class="sd">            Default is None, which raises an error.</span>
</span><span id="ImageTools-1473"><a href="#ImageTools-1473"><span class="linenos">1473</span></a>
</span><span id="ImageTools-1474"><a href="#ImageTools-1474"><span class="linenos">1474</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1475"><a href="#ImageTools-1475"><span class="linenos">1475</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1476"><a href="#ImageTools-1476"><span class="linenos">1476</span></a><span class="sd">        dict</span>
</span><span id="ImageTools-1477"><a href="#ImageTools-1477"><span class="linenos">1477</span></a><span class="sd">            A new dictionary with elements removed where the condition matches.</span>
</span><span id="ImageTools-1478"><a href="#ImageTools-1478"><span class="linenos">1478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1479"><a href="#ImageTools-1479"><span class="linenos">1479</span></a>
</span><span id="ImageTools-1480"><a href="#ImageTools-1480"><span class="linenos">1480</span></a>        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
</span><span id="ImageTools-1481"><a href="#ImageTools-1481"><span class="linenos">1481</span></a>        <span class="n">indices_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools-1482"><a href="#ImageTools-1482"><span class="linenos">1482</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
</span><span id="ImageTools-1483"><a href="#ImageTools-1483"><span class="linenos">1483</span></a>
</span><span id="ImageTools-1484"><a href="#ImageTools-1484"><span class="linenos">1484</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ImageTools-1485"><a href="#ImageTools-1485"><span class="linenos">1485</span></a>                <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span>
</span><span id="ImageTools-1486"><a href="#ImageTools-1486"><span class="linenos">1486</span></a>
</span><span id="ImageTools-1487"><a href="#ImageTools-1487"><span class="linenos">1487</span></a>            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span>
</span><span id="ImageTools-1488"><a href="#ImageTools-1488"><span class="linenos">1488</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;=</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools-1489"><a href="#ImageTools-1489"><span class="linenos">1489</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools-1490"><a href="#ImageTools-1490"><span class="linenos">1490</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span>
</span><span id="ImageTools-1491"><a href="#ImageTools-1491"><span class="linenos">1491</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;=</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools-1492"><a href="#ImageTools-1492"><span class="linenos">1492</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools-1493"><a href="#ImageTools-1493"><span class="linenos">1493</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span>
</span><span id="ImageTools-1494"><a href="#ImageTools-1494"><span class="linenos">1494</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools-1495"><a href="#ImageTools-1495"><span class="linenos">1495</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools-1496"><a href="#ImageTools-1496"><span class="linenos">1496</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
</span><span id="ImageTools-1497"><a href="#ImageTools-1497"><span class="linenos">1497</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools-1498"><a href="#ImageTools-1498"><span class="linenos">1498</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools-1499"><a href="#ImageTools-1499"><span class="linenos">1499</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
</span><span id="ImageTools-1500"><a href="#ImageTools-1500"><span class="linenos">1500</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools-1501"><a href="#ImageTools-1501"><span class="linenos">1501</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools-1502"><a href="#ImageTools-1502"><span class="linenos">1502</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ImageTools-1503"><a href="#ImageTools-1503"><span class="linenos">1503</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Wrong action!&quot;</span><span class="p">)</span>
</span><span id="ImageTools-1504"><a href="#ImageTools-1504"><span class="linenos">1504</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="ImageTools-1505"><a href="#ImageTools-1505"><span class="linenos">1505</span></a>
</span><span id="ImageTools-1506"><a href="#ImageTools-1506"><span class="linenos">1506</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ImageTools-1507"><a href="#ImageTools-1507"><span class="linenos">1507</span></a>            <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ImageTools-1508"><a href="#ImageTools-1508"><span class="linenos">1508</span></a>                <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices_to_drop</span>
</span><span id="ImageTools-1509"><a href="#ImageTools-1509"><span class="linenos">1509</span></a>            <span class="p">]</span>
</span><span id="ImageTools-1510"><a href="#ImageTools-1510"><span class="linenos">1510</span></a>
</span><span id="ImageTools-1511"><a href="#ImageTools-1511"><span class="linenos">1511</span></a>        <span class="k">return</span> <span class="n">dictionary</span>
</span><span id="ImageTools-1512"><a href="#ImageTools-1512"><span class="linenos">1512</span></a>
</span><span id="ImageTools-1513"><a href="#ImageTools-1513"><span class="linenos">1513</span></a>    <span class="c1"># modified for gradation (separation near nucleus)</span>
</span><span id="ImageTools-1514"><a href="#ImageTools-1514"><span class="linenos">1514</span></a>
</span><span id="ImageTools-1515"><a href="#ImageTools-1515"><span class="linenos">1515</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
</span><span id="ImageTools-1516"><a href="#ImageTools-1516"><span class="linenos">1516</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1517"><a href="#ImageTools-1517"><span class="linenos">1517</span></a><span class="sd">        Creates a mask image with gradated intensity values for each coordinate set in a dictionary.</span>
</span><span id="ImageTools-1518"><a href="#ImageTools-1518"><span class="linenos">1518</span></a>
</span><span id="ImageTools-1519"><a href="#ImageTools-1519"><span class="linenos">1519</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1520"><a href="#ImageTools-1520"><span class="linenos">1520</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1521"><a href="#ImageTools-1521"><span class="linenos">1521</span></a><span class="sd">        dictionary : dict</span>
</span><span id="ImageTools-1522"><a href="#ImageTools-1522"><span class="linenos">1522</span></a><span class="sd">            Dictionary containing a &#39;coords&#39; key with a list of arrays of coordinates.</span>
</span><span id="ImageTools-1523"><a href="#ImageTools-1523"><span class="linenos">1523</span></a>
</span><span id="ImageTools-1524"><a href="#ImageTools-1524"><span class="linenos">1524</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools-1525"><a href="#ImageTools-1525"><span class="linenos">1525</span></a><span class="sd">            Base image to define the shape of the mask.</span>
</span><span id="ImageTools-1526"><a href="#ImageTools-1526"><span class="linenos">1526</span></a>
</span><span id="ImageTools-1527"><a href="#ImageTools-1527"><span class="linenos">1527</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1528"><a href="#ImageTools-1528"><span class="linenos">1528</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1529"><a href="#ImageTools-1529"><span class="linenos">1529</span></a><span class="sd">        np.ndarray</span>
</span><span id="ImageTools-1530"><a href="#ImageTools-1530"><span class="linenos">1530</span></a><span class="sd">            Mask image with uint16 gradated intensity.</span>
</span><span id="ImageTools-1531"><a href="#ImageTools-1531"><span class="linenos">1531</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1532"><a href="#ImageTools-1532"><span class="linenos">1532</span></a>
</span><span id="ImageTools-1533"><a href="#ImageTools-1533"><span class="linenos">1533</span></a>        <span class="n">image_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ImageTools-1534"><a href="#ImageTools-1534"><span class="linenos">1534</span></a>
</span><span id="ImageTools-1535"><a href="#ImageTools-1535"><span class="linenos">1535</span></a>        <span class="n">arrays_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span>
</span><span id="ImageTools-1536"><a href="#ImageTools-1536"><span class="linenos">1536</span></a>
</span><span id="ImageTools-1537"><a href="#ImageTools-1537"><span class="linenos">1537</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ImageTools-1538"><a href="#ImageTools-1538"><span class="linenos">1538</span></a>
</span><span id="ImageTools-1539"><a href="#ImageTools-1539"><span class="linenos">1539</span></a>            <span class="n">initial_val</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="ImageTools-1540"><a href="#ImageTools-1540"><span class="linenos">1540</span></a>            <span class="n">intensity_list</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="ImageTools-1541"><a href="#ImageTools-1541"><span class="linenos">1541</span></a>                <span class="n">arrays_list</span>
</span><span id="ImageTools-1542"><a href="#ImageTools-1542"><span class="linenos">1542</span></a>            <span class="p">)</span>
</span><span id="ImageTools-1543"><a href="#ImageTools-1543"><span class="linenos">1543</span></a>
</span><span id="ImageTools-1544"><a href="#ImageTools-1544"><span class="linenos">1544</span></a>            <span class="n">gradation</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ImageTools-1545"><a href="#ImageTools-1545"><span class="linenos">1545</span></a>            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays_list</span><span class="p">:</span>
</span><span id="ImageTools-1546"><a href="#ImageTools-1546"><span class="linenos">1546</span></a>                <span class="n">image_mask</span><span class="p">[</span><span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">initial_val</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="ImageTools-1547"><a href="#ImageTools-1547"><span class="linenos">1547</span></a>                    <span class="n">gradation</span> <span class="o">*</span> <span class="n">intensity_list</span>
</span><span id="ImageTools-1548"><a href="#ImageTools-1548"><span class="linenos">1548</span></a>                <span class="p">)</span>
</span><span id="ImageTools-1549"><a href="#ImageTools-1549"><span class="linenos">1549</span></a>                <span class="n">gradation</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ImageTools-1550"><a href="#ImageTools-1550"><span class="linenos">1550</span></a>
</span><span id="ImageTools-1551"><a href="#ImageTools-1551"><span class="linenos">1551</span></a>        <span class="k">return</span> <span class="n">image_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">)</span>
</span><span id="ImageTools-1552"><a href="#ImageTools-1552"><span class="linenos">1552</span></a>
</span><span id="ImageTools-1553"><a href="#ImageTools-1553"><span class="linenos">1553</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">min_max_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
</span><span id="ImageTools-1554"><a href="#ImageTools-1554"><span class="linenos">1554</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools-1555"><a href="#ImageTools-1555"><span class="linenos">1555</span></a><span class="sd">        Calculates histogram-based minimum and maximum intensity percentiles in an image.</span>
</span><span id="ImageTools-1556"><a href="#ImageTools-1556"><span class="linenos">1556</span></a>
</span><span id="ImageTools-1557"><a href="#ImageTools-1557"><span class="linenos">1557</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools-1558"><a href="#ImageTools-1558"><span class="linenos">1558</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools-1559"><a href="#ImageTools-1559"><span class="linenos">1559</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools-1560"><a href="#ImageTools-1560"><span class="linenos">1560</span></a><span class="sd">            Input image for histogram analysis.</span>
</span><span id="ImageTools-1561"><a href="#ImageTools-1561"><span class="linenos">1561</span></a>
</span><span id="ImageTools-1562"><a href="#ImageTools-1562"><span class="linenos">1562</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools-1563"><a href="#ImageTools-1563"><span class="linenos">1563</span></a><span class="sd">        -------</span>
</span><span id="ImageTools-1564"><a href="#ImageTools-1564"><span class="linenos">1564</span></a><span class="sd">        min_val : float</span>
</span><span id="ImageTools-1565"><a href="#ImageTools-1565"><span class="linenos">1565</span></a><span class="sd">            Minimum intensity percentile above zero.</span>
</span><span id="ImageTools-1566"><a href="#ImageTools-1566"><span class="linenos">1566</span></a>
</span><span id="ImageTools-1567"><a href="#ImageTools-1567"><span class="linenos">1567</span></a><span class="sd">        max_val : float</span>
</span><span id="ImageTools-1568"><a href="#ImageTools-1568"><span class="linenos">1568</span></a><span class="sd">            Maximum intensity percentile based on histogram gradient.</span>
</span><span id="ImageTools-1569"><a href="#ImageTools-1569"><span class="linenos">1569</span></a>
</span><span id="ImageTools-1570"><a href="#ImageTools-1570"><span class="linenos">1570</span></a><span class="sd">        df : pd.DataFrame</span>
</span><span id="ImageTools-1571"><a href="#ImageTools-1571"><span class="linenos">1571</span></a><span class="sd">            DataFrame containing quantiles, corresponding intensity values, and cumulative percents.</span>
</span><span id="ImageTools-1572"><a href="#ImageTools-1572"><span class="linenos">1572</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools-1573"><a href="#ImageTools-1573"><span class="linenos">1573</span></a>
</span><span id="ImageTools-1574"><a href="#ImageTools-1574"><span class="linenos">1574</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools-1575"><a href="#ImageTools-1575"><span class="linenos">1575</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools-1576"><a href="#ImageTools-1576"><span class="linenos">1576</span></a>        <span class="n">perc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools-1577"><a href="#ImageTools-1577"><span class="linenos">1577</span></a>
</span><span id="ImageTools-1578"><a href="#ImageTools-1578"><span class="linenos">1578</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools-1579"><a href="#ImageTools-1579"><span class="linenos">1579</span></a>
</span><span id="ImageTools-1580"><a href="#ImageTools-1580"><span class="linenos">1580</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span><span id="ImageTools-1581"><a href="#ImageTools-1581"><span class="linenos">1581</span></a>            <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="ImageTools-1582"><a href="#ImageTools-1582"><span class="linenos">1582</span></a>            <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="ImageTools-1583"><a href="#ImageTools-1583"><span class="linenos">1583</span></a>            <span class="n">sum_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="ImageTools-1584"><a href="#ImageTools-1584"><span class="linenos">1584</span></a>            <span class="n">pr</span> <span class="o">=</span> <span class="n">sum_val</span> <span class="o">/</span> <span class="n">max_val</span>
</span><span id="ImageTools-1585"><a href="#ImageTools-1585"><span class="linenos">1585</span></a>            <span class="n">perc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="ImageTools-1586"><a href="#ImageTools-1586"><span class="linenos">1586</span></a>
</span><span id="ImageTools-1587"><a href="#ImageTools-1587"><span class="linenos">1587</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span> <span class="n">perc</span><span class="p">})</span>
</span><span id="ImageTools-1588"><a href="#ImageTools-1588"><span class="linenos">1588</span></a>
</span><span id="ImageTools-1589"><a href="#ImageTools-1589"><span class="linenos">1589</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ImageTools-1590"><a href="#ImageTools-1590"><span class="linenos">1590</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span><span id="ImageTools-1591"><a href="#ImageTools-1591"><span class="linenos">1591</span></a>            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">min_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ImageTools-1592"><a href="#ImageTools-1592"><span class="linenos">1592</span></a>                <span class="n">min_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="ImageTools-1593"><a href="#ImageTools-1593"><span class="linenos">1593</span></a>
</span><span id="ImageTools-1594"><a href="#ImageTools-1594"><span class="linenos">1594</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ImageTools-1595"><a href="#ImageTools-1595"><span class="linenos">1595</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools-1596"><a href="#ImageTools-1596"><span class="linenos">1596</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ImageTools-1597"><a href="#ImageTools-1597"><span class="linenos">1597</span></a>
</span><span id="ImageTools-1598"><a href="#ImageTools-1598"><span class="linenos">1598</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span><span id="ImageTools-1599"><a href="#ImageTools-1599"><span class="linenos">1599</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="ImageTools-1600"><a href="#ImageTools-1600"><span class="linenos">1600</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="ImageTools-1601"><a href="#ImageTools-1601"><span class="linenos">1601</span></a>                <span class="k">break</span>
</span><span id="ImageTools-1602"><a href="#ImageTools-1602"><span class="linenos">1602</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ImageTools-1603"><a href="#ImageTools-1603"><span class="linenos">1603</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="ImageTools-1604"><a href="#ImageTools-1604"><span class="linenos">1604</span></a>
</span><span id="ImageTools-1605"><a href="#ImageTools-1605"><span class="linenos">1605</span></a>        <span class="k">return</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Collection of utility functions for image preprocessing, adjustment,
merging, and stitching.</p>

<p>This class provides standalone static methods for operations such as
histogram equalization, CLAHE enhancement, intensity adjustments,
image merging based on weighted ratios, and horizontal stitching.
These tools are used internally by <code>ImagesManagement</code> but can also be
applied independently for generic image-processing workflows.</p>

<h2 id="notes">Notes</h2>

<p>All methods operate on NumPy arrays and expect images in standard
OpenCV format. Some functions assume 16-bit images unless stated
otherwise.</p>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">ImageTools</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageTools</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">img</span> <span class="o">=</span> <span class="n">ImageTools</span><span class="o">.</span><span class="n">equalize_hist_16bit</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">merged</span> <span class="o">=</span> <span class="n">ImageTools</span><span class="o">.</span><span class="n">merge_images</span><span class="p">([</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
</code></pre>
</div>
</div>


                            <div id="ImageTools.get_screan" class="classattr">
                                        <input id="ImageTools.get_screan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_screan</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.get_screan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.get_screan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.get_screan-1258"><a href="#ImageTools.get_screan-1258"><span class="linenos">1258</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_screan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ImageTools.get_screan-1259"><a href="#ImageTools.get_screan-1259"><span class="linenos">1259</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.get_screan-1260"><a href="#ImageTools.get_screan-1260"><span class="linenos">1260</span></a><span class="sd">        Return the current screen size.</span>
</span><span id="ImageTools.get_screan-1261"><a href="#ImageTools.get_screan-1261"><span class="linenos">1261</span></a>
</span><span id="ImageTools.get_screan-1262"><a href="#ImageTools.get_screan-1262"><span class="linenos">1262</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.get_screan-1263"><a href="#ImageTools.get_screan-1263"><span class="linenos">1263</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.get_screan-1264"><a href="#ImageTools.get_screan-1264"><span class="linenos">1264</span></a><span class="sd">        screen_width : int</span>
</span><span id="ImageTools.get_screan-1265"><a href="#ImageTools.get_screan-1265"><span class="linenos">1265</span></a><span class="sd">            Width of the screen in pixels.</span>
</span><span id="ImageTools.get_screan-1266"><a href="#ImageTools.get_screan-1266"><span class="linenos">1266</span></a>
</span><span id="ImageTools.get_screan-1267"><a href="#ImageTools.get_screan-1267"><span class="linenos">1267</span></a><span class="sd">        screen_height : int</span>
</span><span id="ImageTools.get_screan-1268"><a href="#ImageTools.get_screan-1268"><span class="linenos">1268</span></a><span class="sd">            Height of the screen in pixels.</span>
</span><span id="ImageTools.get_screan-1269"><a href="#ImageTools.get_screan-1269"><span class="linenos">1269</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.get_screan-1270"><a href="#ImageTools.get_screan-1270"><span class="linenos">1270</span></a>
</span><span id="ImageTools.get_screan-1271"><a href="#ImageTools.get_screan-1271"><span class="linenos">1271</span></a>        <span class="n">root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
</span><span id="ImageTools.get_screan-1272"><a href="#ImageTools.get_screan-1272"><span class="linenos">1272</span></a>        <span class="n">screen_width</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenwidth</span><span class="p">()</span>
</span><span id="ImageTools.get_screan-1273"><a href="#ImageTools.get_screan-1273"><span class="linenos">1273</span></a>        <span class="n">screen_height</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">winfo_screenheight</span><span class="p">()</span>
</span><span id="ImageTools.get_screan-1274"><a href="#ImageTools.get_screan-1274"><span class="linenos">1274</span></a>
</span><span id="ImageTools.get_screan-1275"><a href="#ImageTools.get_screan-1275"><span class="linenos">1275</span></a>        <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="ImageTools.get_screan-1276"><a href="#ImageTools.get_screan-1276"><span class="linenos">1276</span></a>
</span><span id="ImageTools.get_screan-1277"><a href="#ImageTools.get_screan-1277"><span class="linenos">1277</span></a>        <span class="k">return</span> <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span>
</span></pre></div>


            <div class="docstring"><p>Return the current screen size.</p>

<h2 id="returns">Returns</h2>

<p>screen_width : int
    Width of the screen in pixels.</p>

<p>screen_height : int
    Height of the screen in pixels.</p>
</div>


                            </div>
                            <div id="ImageTools.resize_to_screen_img" class="classattr">
                                        <input id="ImageTools.resize_to_screen_img-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">resize_to_screen_img</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">img_file</span>, </span><span class="param"><span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.resize_to_screen_img-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.resize_to_screen_img"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.resize_to_screen_img-1279"><a href="#ImageTools.resize_to_screen_img-1279"><span class="linenos">1279</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resize_to_screen_img</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_file</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
</span><span id="ImageTools.resize_to_screen_img-1280"><a href="#ImageTools.resize_to_screen_img-1280"><span class="linenos">1280</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.resize_to_screen_img-1281"><a href="#ImageTools.resize_to_screen_img-1281"><span class="linenos">1281</span></a><span class="sd">        Resize an input image to a scaled version of the current screen size.</span>
</span><span id="ImageTools.resize_to_screen_img-1282"><a href="#ImageTools.resize_to_screen_img-1282"><span class="linenos">1282</span></a>
</span><span id="ImageTools.resize_to_screen_img-1283"><a href="#ImageTools.resize_to_screen_img-1283"><span class="linenos">1283</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.resize_to_screen_img-1284"><a href="#ImageTools.resize_to_screen_img-1284"><span class="linenos">1284</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.resize_to_screen_img-1285"><a href="#ImageTools.resize_to_screen_img-1285"><span class="linenos">1285</span></a><span class="sd">        img_file : np.ndarray</span>
</span><span id="ImageTools.resize_to_screen_img-1286"><a href="#ImageTools.resize_to_screen_img-1286"><span class="linenos">1286</span></a><span class="sd">            Input image to be resized.</span>
</span><span id="ImageTools.resize_to_screen_img-1287"><a href="#ImageTools.resize_to_screen_img-1287"><span class="linenos">1287</span></a>
</span><span id="ImageTools.resize_to_screen_img-1288"><a href="#ImageTools.resize_to_screen_img-1288"><span class="linenos">1288</span></a><span class="sd">        factor : int</span>
</span><span id="ImageTools.resize_to_screen_img-1289"><a href="#ImageTools.resize_to_screen_img-1289"><span class="linenos">1289</span></a><span class="sd">            Scaling factor applied to the screen dimensions.</span>
</span><span id="ImageTools.resize_to_screen_img-1290"><a href="#ImageTools.resize_to_screen_img-1290"><span class="linenos">1290</span></a>
</span><span id="ImageTools.resize_to_screen_img-1291"><a href="#ImageTools.resize_to_screen_img-1291"><span class="linenos">1291</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.resize_to_screen_img-1292"><a href="#ImageTools.resize_to_screen_img-1292"><span class="linenos">1292</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.resize_to_screen_img-1293"><a href="#ImageTools.resize_to_screen_img-1293"><span class="linenos">1293</span></a><span class="sd">        resized_image : np.ndarray</span>
</span><span id="ImageTools.resize_to_screen_img-1294"><a href="#ImageTools.resize_to_screen_img-1294"><span class="linenos">1294</span></a><span class="sd">            Resized image adjusted to the scaled screen size.</span>
</span><span id="ImageTools.resize_to_screen_img-1295"><a href="#ImageTools.resize_to_screen_img-1295"><span class="linenos">1295</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.resize_to_screen_img-1296"><a href="#ImageTools.resize_to_screen_img-1296"><span class="linenos">1296</span></a>
</span><span id="ImageTools.resize_to_screen_img-1297"><a href="#ImageTools.resize_to_screen_img-1297"><span class="linenos">1297</span></a>        <span class="n">screen_width</span><span class="p">,</span> <span class="n">screen_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_screan</span><span class="p">()</span>
</span><span id="ImageTools.resize_to_screen_img-1298"><a href="#ImageTools.resize_to_screen_img-1298"><span class="linenos">1298</span></a>
</span><span id="ImageTools.resize_to_screen_img-1299"><a href="#ImageTools.resize_to_screen_img-1299"><span class="linenos">1299</span></a>        <span class="n">screen_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_width</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="ImageTools.resize_to_screen_img-1300"><a href="#ImageTools.resize_to_screen_img-1300"><span class="linenos">1300</span></a>        <span class="n">screen_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">screen_height</span> <span class="o">*</span> <span class="n">factor</span><span class="p">)</span>
</span><span id="ImageTools.resize_to_screen_img-1301"><a href="#ImageTools.resize_to_screen_img-1301"><span class="linenos">1301</span></a>
</span><span id="ImageTools.resize_to_screen_img-1302"><a href="#ImageTools.resize_to_screen_img-1302"><span class="linenos">1302</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="ImageTools.resize_to_screen_img-1303"><a href="#ImageTools.resize_to_screen_img-1303"><span class="linenos">1303</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="ImageTools.resize_to_screen_img-1304"><a href="#ImageTools.resize_to_screen_img-1304"><span class="linenos">1304</span></a>
</span><span id="ImageTools.resize_to_screen_img-1305"><a href="#ImageTools.resize_to_screen_img-1305"><span class="linenos">1305</span></a>        <span class="k">if</span> <span class="n">screen_width</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="ow">or</span> <span class="n">screen_width</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">&gt;</span> <span class="n">w</span><span class="p">:</span>
</span><span id="ImageTools.resize_to_screen_img-1306"><a href="#ImageTools.resize_to_screen_img-1306"><span class="linenos">1306</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools.resize_to_screen_img-1307"><a href="#ImageTools.resize_to_screen_img-1307"><span class="linenos">1307</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools.resize_to_screen_img-1308"><a href="#ImageTools.resize_to_screen_img-1308"><span class="linenos">1308</span></a>
</span><span id="ImageTools.resize_to_screen_img-1309"><a href="#ImageTools.resize_to_screen_img-1309"><span class="linenos">1309</span></a>            <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="ImageTools.resize_to_screen_img-1310"><a href="#ImageTools.resize_to_screen_img-1310"><span class="linenos">1310</span></a>            <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_width</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="ImageTools.resize_to_screen_img-1311"><a href="#ImageTools.resize_to_screen_img-1311"><span class="linenos">1311</span></a>
</span><span id="ImageTools.resize_to_screen_img-1312"><a href="#ImageTools.resize_to_screen_img-1312"><span class="linenos">1312</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="ImageTools.resize_to_screen_img-1313"><a href="#ImageTools.resize_to_screen_img-1313"><span class="linenos">1313</span></a>
</span><span id="ImageTools.resize_to_screen_img-1314"><a href="#ImageTools.resize_to_screen_img-1314"><span class="linenos">1314</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools.resize_to_screen_img-1315"><a href="#ImageTools.resize_to_screen_img-1315"><span class="linenos">1315</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools.resize_to_screen_img-1316"><a href="#ImageTools.resize_to_screen_img-1316"><span class="linenos">1316</span></a>
</span><span id="ImageTools.resize_to_screen_img-1317"><a href="#ImageTools.resize_to_screen_img-1317"><span class="linenos">1317</span></a>        <span class="k">if</span> <span class="n">screen_height</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="ow">or</span> <span class="n">screen_height</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">:</span>
</span><span id="ImageTools.resize_to_screen_img-1318"><a href="#ImageTools.resize_to_screen_img-1318"><span class="linenos">1318</span></a>            <span class="n">h</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools.resize_to_screen_img-1319"><a href="#ImageTools.resize_to_screen_img-1319"><span class="linenos">1319</span></a>            <span class="n">w</span> <span class="o">=</span> <span class="n">img_file</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools.resize_to_screen_img-1320"><a href="#ImageTools.resize_to_screen_img-1320"><span class="linenos">1320</span></a>
</span><span id="ImageTools.resize_to_screen_img-1321"><a href="#ImageTools.resize_to_screen_img-1321"><span class="linenos">1321</span></a>            <span class="n">ww</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
</span><span id="ImageTools.resize_to_screen_img-1322"><a href="#ImageTools.resize_to_screen_img-1322"><span class="linenos">1322</span></a>            <span class="n">hh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">screen_height</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span> <span class="o">*</span> <span class="n">h</span><span class="p">)</span>
</span><span id="ImageTools.resize_to_screen_img-1323"><a href="#ImageTools.resize_to_screen_img-1323"><span class="linenos">1323</span></a>
</span><span id="ImageTools.resize_to_screen_img-1324"><a href="#ImageTools.resize_to_screen_img-1324"><span class="linenos">1324</span></a>            <span class="n">img_file</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span><span class="p">,</span> <span class="n">hh</span><span class="p">))</span>
</span><span id="ImageTools.resize_to_screen_img-1325"><a href="#ImageTools.resize_to_screen_img-1325"><span class="linenos">1325</span></a>
</span><span id="ImageTools.resize_to_screen_img-1326"><a href="#ImageTools.resize_to_screen_img-1326"><span class="linenos">1326</span></a>        <span class="k">return</span> <span class="n">img_file</span>
</span></pre></div>


            <div class="docstring"><p>Resize an input image to a scaled version of the current screen size.</p>

<h2 id="parameters">Parameters</h2>

<p>img_file : np.ndarray
    Input image to be resized.</p>

<p>factor : int
    Scaling factor applied to the screen dimensions.</p>

<h2 id="returns">Returns</h2>

<p>resized_image : np.ndarray
    Resized image adjusted to the scaled screen size.</p>
</div>


                            </div>
                            <div id="ImageTools.load_JIMG_project" class="classattr">
                                        <input id="ImageTools.load_JIMG_project-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_JIMG_project</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">project_path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.load_JIMG_project-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.load_JIMG_project"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.load_JIMG_project-1328"><a href="#ImageTools.load_JIMG_project-1328"><span class="linenos">1328</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_JIMG_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_path</span><span class="p">):</span>
</span><span id="ImageTools.load_JIMG_project-1329"><a href="#ImageTools.load_JIMG_project-1329"><span class="linenos">1329</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.load_JIMG_project-1330"><a href="#ImageTools.load_JIMG_project-1330"><span class="linenos">1330</span></a><span class="sd">        Load a JIMG project from a `.pjm` file.</span>
</span><span id="ImageTools.load_JIMG_project-1331"><a href="#ImageTools.load_JIMG_project-1331"><span class="linenos">1331</span></a>
</span><span id="ImageTools.load_JIMG_project-1332"><a href="#ImageTools.load_JIMG_project-1332"><span class="linenos">1332</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.load_JIMG_project-1333"><a href="#ImageTools.load_JIMG_project-1333"><span class="linenos">1333</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.load_JIMG_project-1334"><a href="#ImageTools.load_JIMG_project-1334"><span class="linenos">1334</span></a><span class="sd">        file_path : str</span>
</span><span id="ImageTools.load_JIMG_project-1335"><a href="#ImageTools.load_JIMG_project-1335"><span class="linenos">1335</span></a><span class="sd">            Path to the project file with `.pjm` extension.</span>
</span><span id="ImageTools.load_JIMG_project-1336"><a href="#ImageTools.load_JIMG_project-1336"><span class="linenos">1336</span></a>
</span><span id="ImageTools.load_JIMG_project-1337"><a href="#ImageTools.load_JIMG_project-1337"><span class="linenos">1337</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.load_JIMG_project-1338"><a href="#ImageTools.load_JIMG_project-1338"><span class="linenos">1338</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.load_JIMG_project-1339"><a href="#ImageTools.load_JIMG_project-1339"><span class="linenos">1339</span></a><span class="sd">        project : object</span>
</span><span id="ImageTools.load_JIMG_project-1340"><a href="#ImageTools.load_JIMG_project-1340"><span class="linenos">1340</span></a><span class="sd">            Loaded project object.</span>
</span><span id="ImageTools.load_JIMG_project-1341"><a href="#ImageTools.load_JIMG_project-1341"><span class="linenos">1341</span></a>
</span><span id="ImageTools.load_JIMG_project-1342"><a href="#ImageTools.load_JIMG_project-1342"><span class="linenos">1342</span></a><span class="sd">        Raises</span>
</span><span id="ImageTools.load_JIMG_project-1343"><a href="#ImageTools.load_JIMG_project-1343"><span class="linenos">1343</span></a><span class="sd">        ------</span>
</span><span id="ImageTools.load_JIMG_project-1344"><a href="#ImageTools.load_JIMG_project-1344"><span class="linenos">1344</span></a><span class="sd">        ValueError</span>
</span><span id="ImageTools.load_JIMG_project-1345"><a href="#ImageTools.load_JIMG_project-1345"><span class="linenos">1345</span></a><span class="sd">            If the provided file does not have a `.pjm` extension.</span>
</span><span id="ImageTools.load_JIMG_project-1346"><a href="#ImageTools.load_JIMG_project-1346"><span class="linenos">1346</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.load_JIMG_project-1347"><a href="#ImageTools.load_JIMG_project-1347"><span class="linenos">1347</span></a>
</span><span id="ImageTools.load_JIMG_project-1348"><a href="#ImageTools.load_JIMG_project-1348"><span class="linenos">1348</span></a>        <span class="k">if</span> <span class="s2">&quot;.pjm&quot;</span> <span class="ow">in</span> <span class="n">project_path</span><span class="p">:</span>
</span><span id="ImageTools.load_JIMG_project-1349"><a href="#ImageTools.load_JIMG_project-1349"><span class="linenos">1349</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">project_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="ImageTools.load_JIMG_project-1350"><a href="#ImageTools.load_JIMG_project-1350"><span class="linenos">1350</span></a>                <span class="n">app_metadata_tmp</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="ImageTools.load_JIMG_project-1351"><a href="#ImageTools.load_JIMG_project-1351"><span class="linenos">1351</span></a>
</span><span id="ImageTools.load_JIMG_project-1352"><a href="#ImageTools.load_JIMG_project-1352"><span class="linenos">1352</span></a>            <span class="k">return</span> <span class="n">app_metadata_tmp</span>
</span><span id="ImageTools.load_JIMG_project-1353"><a href="#ImageTools.load_JIMG_project-1353"><span class="linenos">1353</span></a>
</span><span id="ImageTools.load_JIMG_project-1354"><a href="#ImageTools.load_JIMG_project-1354"><span class="linenos">1354</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ImageTools.load_JIMG_project-1355"><a href="#ImageTools.load_JIMG_project-1355"><span class="linenos">1355</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Provide path to the project metadata file with *.pjm extension!!!&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Load a JIMG project from a <code>.pjm</code> file.</p>

<h2 id="parameters">Parameters</h2>

<p>file_path : str
    Path to the project file with <code>.pjm</code> extension.</p>

<h2 id="returns">Returns</h2>

<p>project : object
    Loaded project object.</p>

<h2 id="raises">Raises</h2>

<p>ValueError
    If the provided file does not have a <code>.pjm</code> extension.</p>
</div>


                            </div>
                            <div id="ImageTools.ajd_mask_size" class="classattr">
                                        <input id="ImageTools.ajd_mask_size-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ajd_mask_size</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">mask</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.ajd_mask_size-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.ajd_mask_size"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.ajd_mask_size-1357"><a href="#ImageTools.ajd_mask_size-1357"><span class="linenos">1357</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">ajd_mask_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
</span><span id="ImageTools.ajd_mask_size-1358"><a href="#ImageTools.ajd_mask_size-1358"><span class="linenos">1358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.ajd_mask_size-1359"><a href="#ImageTools.ajd_mask_size-1359"><span class="linenos">1359</span></a><span class="sd">        Adjusts the size of a mask to match the dimensions of a given image.</span>
</span><span id="ImageTools.ajd_mask_size-1360"><a href="#ImageTools.ajd_mask_size-1360"><span class="linenos">1360</span></a>
</span><span id="ImageTools.ajd_mask_size-1361"><a href="#ImageTools.ajd_mask_size-1361"><span class="linenos">1361</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.ajd_mask_size-1362"><a href="#ImageTools.ajd_mask_size-1362"><span class="linenos">1362</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.ajd_mask_size-1363"><a href="#ImageTools.ajd_mask_size-1363"><span class="linenos">1363</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools.ajd_mask_size-1364"><a href="#ImageTools.ajd_mask_size-1364"><span class="linenos">1364</span></a><span class="sd">            Reference image whose size the mask should match. Can be 2D or 3D.</span>
</span><span id="ImageTools.ajd_mask_size-1365"><a href="#ImageTools.ajd_mask_size-1365"><span class="linenos">1365</span></a>
</span><span id="ImageTools.ajd_mask_size-1366"><a href="#ImageTools.ajd_mask_size-1366"><span class="linenos">1366</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="ImageTools.ajd_mask_size-1367"><a href="#ImageTools.ajd_mask_size-1367"><span class="linenos">1367</span></a><span class="sd">            Mask image to be resized.</span>
</span><span id="ImageTools.ajd_mask_size-1368"><a href="#ImageTools.ajd_mask_size-1368"><span class="linenos">1368</span></a>
</span><span id="ImageTools.ajd_mask_size-1369"><a href="#ImageTools.ajd_mask_size-1369"><span class="linenos">1369</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.ajd_mask_size-1370"><a href="#ImageTools.ajd_mask_size-1370"><span class="linenos">1370</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.ajd_mask_size-1371"><a href="#ImageTools.ajd_mask_size-1371"><span class="linenos">1371</span></a><span class="sd">        np.ndarray</span>
</span><span id="ImageTools.ajd_mask_size-1372"><a href="#ImageTools.ajd_mask_size-1372"><span class="linenos">1372</span></a><span class="sd">            Resized mask matching the input image dimensions.</span>
</span><span id="ImageTools.ajd_mask_size-1373"><a href="#ImageTools.ajd_mask_size-1373"><span class="linenos">1373</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.ajd_mask_size-1374"><a href="#ImageTools.ajd_mask_size-1374"><span class="linenos">1374</span></a>
</span><span id="ImageTools.ajd_mask_size-1375"><a href="#ImageTools.ajd_mask_size-1375"><span class="linenos">1375</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ImageTools.ajd_mask_size-1376"><a href="#ImageTools.ajd_mask_size-1376"><span class="linenos">1376</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="ImageTools.ajd_mask_size-1377"><a href="#ImageTools.ajd_mask_size-1377"><span class="linenos">1377</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="ImageTools.ajd_mask_size-1378"><a href="#ImageTools.ajd_mask_size-1378"><span class="linenos">1378</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="ImageTools.ajd_mask_size-1379"><a href="#ImageTools.ajd_mask_size-1379"><span class="linenos">1379</span></a>
</span><span id="ImageTools.ajd_mask_size-1380"><a href="#ImageTools.ajd_mask_size-1380"><span class="linenos">1380</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Adjusts the size of a mask to match the dimensions of a given image.</p>

<h2 id="parameters">Parameters</h2>

<p>image : np.ndarray
    Reference image whose size the mask should match. Can be 2D or 3D.</p>

<p>mask : np.ndarray
    Mask image to be resized.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Resized mask matching the input image dimensions.</p>
</div>


                            </div>
                            <div id="ImageTools.load_image" class="classattr">
                                        <input id="ImageTools.load_image-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_image</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path_to_image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.load_image-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.load_image"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.load_image-1382"><a href="#ImageTools.load_image-1382"><span class="linenos">1382</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_image</span><span class="p">):</span>
</span><span id="ImageTools.load_image-1383"><a href="#ImageTools.load_image-1383"><span class="linenos">1383</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.load_image-1384"><a href="#ImageTools.load_image-1384"><span class="linenos">1384</span></a><span class="sd">        Load an image from the specified file path.</span>
</span><span id="ImageTools.load_image-1385"><a href="#ImageTools.load_image-1385"><span class="linenos">1385</span></a>
</span><span id="ImageTools.load_image-1386"><a href="#ImageTools.load_image-1386"><span class="linenos">1386</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.load_image-1387"><a href="#ImageTools.load_image-1387"><span class="linenos">1387</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.load_image-1388"><a href="#ImageTools.load_image-1388"><span class="linenos">1388</span></a><span class="sd">        path_to_image : str</span>
</span><span id="ImageTools.load_image-1389"><a href="#ImageTools.load_image-1389"><span class="linenos">1389</span></a><span class="sd">            Path to the image file.</span>
</span><span id="ImageTools.load_image-1390"><a href="#ImageTools.load_image-1390"><span class="linenos">1390</span></a>
</span><span id="ImageTools.load_image-1391"><a href="#ImageTools.load_image-1391"><span class="linenos">1391</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.load_image-1392"><a href="#ImageTools.load_image-1392"><span class="linenos">1392</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.load_image-1393"><a href="#ImageTools.load_image-1393"><span class="linenos">1393</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools.load_image-1394"><a href="#ImageTools.load_image-1394"><span class="linenos">1394</span></a><span class="sd">            Loaded image as a NumPy array.</span>
</span><span id="ImageTools.load_image-1395"><a href="#ImageTools.load_image-1395"><span class="linenos">1395</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.load_image-1396"><a href="#ImageTools.load_image-1396"><span class="linenos">1396</span></a>
</span><span id="ImageTools.load_image-1397"><a href="#ImageTools.load_image-1397"><span class="linenos">1397</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="n">path_to_image</span><span class="p">)</span>
</span><span id="ImageTools.load_image-1398"><a href="#ImageTools.load_image-1398"><span class="linenos">1398</span></a>        <span class="k">return</span> <span class="n">image</span>
</span></pre></div>


            <div class="docstring"><p>Load an image from the specified file path.</p>

<h2 id="parameters">Parameters</h2>

<p>path_to_image : str
    Path to the image file.</p>

<h2 id="returns">Returns</h2>

<p>image : np.ndarray
    Loaded image as a NumPy array.</p>
</div>


                            </div>
                            <div id="ImageTools.load_3D_tiff" class="classattr">
                                        <input id="ImageTools.load_3D_tiff-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_3D_tiff</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path_to_image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.load_3D_tiff-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.load_3D_tiff"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.load_3D_tiff-1400"><a href="#ImageTools.load_3D_tiff-1400"><span class="linenos">1400</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_3D_tiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_image</span><span class="p">):</span>
</span><span id="ImageTools.load_3D_tiff-1401"><a href="#ImageTools.load_3D_tiff-1401"><span class="linenos">1401</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.load_3D_tiff-1402"><a href="#ImageTools.load_3D_tiff-1402"><span class="linenos">1402</span></a><span class="sd">        Load a 3D image from a TIFF file.</span>
</span><span id="ImageTools.load_3D_tiff-1403"><a href="#ImageTools.load_3D_tiff-1403"><span class="linenos">1403</span></a>
</span><span id="ImageTools.load_3D_tiff-1404"><a href="#ImageTools.load_3D_tiff-1404"><span class="linenos">1404</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.load_3D_tiff-1405"><a href="#ImageTools.load_3D_tiff-1405"><span class="linenos">1405</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.load_3D_tiff-1406"><a href="#ImageTools.load_3D_tiff-1406"><span class="linenos">1406</span></a><span class="sd">        path_to_image : str</span>
</span><span id="ImageTools.load_3D_tiff-1407"><a href="#ImageTools.load_3D_tiff-1407"><span class="linenos">1407</span></a><span class="sd">            Path to the 3D TIFF image file.</span>
</span><span id="ImageTools.load_3D_tiff-1408"><a href="#ImageTools.load_3D_tiff-1408"><span class="linenos">1408</span></a>
</span><span id="ImageTools.load_3D_tiff-1409"><a href="#ImageTools.load_3D_tiff-1409"><span class="linenos">1409</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.load_3D_tiff-1410"><a href="#ImageTools.load_3D_tiff-1410"><span class="linenos">1410</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.load_3D_tiff-1411"><a href="#ImageTools.load_3D_tiff-1411"><span class="linenos">1411</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools.load_3D_tiff-1412"><a href="#ImageTools.load_3D_tiff-1412"><span class="linenos">1412</span></a><span class="sd">            Loaded 3D image as a NumPy array.</span>
</span><span id="ImageTools.load_3D_tiff-1413"><a href="#ImageTools.load_3D_tiff-1413"><span class="linenos">1413</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.load_3D_tiff-1414"><a href="#ImageTools.load_3D_tiff-1414"><span class="linenos">1414</span></a>
</span><span id="ImageTools.load_3D_tiff-1415"><a href="#ImageTools.load_3D_tiff-1415"><span class="linenos">1415</span></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">load_tiff</span><span class="p">(</span><span class="n">path_to_image</span><span class="p">)</span>
</span><span id="ImageTools.load_3D_tiff-1416"><a href="#ImageTools.load_3D_tiff-1416"><span class="linenos">1416</span></a>
</span><span id="ImageTools.load_3D_tiff-1417"><a href="#ImageTools.load_3D_tiff-1417"><span class="linenos">1417</span></a>        <span class="k">return</span> <span class="n">image</span>
</span></pre></div>


            <div class="docstring"><p>Load a 3D image from a TIFF file.</p>

<h2 id="parameters">Parameters</h2>

<p>path_to_image : str
    Path to the 3D TIFF image file.</p>

<h2 id="returns">Returns</h2>

<p>image : np.ndarray
    Loaded 3D image as a NumPy array.</p>
</div>


                            </div>
                            <div id="ImageTools.load_mask" class="classattr">
                                        <input id="ImageTools.load_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">path_to_mask</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.load_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.load_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.load_mask-1419"><a href="#ImageTools.load_mask-1419"><span class="linenos">1419</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_to_mask</span><span class="p">):</span>
</span><span id="ImageTools.load_mask-1420"><a href="#ImageTools.load_mask-1420"><span class="linenos">1420</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.load_mask-1421"><a href="#ImageTools.load_mask-1421"><span class="linenos">1421</span></a><span class="sd">        Load a mask image.</span>
</span><span id="ImageTools.load_mask-1422"><a href="#ImageTools.load_mask-1422"><span class="linenos">1422</span></a>
</span><span id="ImageTools.load_mask-1423"><a href="#ImageTools.load_mask-1423"><span class="linenos">1423</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.load_mask-1424"><a href="#ImageTools.load_mask-1424"><span class="linenos">1424</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.load_mask-1425"><a href="#ImageTools.load_mask-1425"><span class="linenos">1425</span></a><span class="sd">        path_to_mask : str</span>
</span><span id="ImageTools.load_mask-1426"><a href="#ImageTools.load_mask-1426"><span class="linenos">1426</span></a><span class="sd">            Path to the mask image file.</span>
</span><span id="ImageTools.load_mask-1427"><a href="#ImageTools.load_mask-1427"><span class="linenos">1427</span></a>
</span><span id="ImageTools.load_mask-1428"><a href="#ImageTools.load_mask-1428"><span class="linenos">1428</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.load_mask-1429"><a href="#ImageTools.load_mask-1429"><span class="linenos">1429</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.load_mask-1430"><a href="#ImageTools.load_mask-1430"><span class="linenos">1430</span></a><span class="sd">        mask : np.ndarray</span>
</span><span id="ImageTools.load_mask-1431"><a href="#ImageTools.load_mask-1431"><span class="linenos">1431</span></a><span class="sd">            Loaded mask image as a NumPy array.</span>
</span><span id="ImageTools.load_mask-1432"><a href="#ImageTools.load_mask-1432"><span class="linenos">1432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.load_mask-1433"><a href="#ImageTools.load_mask-1433"><span class="linenos">1433</span></a>
</span><span id="ImageTools.load_mask-1434"><a href="#ImageTools.load_mask-1434"><span class="linenos">1434</span></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">path_to_mask</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
</span><span id="ImageTools.load_mask-1435"><a href="#ImageTools.load_mask-1435"><span class="linenos">1435</span></a>        <span class="k">return</span> <span class="n">mask</span>
</span></pre></div>


            <div class="docstring"><p>Load a mask image.</p>

<h2 id="parameters">Parameters</h2>

<p>path_to_mask : str
    Path to the mask image file.</p>

<h2 id="returns">Returns</h2>

<p>mask : np.ndarray
    Loaded mask image as a NumPy array.</p>
</div>


                            </div>
                            <div id="ImageTools.save" class="classattr">
                                        <input id="ImageTools.save-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span>, </span><span class="param"><span class="n">file_name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.save-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.save"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.save-1437"><a href="#ImageTools.save-1437"><span class="linenos">1437</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
</span><span id="ImageTools.save-1438"><a href="#ImageTools.save-1438"><span class="linenos">1438</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.save-1439"><a href="#ImageTools.save-1439"><span class="linenos">1439</span></a><span class="sd">        Save an image to disk.</span>
</span><span id="ImageTools.save-1440"><a href="#ImageTools.save-1440"><span class="linenos">1440</span></a>
</span><span id="ImageTools.save-1441"><a href="#ImageTools.save-1441"><span class="linenos">1441</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.save-1442"><a href="#ImageTools.save-1442"><span class="linenos">1442</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.save-1443"><a href="#ImageTools.save-1443"><span class="linenos">1443</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools.save-1444"><a href="#ImageTools.save-1444"><span class="linenos">1444</span></a><span class="sd">            Image data to be saved.</span>
</span><span id="ImageTools.save-1445"><a href="#ImageTools.save-1445"><span class="linenos">1445</span></a>
</span><span id="ImageTools.save-1446"><a href="#ImageTools.save-1446"><span class="linenos">1446</span></a><span class="sd">        file_name : str</span>
</span><span id="ImageTools.save-1447"><a href="#ImageTools.save-1447"><span class="linenos">1447</span></a><span class="sd">            Output file path including the desired image extension (e.g., &quot;.png&quot;, &quot;.jpg&quot;).</span>
</span><span id="ImageTools.save-1448"><a href="#ImageTools.save-1448"><span class="linenos">1448</span></a>
</span><span id="ImageTools.save-1449"><a href="#ImageTools.save-1449"><span class="linenos">1449</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.save-1450"><a href="#ImageTools.save-1450"><span class="linenos">1450</span></a>
</span><span id="ImageTools.save-1451"><a href="#ImageTools.save-1451"><span class="linenos">1451</span></a>        <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save an image to disk.</p>

<h2 id="parameters">Parameters</h2>

<p>image : np.ndarray
    Image data to be saved.</p>

<p>file_name : str
    Output file path including the desired image extension (e.g., ".png", ".jpg").</p>
</div>


                            </div>
                            <div id="ImageTools.drop_dict" class="classattr">
                                        <input id="ImageTools.drop_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">drop_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dictionary</span>, </span><span class="param"><span class="n">key</span>, </span><span class="param"><span class="n">var</span>, </span><span class="param"><span class="n">action</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.drop_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.drop_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.drop_dict-1455"><a href="#ImageTools.drop_dict-1455"><span class="linenos">1455</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">drop_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ImageTools.drop_dict-1456"><a href="#ImageTools.drop_dict-1456"><span class="linenos">1456</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.drop_dict-1457"><a href="#ImageTools.drop_dict-1457"><span class="linenos">1457</span></a><span class="sd">        Filters elements from a dictionary based on a condition applied to a specified key.</span>
</span><span id="ImageTools.drop_dict-1458"><a href="#ImageTools.drop_dict-1458"><span class="linenos">1458</span></a>
</span><span id="ImageTools.drop_dict-1459"><a href="#ImageTools.drop_dict-1459"><span class="linenos">1459</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.drop_dict-1460"><a href="#ImageTools.drop_dict-1460"><span class="linenos">1460</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.drop_dict-1461"><a href="#ImageTools.drop_dict-1461"><span class="linenos">1461</span></a><span class="sd">        dictionary : dict</span>
</span><span id="ImageTools.drop_dict-1462"><a href="#ImageTools.drop_dict-1462"><span class="linenos">1462</span></a><span class="sd">            Dictionary containing lists or arrays under each key.</span>
</span><span id="ImageTools.drop_dict-1463"><a href="#ImageTools.drop_dict-1463"><span class="linenos">1463</span></a>
</span><span id="ImageTools.drop_dict-1464"><a href="#ImageTools.drop_dict-1464"><span class="linenos">1464</span></a><span class="sd">        key : str</span>
</span><span id="ImageTools.drop_dict-1465"><a href="#ImageTools.drop_dict-1465"><span class="linenos">1465</span></a><span class="sd">            The key in the dictionary on which the filtering condition will be applied.</span>
</span><span id="ImageTools.drop_dict-1466"><a href="#ImageTools.drop_dict-1466"><span class="linenos">1466</span></a>
</span><span id="ImageTools.drop_dict-1467"><a href="#ImageTools.drop_dict-1467"><span class="linenos">1467</span></a><span class="sd">        var : numeric</span>
</span><span id="ImageTools.drop_dict-1468"><a href="#ImageTools.drop_dict-1468"><span class="linenos">1468</span></a><span class="sd">            Value to compare against each element in dictionary[key].</span>
</span><span id="ImageTools.drop_dict-1469"><a href="#ImageTools.drop_dict-1469"><span class="linenos">1469</span></a>
</span><span id="ImageTools.drop_dict-1470"><a href="#ImageTools.drop_dict-1470"><span class="linenos">1470</span></a><span class="sd">        action : str, optional</span>
</span><span id="ImageTools.drop_dict-1471"><a href="#ImageTools.drop_dict-1471"><span class="linenos">1471</span></a><span class="sd">            Comparison operator as string: &#39;&lt;=&#39;, &#39;&gt;=&#39;, &#39;==&#39;, &#39;&lt;&#39;, &#39;&gt;&#39;.</span>
</span><span id="ImageTools.drop_dict-1472"><a href="#ImageTools.drop_dict-1472"><span class="linenos">1472</span></a><span class="sd">            Default is None, which raises an error.</span>
</span><span id="ImageTools.drop_dict-1473"><a href="#ImageTools.drop_dict-1473"><span class="linenos">1473</span></a>
</span><span id="ImageTools.drop_dict-1474"><a href="#ImageTools.drop_dict-1474"><span class="linenos">1474</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.drop_dict-1475"><a href="#ImageTools.drop_dict-1475"><span class="linenos">1475</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.drop_dict-1476"><a href="#ImageTools.drop_dict-1476"><span class="linenos">1476</span></a><span class="sd">        dict</span>
</span><span id="ImageTools.drop_dict-1477"><a href="#ImageTools.drop_dict-1477"><span class="linenos">1477</span></a><span class="sd">            A new dictionary with elements removed where the condition matches.</span>
</span><span id="ImageTools.drop_dict-1478"><a href="#ImageTools.drop_dict-1478"><span class="linenos">1478</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.drop_dict-1479"><a href="#ImageTools.drop_dict-1479"><span class="linenos">1479</span></a>
</span><span id="ImageTools.drop_dict-1480"><a href="#ImageTools.drop_dict-1480"><span class="linenos">1480</span></a>        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1481"><a href="#ImageTools.drop_dict-1481"><span class="linenos">1481</span></a>        <span class="n">indices_to_drop</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools.drop_dict-1482"><a href="#ImageTools.drop_dict-1482"><span class="linenos">1482</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
</span><span id="ImageTools.drop_dict-1483"><a href="#ImageTools.drop_dict-1483"><span class="linenos">1483</span></a>
</span><span id="ImageTools.drop_dict-1484"><a href="#ImageTools.drop_dict-1484"><span class="linenos">1484</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
</span><span id="ImageTools.drop_dict-1485"><a href="#ImageTools.drop_dict-1485"><span class="linenos">1485</span></a>                <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dr</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1486"><a href="#ImageTools.drop_dict-1486"><span class="linenos">1486</span></a>
</span><span id="ImageTools.drop_dict-1487"><a href="#ImageTools.drop_dict-1487"><span class="linenos">1487</span></a>            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1488"><a href="#ImageTools.drop_dict-1488"><span class="linenos">1488</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;=</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1489"><a href="#ImageTools.drop_dict-1489"><span class="linenos">1489</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1490"><a href="#ImageTools.drop_dict-1490"><span class="linenos">1490</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1491"><a href="#ImageTools.drop_dict-1491"><span class="linenos">1491</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;=</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1492"><a href="#ImageTools.drop_dict-1492"><span class="linenos">1492</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1493"><a href="#ImageTools.drop_dict-1493"><span class="linenos">1493</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1494"><a href="#ImageTools.drop_dict-1494"><span class="linenos">1494</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1495"><a href="#ImageTools.drop_dict-1495"><span class="linenos">1495</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1496"><a href="#ImageTools.drop_dict-1496"><span class="linenos">1496</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1497"><a href="#ImageTools.drop_dict-1497"><span class="linenos">1497</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1498"><a href="#ImageTools.drop_dict-1498"><span class="linenos">1498</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1499"><a href="#ImageTools.drop_dict-1499"><span class="linenos">1499</span></a>            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1500"><a href="#ImageTools.drop_dict-1500"><span class="linenos">1500</span></a>                <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;</span> <span class="n">dr</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1501"><a href="#ImageTools.drop_dict-1501"><span class="linenos">1501</span></a>                    <span class="n">indices_to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1502"><a href="#ImageTools.drop_dict-1502"><span class="linenos">1502</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="ImageTools.drop_dict-1503"><a href="#ImageTools.drop_dict-1503"><span class="linenos">1503</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Wrong action!&quot;</span><span class="p">)</span>
</span><span id="ImageTools.drop_dict-1504"><a href="#ImageTools.drop_dict-1504"><span class="linenos">1504</span></a>                <span class="k">return</span> <span class="kc">None</span>
</span><span id="ImageTools.drop_dict-1505"><a href="#ImageTools.drop_dict-1505"><span class="linenos">1505</span></a>
</span><span id="ImageTools.drop_dict-1506"><a href="#ImageTools.drop_dict-1506"><span class="linenos">1506</span></a>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="ImageTools.drop_dict-1507"><a href="#ImageTools.drop_dict-1507"><span class="linenos">1507</span></a>            <span class="n">dictionary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ImageTools.drop_dict-1508"><a href="#ImageTools.drop_dict-1508"><span class="linenos">1508</span></a>                <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices_to_drop</span>
</span><span id="ImageTools.drop_dict-1509"><a href="#ImageTools.drop_dict-1509"><span class="linenos">1509</span></a>            <span class="p">]</span>
</span><span id="ImageTools.drop_dict-1510"><a href="#ImageTools.drop_dict-1510"><span class="linenos">1510</span></a>
</span><span id="ImageTools.drop_dict-1511"><a href="#ImageTools.drop_dict-1511"><span class="linenos">1511</span></a>        <span class="k">return</span> <span class="n">dictionary</span>
</span></pre></div>


            <div class="docstring"><p>Filters elements from a dictionary based on a condition applied to a specified key.</p>

<h2 id="parameters">Parameters</h2>

<p>dictionary : dict
    Dictionary containing lists or arrays under each key.</p>

<p>key : str
    The key in the dictionary on which the filtering condition will be applied.</p>

<p>var : numeric
    Value to compare against each element in dictionary[key].</p>

<p>action : str, optional
    Comparison operator as string: '&lt;=', '>=', '==', '&lt;', '>'.
    Default is None, which raises an error.</p>

<h2 id="returns">Returns</h2>

<p>dict
    A new dictionary with elements removed where the condition matches.</p>
</div>


                            </div>
                            <div id="ImageTools.create_mask" class="classattr">
                                        <input id="ImageTools.create_mask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_mask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dictionary</span>, </span><span class="param"><span class="n">image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.create_mask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.create_mask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.create_mask-1515"><a href="#ImageTools.create_mask-1515"><span class="linenos">1515</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
</span><span id="ImageTools.create_mask-1516"><a href="#ImageTools.create_mask-1516"><span class="linenos">1516</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.create_mask-1517"><a href="#ImageTools.create_mask-1517"><span class="linenos">1517</span></a><span class="sd">        Creates a mask image with gradated intensity values for each coordinate set in a dictionary.</span>
</span><span id="ImageTools.create_mask-1518"><a href="#ImageTools.create_mask-1518"><span class="linenos">1518</span></a>
</span><span id="ImageTools.create_mask-1519"><a href="#ImageTools.create_mask-1519"><span class="linenos">1519</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.create_mask-1520"><a href="#ImageTools.create_mask-1520"><span class="linenos">1520</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.create_mask-1521"><a href="#ImageTools.create_mask-1521"><span class="linenos">1521</span></a><span class="sd">        dictionary : dict</span>
</span><span id="ImageTools.create_mask-1522"><a href="#ImageTools.create_mask-1522"><span class="linenos">1522</span></a><span class="sd">            Dictionary containing a &#39;coords&#39; key with a list of arrays of coordinates.</span>
</span><span id="ImageTools.create_mask-1523"><a href="#ImageTools.create_mask-1523"><span class="linenos">1523</span></a>
</span><span id="ImageTools.create_mask-1524"><a href="#ImageTools.create_mask-1524"><span class="linenos">1524</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools.create_mask-1525"><a href="#ImageTools.create_mask-1525"><span class="linenos">1525</span></a><span class="sd">            Base image to define the shape of the mask.</span>
</span><span id="ImageTools.create_mask-1526"><a href="#ImageTools.create_mask-1526"><span class="linenos">1526</span></a>
</span><span id="ImageTools.create_mask-1527"><a href="#ImageTools.create_mask-1527"><span class="linenos">1527</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.create_mask-1528"><a href="#ImageTools.create_mask-1528"><span class="linenos">1528</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.create_mask-1529"><a href="#ImageTools.create_mask-1529"><span class="linenos">1529</span></a><span class="sd">        np.ndarray</span>
</span><span id="ImageTools.create_mask-1530"><a href="#ImageTools.create_mask-1530"><span class="linenos">1530</span></a><span class="sd">            Mask image with uint16 gradated intensity.</span>
</span><span id="ImageTools.create_mask-1531"><a href="#ImageTools.create_mask-1531"><span class="linenos">1531</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.create_mask-1532"><a href="#ImageTools.create_mask-1532"><span class="linenos">1532</span></a>
</span><span id="ImageTools.create_mask-1533"><a href="#ImageTools.create_mask-1533"><span class="linenos">1533</span></a>        <span class="n">image_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="ImageTools.create_mask-1534"><a href="#ImageTools.create_mask-1534"><span class="linenos">1534</span></a>
</span><span id="ImageTools.create_mask-1535"><a href="#ImageTools.create_mask-1535"><span class="linenos">1535</span></a>        <span class="n">arrays_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span>
</span><span id="ImageTools.create_mask-1536"><a href="#ImageTools.create_mask-1536"><span class="linenos">1536</span></a>
</span><span id="ImageTools.create_mask-1537"><a href="#ImageTools.create_mask-1537"><span class="linenos">1537</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ImageTools.create_mask-1538"><a href="#ImageTools.create_mask-1538"><span class="linenos">1538</span></a>
</span><span id="ImageTools.create_mask-1539"><a href="#ImageTools.create_mask-1539"><span class="linenos">1539</span></a>            <span class="n">initial_val</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="ImageTools.create_mask-1540"><a href="#ImageTools.create_mask-1540"><span class="linenos">1540</span></a>            <span class="n">intensity_list</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="ImageTools.create_mask-1541"><a href="#ImageTools.create_mask-1541"><span class="linenos">1541</span></a>                <span class="n">arrays_list</span>
</span><span id="ImageTools.create_mask-1542"><a href="#ImageTools.create_mask-1542"><span class="linenos">1542</span></a>            <span class="p">)</span>
</span><span id="ImageTools.create_mask-1543"><a href="#ImageTools.create_mask-1543"><span class="linenos">1543</span></a>
</span><span id="ImageTools.create_mask-1544"><a href="#ImageTools.create_mask-1544"><span class="linenos">1544</span></a>            <span class="n">gradation</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="ImageTools.create_mask-1545"><a href="#ImageTools.create_mask-1545"><span class="linenos">1545</span></a>            <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arrays_list</span><span class="p">:</span>
</span><span id="ImageTools.create_mask-1546"><a href="#ImageTools.create_mask-1546"><span class="linenos">1546</span></a>                <span class="n">image_mask</span><span class="p">[</span><span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">initial_val</span> <span class="o">+</span> <span class="p">(</span>
</span><span id="ImageTools.create_mask-1547"><a href="#ImageTools.create_mask-1547"><span class="linenos">1547</span></a>                    <span class="n">gradation</span> <span class="o">*</span> <span class="n">intensity_list</span>
</span><span id="ImageTools.create_mask-1548"><a href="#ImageTools.create_mask-1548"><span class="linenos">1548</span></a>                <span class="p">)</span>
</span><span id="ImageTools.create_mask-1549"><a href="#ImageTools.create_mask-1549"><span class="linenos">1549</span></a>                <span class="n">gradation</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="ImageTools.create_mask-1550"><a href="#ImageTools.create_mask-1550"><span class="linenos">1550</span></a>
</span><span id="ImageTools.create_mask-1551"><a href="#ImageTools.create_mask-1551"><span class="linenos">1551</span></a>        <span class="k">return</span> <span class="n">image_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint16&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates a mask image with gradated intensity values for each coordinate set in a dictionary.</p>

<h2 id="parameters">Parameters</h2>

<p>dictionary : dict
    Dictionary containing a 'coords' key with a list of arrays of coordinates.</p>

<p>image : np.ndarray
    Base image to define the shape of the mask.</p>

<h2 id="returns">Returns</h2>

<p>np.ndarray
    Mask image with uint16 gradated intensity.</p>
</div>


                            </div>
                            <div id="ImageTools.min_max_histograme" class="classattr">
                                        <input id="ImageTools.min_max_histograme-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">min_max_histograme</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">image</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ImageTools.min_max_histograme-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImageTools.min_max_histograme"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImageTools.min_max_histograme-1553"><a href="#ImageTools.min_max_histograme-1553"><span class="linenos">1553</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">min_max_histograme</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
</span><span id="ImageTools.min_max_histograme-1554"><a href="#ImageTools.min_max_histograme-1554"><span class="linenos">1554</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ImageTools.min_max_histograme-1555"><a href="#ImageTools.min_max_histograme-1555"><span class="linenos">1555</span></a><span class="sd">        Calculates histogram-based minimum and maximum intensity percentiles in an image.</span>
</span><span id="ImageTools.min_max_histograme-1556"><a href="#ImageTools.min_max_histograme-1556"><span class="linenos">1556</span></a>
</span><span id="ImageTools.min_max_histograme-1557"><a href="#ImageTools.min_max_histograme-1557"><span class="linenos">1557</span></a><span class="sd">        Parameters</span>
</span><span id="ImageTools.min_max_histograme-1558"><a href="#ImageTools.min_max_histograme-1558"><span class="linenos">1558</span></a><span class="sd">        ----------</span>
</span><span id="ImageTools.min_max_histograme-1559"><a href="#ImageTools.min_max_histograme-1559"><span class="linenos">1559</span></a><span class="sd">        image : np.ndarray</span>
</span><span id="ImageTools.min_max_histograme-1560"><a href="#ImageTools.min_max_histograme-1560"><span class="linenos">1560</span></a><span class="sd">            Input image for histogram analysis.</span>
</span><span id="ImageTools.min_max_histograme-1561"><a href="#ImageTools.min_max_histograme-1561"><span class="linenos">1561</span></a>
</span><span id="ImageTools.min_max_histograme-1562"><a href="#ImageTools.min_max_histograme-1562"><span class="linenos">1562</span></a><span class="sd">        Returns</span>
</span><span id="ImageTools.min_max_histograme-1563"><a href="#ImageTools.min_max_histograme-1563"><span class="linenos">1563</span></a><span class="sd">        -------</span>
</span><span id="ImageTools.min_max_histograme-1564"><a href="#ImageTools.min_max_histograme-1564"><span class="linenos">1564</span></a><span class="sd">        min_val : float</span>
</span><span id="ImageTools.min_max_histograme-1565"><a href="#ImageTools.min_max_histograme-1565"><span class="linenos">1565</span></a><span class="sd">            Minimum intensity percentile above zero.</span>
</span><span id="ImageTools.min_max_histograme-1566"><a href="#ImageTools.min_max_histograme-1566"><span class="linenos">1566</span></a>
</span><span id="ImageTools.min_max_histograme-1567"><a href="#ImageTools.min_max_histograme-1567"><span class="linenos">1567</span></a><span class="sd">        max_val : float</span>
</span><span id="ImageTools.min_max_histograme-1568"><a href="#ImageTools.min_max_histograme-1568"><span class="linenos">1568</span></a><span class="sd">            Maximum intensity percentile based on histogram gradient.</span>
</span><span id="ImageTools.min_max_histograme-1569"><a href="#ImageTools.min_max_histograme-1569"><span class="linenos">1569</span></a>
</span><span id="ImageTools.min_max_histograme-1570"><a href="#ImageTools.min_max_histograme-1570"><span class="linenos">1570</span></a><span class="sd">        df : pd.DataFrame</span>
</span><span id="ImageTools.min_max_histograme-1571"><a href="#ImageTools.min_max_histograme-1571"><span class="linenos">1571</span></a><span class="sd">            DataFrame containing quantiles, corresponding intensity values, and cumulative percents.</span>
</span><span id="ImageTools.min_max_histograme-1572"><a href="#ImageTools.min_max_histograme-1572"><span class="linenos">1572</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ImageTools.min_max_histograme-1573"><a href="#ImageTools.min_max_histograme-1573"><span class="linenos">1573</span></a>
</span><span id="ImageTools.min_max_histograme-1574"><a href="#ImageTools.min_max_histograme-1574"><span class="linenos">1574</span></a>        <span class="n">q</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools.min_max_histograme-1575"><a href="#ImageTools.min_max_histograme-1575"><span class="linenos">1575</span></a>        <span class="n">val</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools.min_max_histograme-1576"><a href="#ImageTools.min_max_histograme-1576"><span class="linenos">1576</span></a>        <span class="n">perc</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ImageTools.min_max_histograme-1577"><a href="#ImageTools.min_max_histograme-1577"><span class="linenos">1577</span></a>
</span><span id="ImageTools.min_max_histograme-1578"><a href="#ImageTools.min_max_histograme-1578"><span class="linenos">1578</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="ImageTools.min_max_histograme-1579"><a href="#ImageTools.min_max_histograme-1579"><span class="linenos">1579</span></a>
</span><span id="ImageTools.min_max_histograme-1580"><a href="#ImageTools.min_max_histograme-1580"><span class="linenos">1580</span></a>        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span><span id="ImageTools.min_max_histograme-1581"><a href="#ImageTools.min_max_histograme-1581"><span class="linenos">1581</span></a>            <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="ImageTools.min_max_histograme-1582"><a href="#ImageTools.min_max_histograme-1582"><span class="linenos">1582</span></a>            <span class="n">val</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="ImageTools.min_max_histograme-1583"><a href="#ImageTools.min_max_histograme-1583"><span class="linenos">1583</span></a>            <span class="n">sum_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">image</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
</span><span id="ImageTools.min_max_histograme-1584"><a href="#ImageTools.min_max_histograme-1584"><span class="linenos">1584</span></a>            <span class="n">pr</span> <span class="o">=</span> <span class="n">sum_val</span> <span class="o">/</span> <span class="n">max_val</span>
</span><span id="ImageTools.min_max_histograme-1585"><a href="#ImageTools.min_max_histograme-1585"><span class="linenos">1585</span></a>            <span class="n">perc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
</span><span id="ImageTools.min_max_histograme-1586"><a href="#ImageTools.min_max_histograme-1586"><span class="linenos">1586</span></a>
</span><span id="ImageTools.min_max_histograme-1587"><a href="#ImageTools.min_max_histograme-1587"><span class="linenos">1587</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;q&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span> <span class="s2">&quot;perc&quot;</span><span class="p">:</span> <span class="n">perc</span><span class="p">})</span>
</span><span id="ImageTools.min_max_histograme-1588"><a href="#ImageTools.min_max_histograme-1588"><span class="linenos">1588</span></a>
</span><span id="ImageTools.min_max_histograme-1589"><a href="#ImageTools.min_max_histograme-1589"><span class="linenos">1589</span></a>        <span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ImageTools.min_max_histograme-1590"><a href="#ImageTools.min_max_histograme-1590"><span class="linenos">1590</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span><span id="ImageTools.min_max_histograme-1591"><a href="#ImageTools.min_max_histograme-1591"><span class="linenos">1591</span></a>            <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">min_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ImageTools.min_max_histograme-1592"><a href="#ImageTools.min_max_histograme-1592"><span class="linenos">1592</span></a>                <span class="n">min_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="ImageTools.min_max_histograme-1593"><a href="#ImageTools.min_max_histograme-1593"><span class="linenos">1593</span></a>
</span><span id="ImageTools.min_max_histograme-1594"><a href="#ImageTools.min_max_histograme-1594"><span class="linenos">1594</span></a>        <span class="n">max_val</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="ImageTools.min_max_histograme-1595"><a href="#ImageTools.min_max_histograme-1595"><span class="linenos">1595</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="ImageTools.min_max_histograme-1596"><a href="#ImageTools.min_max_histograme-1596"><span class="linenos">1596</span></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="ImageTools.min_max_histograme-1597"><a href="#ImageTools.min_max_histograme-1597"><span class="linenos">1597</span></a>
</span><span id="ImageTools.min_max_histograme-1598"><a href="#ImageTools.min_max_histograme-1598"><span class="linenos">1598</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
</span><span id="ImageTools.min_max_histograme-1599"><a href="#ImageTools.min_max_histograme-1599"><span class="linenos">1599</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="ImageTools.min_max_histograme-1600"><a href="#ImageTools.min_max_histograme-1600"><span class="linenos">1600</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="ImageTools.min_max_histograme-1601"><a href="#ImageTools.min_max_histograme-1601"><span class="linenos">1601</span></a>                <span class="k">break</span>
</span><span id="ImageTools.min_max_histograme-1602"><a href="#ImageTools.min_max_histograme-1602"><span class="linenos">1602</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ImageTools.min_max_histograme-1603"><a href="#ImageTools.min_max_histograme-1603"><span class="linenos">1603</span></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;perc&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="ImageTools.min_max_histograme-1604"><a href="#ImageTools.min_max_histograme-1604"><span class="linenos">1604</span></a>
</span><span id="ImageTools.min_max_histograme-1605"><a href="#ImageTools.min_max_histograme-1605"><span class="linenos">1605</span></a>        <span class="k">return</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">df</span>
</span></pre></div>


            <div class="docstring"><p>Calculates histogram-based minimum and maximum intensity percentiles in an image.</p>

<h2 id="parameters">Parameters</h2>

<p>image : np.ndarray
    Input image for histogram analysis.</p>

<h2 id="returns">Returns</h2>

<p>min_val : float
    Minimum intensity percentile above zero.</p>

<p>max_val : float
    Maximum intensity percentile based on histogram gradient.</p>

<p>df : pd.DataFrame
    DataFrame containing quantiles, corresponding intensity values, and cumulative percents.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>